<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<!-- PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="× ×”×’ ×‘×¡×“×¨">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0f1117">
<meta name="format-detection" content="telephone=no">
<meta name="application-name" content="× ×”×’ ×‘×¡×“×¨">
<meta name="description" content="××¤×œ×™×§×¦×™×” ×œ× ×™×”×•×œ ×ª×œ××™×“×™×, ×©×™×¢×•×¨×™× ×•×ª×©×œ×•××™× ×œ××•×¨×™ × ×”×™×’×”">

<!-- Manifest -->
<link rel="manifest" href="./manifest.json">

<!-- iOS Icons -->
<link rel="apple-touch-icon" href="./icons/icon-180x180.png">
<link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png">
<link rel="apple-touch-icon" sizes="167x167" href="./icons/icon-167x167.png">
<link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180x180.png">

<!-- Android/Chrome Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="96x96" href="./icons/icon-96x96.png">

<title>× ×”×’ ×‘×¡×“×¨ â€” × ×™×”×•×œ ×©×™×¢×•×¨×™ × ×”×™×’×”</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface-hover: #222633;
    --card: #1e2230;
    --border: #2a2e3d;
    --accent: #22c55e;
    --accent-dim: #16a34a;
    --accent-glow: rgba(34, 197, 94, 0.15);
    --whatsapp: #25D366;
    --whatsapp-dark: #128C7E;
    --text: #e8eaed;
    --text-dim: #8b8fa3;
    --text-muted: #555a6e;
    --danger: #ef4444;
    --danger-dim: rgba(239, 68, 68, 0.12);
    --warning: #f59e0b;
    --warning-dim: rgba(245, 158, 11, 0.12);
    --blue: #3b82f6;
    --blue-dim: rgba(59, 130, 246, 0.12);
    --radius: 14px;
    --radius-sm: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== HEADER ===== */
  .header {
    background: linear-gradient(135deg, var(--surface) 0%, #151825 100%);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(20px);
  }
  .header-inner { max-width: 600px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--accent), var(--accent-dim)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
  .logo-text { font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 20px; letter-spacing: -0.5px; }
  .logo-text span { color: var(--accent); }
  .header-date { font-size: 13px; color: var(--text-dim); }

  /* ===== NAV ===== */
  .nav-tabs { display: flex; gap: 3px; padding: 10px 16px; max-width: 600px; margin: 0 auto; background: var(--bg); position: sticky; top: 70px; z-index: 99; }
  .nav-tab { flex: 1; padding: 9px 4px; border: none; background: var(--surface); color: var(--text-dim); font-family: 'Heebo', sans-serif; font-size: 12.5px; font-weight: 500; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.25s; display: flex; align-items: center; justify-content: center; gap: 4px; }
  .nav-tab:hover { background: var(--surface-hover); color: var(--text); }
  .nav-tab.active { background: var(--accent); color: #000; font-weight: 600; }
  .nav-tab .tab-icon { font-size: 14px; }

  /* ===== MAIN ===== */
  .main { max-width: 600px; margin: 0 auto; padding: 16px 16px 100px; }
  .page { display: none; }
  .page.active { display: block; }
  .section-title { font-size: 14px; font-weight: 600; color: var(--text-dim); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* ===== STATS ===== */
  .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
  .stats-bar.four { grid-template-columns: repeat(4, 1fr); }
  .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 8px; text-align: center; }
  .stat-number { font-family: 'Rubik', sans-serif; font-size: 24px; font-weight: 700; color: var(--accent); line-height: 1; }
  .stat-number.red { color: var(--danger); }
  .stat-number.blue { color: var(--blue); }
  .stat-number.yellow { color: var(--warning); }
  .stat-label { font-size: 11px; color: var(--text-dim); margin-top: 3px; }

  /* ===== FORMS ===== */
  .form-group { margin-bottom: 12px; }
  .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-dim); margin-bottom: 5px; }
  .form-input, .form-select, .form-textarea {
    width: 100%; padding: 11px 12px; background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text); font-family: 'Heebo', sans-serif; font-size: 15px;
    transition: border-color 0.2s; direction: rtl;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
  .form-input::placeholder { color: var(--text-muted); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .form-row.three { grid-template-columns: 1fr 1fr 1fr; }
  .form-textarea { min-height: 50px; resize: vertical; }

  /* ===== BUTTONS ===== */
  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 11px 18px; border: none; border-radius: var(--radius-sm); font-family: 'Heebo', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%; }
  .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dim)); color: #000; }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(34,197,94,0.3); }
  .btn-whatsapp { background: linear-gradient(135deg, var(--whatsapp), var(--whatsapp-dark)); color: #fff; font-size: 16px; padding: 13px 18px; }
  .btn-whatsapp:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(37,211,102,0.35); }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger-outline { background: transparent; border: 1px solid var(--danger); color: var(--danger); font-size: 13px; padding: 8px 14px; width: auto; }
  .btn-sm { padding: 8px 14px; font-size: 13px; width: auto; }

  /* ===== STUDENT / LESSON ITEMS ===== */
  .student-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
  .student-item:hover { border-color: var(--accent); background: var(--surface-hover); }
  .student-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-dim)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 15px; color: #000; flex-shrink: 0; }
  .student-info { flex: 1; min-width: 0; }
  .student-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
  .student-meta { font-size: 11px; color: var(--text-dim); display: flex; gap: 10px; flex-wrap: wrap; }
  .student-actions { display: flex; gap: 5px; }
  .icon-btn { width: 34px; height: 34px; border: 1px solid var(--border); background: var(--surface); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 15px; color: var(--text-dim); }
  .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
  .icon-btn.wa:hover { border-color: var(--whatsapp); color: var(--whatsapp); }

  .lesson-item { display: flex; gap: 12px; padding: 12px 14px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; align-items: center; }
  .lesson-time { background: var(--surface); border-radius: 8px; padding: 7px 10px; text-align: center; min-width: 58px; flex-shrink: 0; }
  .lesson-hour { font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 16px; color: var(--accent); line-height: 1.1; }
  .lesson-date-small { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
  .lesson-details { flex: 1; }
  .lesson-student-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
  .lesson-info { font-size: 11px; color: var(--text-dim); }
  .lesson-actions { display: flex; gap: 5px; flex-shrink: 0; }

  /* ===== EMPTY ===== */
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); }
  .empty-icon { font-size: 44px; margin-bottom: 10px; opacity: 0.5; }
  .empty-text { font-size: 14px; margin-bottom: 4px; }
  .empty-sub { font-size: 12px; color: var(--text-muted); }

  /* ===== MODAL ===== */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.show { display: flex; }
  .modal { background: var(--surface); border-radius: var(--radius) var(--radius) 0 0; padding: 20px 18px 28px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch; animation: slideUp 0.3s ease; }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 14px; }
  .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

  /* ===== TOAST ===== */
  .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(200px); background: var(--accent); color: #000; padding: 12px 24px; border-radius: var(--radius-sm); font-weight: 600; font-size: 14px; z-index: 300; transition: transform 0.3s ease; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* ===== BADGE ===== */
  .badge { display: inline-block; padding: 2px 7px; border-radius: 6px; font-size: 10px; font-weight: 600; }
  .badge-green { background: rgba(34,197,94,0.15); color: var(--accent); }
  .badge-yellow { background: var(--warning-dim); color: var(--warning); }
  .badge-red { background: var(--danger-dim); color: var(--danger); }
  .badge-blue { background: var(--blue-dim); color: var(--blue); }

  /* ===== DAY HEADER ===== */
  .day-header { font-size: 13px; font-weight: 600; color: var(--text-dim); padding: 8px 0 4px; display: flex; align-items: center; gap: 8px; }
  .day-header .day-dot { width: 7px; height: 7px; background: var(--accent); border-radius: 50%; }

  /* ===== SEARCH ===== */
  .search-box { position: relative; margin-bottom: 14px; }
  .search-box input { width: 100%; padding: 9px 12px 9px 36px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'Heebo', sans-serif; font-size: 13px; }
  .search-box input:focus { outline: none; border-color: var(--accent); }
  .search-box .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px; }

  /* ===== WA PREVIEW ===== */
  .wa-preview { background: #0b4f39; border-radius: var(--radius-sm); padding: 12px 14px; margin: 12px 0; font-size: 13px; line-height: 1.7; color: #e9f5e9; direction: rtl; white-space: pre-line; border: 1px solid #155e45; }
  .wa-preview-label { font-size: 11px; color: var(--text-dim); margin-bottom: 5px; display: flex; align-items: center; gap: 6px; }

  /* ===== COUNTER ===== */
  .lesson-count { display: flex; align-items: center; gap: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 7px 12px; }
  .count-btn { width: 30px; height: 30px; border: 1px solid var(--border); background: var(--card); color: var(--text); border-radius: 8px; font-size: 17px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 600; transition: all 0.15s; }
  .count-btn:hover { border-color: var(--accent); color: var(--accent); }
  .count-display { font-family: 'Rubik', sans-serif; font-size: 18px; font-weight: 700; min-width: 28px; text-align: center; }

  /* ===== WEEKLY CALENDAR ===== */
  .cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .cal-nav-title { font-family: 'Rubik', sans-serif; font-weight: 600; font-size: 15px; }
  .cal-nav-btn { width: 34px; height: 34px; border: 1px solid var(--border); background: var(--surface); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); font-size: 16px; transition: all 0.15s; }
  .cal-nav-btn:hover { border-color: var(--accent); color: var(--accent); }

  .cal-week-header { display: grid; grid-template-columns: 44px repeat(7, 1fr); gap: 0; margin-bottom: 2px; }
  .cal-day-label { text-align: center; font-size: 11px; color: var(--text-muted); padding: 4px 0; font-weight: 500; }
  .cal-day-label.today { color: var(--accent); font-weight: 700; }
  .cal-day-num { font-family: 'Rubik', sans-serif; font-size: 13px; font-weight: 600; display: block; }

  .cal-body { display: grid; grid-template-columns: 44px repeat(7, 1fr); gap: 0; position: relative; }
  .cal-hour-label { font-size: 10px; color: var(--text-muted); text-align: center; height: 48px; display: flex; align-items: flex-start; justify-content: center; padding-top: 2px; font-family: 'Rubik', sans-serif; border-top: 1px solid var(--border); }
  .cal-cell { height: 48px; border-top: 1px solid var(--border); border-right: 1px solid var(--border); position: relative; cursor: pointer; transition: background 0.15s; }
  .cal-cell:hover { background: var(--surface-hover); }
  .cal-cell.today-col { background: rgba(34,197,94,0.04); }

  .cal-event { position: absolute; right: 2px; left: 2px; background: linear-gradient(135deg, var(--accent), var(--accent-dim)); border-radius: 6px; padding: 3px 5px; font-size: 10px; font-weight: 600; color: #000; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; z-index: 5; line-height: 1.2; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
  .cal-event:hover { filter: brightness(1.1); transform: scale(1.02); }
  .cal-event .ev-time { font-family: 'Rubik', sans-serif; font-size: 9px; opacity: 0.8; }

  .cal-scroll { max-height: min(480px, 60vh); overflow-y: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); -webkit-overflow-scrolling: touch; }

  /* ===== PAYMENT ITEM ===== */
  .payment-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; }
  .payment-amount { font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 16px; min-width: 70px; text-align: center; }
  .payment-amount.income { color: var(--accent); }
  .payment-amount.debt { color: var(--danger); }
  .payment-info { flex: 1; }
  .payment-name { font-weight: 600; font-size: 13px; }
  .payment-meta { font-size: 11px; color: var(--text-dim); }

  /* ===== DEBT LIST IN FINANCE ===== */
  .debt-student { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
  .debt-student:hover { border-color: var(--warning); }
  .debt-amount { font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 18px; color: var(--danger); }
  .debt-info { flex: 1; }
  .debt-name { font-weight: 600; font-size: 14px; }
  .debt-detail { font-size: 11px; color: var(--text-dim); }

  /* ===== MONTH PICKER ===== */
  .month-picker { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; justify-content: center; }
  .month-picker-label { font-family: 'Rubik', sans-serif; font-weight: 600; font-size: 15px; min-width: 120px; text-align: center; }

  /* ===== LICENSE SCREEN ===== */
  .license-screen {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .license-screen.hidden { display: none; }
  .license-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 30px 24px;
    max-width: 360px;
    width: 100%;
    text-align: center;
  }
  .license-logo { font-size: 48px; margin-bottom: 12px; }
  .license-title { font-family: 'Rubik', sans-serif; font-size: 22px; font-weight: 700; margin-bottom: 6px; }
  .license-title span { color: var(--accent); }
  .license-subtitle { font-size: 13px; color: var(--text-dim); margin-bottom: 24px; }
  .license-input {
    width: 100%;
    padding: 14px 16px;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Rubik', sans-serif;
    font-size: 18px;
    text-align: center;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }
  .license-input:focus { outline: none; border-color: var(--accent); }
  .license-input::placeholder { letter-spacing: 0; font-size: 14px; }
  .license-error { color: var(--danger); font-size: 13px; margin-bottom: 12px; display: none; }
  .license-error.show { display: block; }
  .license-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim));
    border: none;
    border-radius: var(--radius-sm);
    color: #000;
    font-family: 'Heebo', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
  }
  .license-btn:hover { filter: brightness(1.1); }
  .license-footer { margin-top: 20px; font-size: 11px; color: var(--text-muted); }

  /* ===== LICENSED USER BADGE ===== */
  .licensed-badge {
    font-size: 10px;
    color: var(--accent);
    background: var(--accent-glow);
    padding: 2px 8px;
    border-radius: 10px;
    margin-right: 8px;
  }

  /* ===== SCROLLBAR ===== */
  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ===== MOBILE FIXES ===== */
  /* Prevent iOS zoom on input focus - must be 16px+ */
  @media screen and (max-width: 768px) {
    .form-input, .form-select, .form-textarea { font-size: 16px; }
  }

  /* Safe area for iPhone notch/dynamic island */
  @supports (padding: env(safe-area-inset-top)) {
    .header { padding-top: calc(16px + env(safe-area-inset-top)); }
    .nav-tabs { top: calc(70px + env(safe-area-inset-top)); }
    .main { padding-bottom: calc(100px + env(safe-area-inset-bottom)); }
    .modal { padding-bottom: calc(28px + env(safe-area-inset-bottom)); }
    .toast { bottom: calc(80px + env(safe-area-inset-bottom)); }
  }

  /* Touch: prevent text selection on interactive elements */
  .btn, .nav-tab, .icon-btn, .cal-nav-btn, .count-btn, .student-item, .debt-student {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }

  /* Improve touch targets - minimum 44px */
  .icon-btn { min-width: 44px; min-height: 44px; }
  .cal-nav-btn { min-width: 44px; min-height: 44px; }
  .count-btn { min-width: 44px; min-height: 44px; }

  @media (max-width: 400px) {
    .form-row { grid-template-columns: 1fr; }
    .form-row.three { grid-template-columns: 1fr 1fr; }
    .stats-bar.four { grid-template-columns: repeat(2, 1fr); }
    .stat-number { font-size: 20px; }
    .cal-week-header, .cal-body { grid-template-columns: 36px repeat(7, 1fr); }
    .cal-hour-label { font-size: 9px; }
    .cal-event { font-size: 9px; padding: 2px 3px; }
  }
  @media (max-width: 340px) {
    .form-row.three { grid-template-columns: 1fr; }
    .nav-tab { font-size: 11px; padding: 8px 2px; }
  }

  /* ===== VEHICLE PAGE ===== */
  .vehicle-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }
  .vehicle-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }
  .vehicle-title-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .vehicle-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }
  .vehicle-main-info h3 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 2px;
  }
  .vehicle-plate {
    font-family: 'Rubik', sans-serif;
    font-size: 14px;
    color: var(--accent);
    letter-spacing: 1px;
  }
  .vehicle-details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }
  .vehicle-detail-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .vehicle-detail-label {
    font-size: 11px;
    color: var(--text-muted);
  }
  .vehicle-detail-value {
    font-size: 14px;
    font-weight: 500;
  }

  /* ===== REMINDERS LIST ===== */
  .reminders-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .reminder-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
  }
  .reminder-item.warning {
    border-color: var(--warning);
    background: var(--warning-dim);
  }
  .reminder-item.danger {
    border-color: var(--danger);
    background: var(--danger-dim);
  }
  .reminder-item.ok {
    border-color: var(--accent);
  }
  .reminder-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    background: var(--surface);
  }
  .reminder-item.warning .reminder-icon { background: var(--warning); }
  .reminder-item.danger .reminder-icon { background: var(--danger); }
  .reminder-item.ok .reminder-icon { background: var(--accent-dim); }
  .reminder-content {
    flex: 1;
    min-width: 0;
  }
  .reminder-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 2px;
  }
  .reminder-date {
    font-size: 12px;
    color: var(--text-dim);
  }
  .reminder-days {
    font-family: 'Rubik', sans-serif;
    font-size: 13px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 8px;
    white-space: nowrap;
  }
  .reminder-item.warning .reminder-days { color: var(--warning); background: rgba(245,158,11,0.2); }
  .reminder-item.danger .reminder-days { color: var(--danger); background: rgba(239,68,68,0.2); }
  .reminder-item.ok .reminder-days { color: var(--accent); background: var(--accent-glow); }

  /* ===== KM HISTORY ===== */
  .km-history-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .km-history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--surface);
    border-radius: var(--radius-sm);
    font-size: 13px;
  }
  .km-history-date {
    color: var(--text-dim);
  }
  .km-history-value {
    font-family: 'Rubik', sans-serif;
    font-weight: 600;
    color: var(--text);
  }
  .km-history-diff {
    font-size: 11px;
    color: var(--accent);
  }
</style>
</head>
<body>

<!-- ===== LICENSE ACTIVATION SCREEN ===== -->
<div class="license-screen" id="licenseScreen">
  <div class="license-box">
    <div class="license-logo">ğŸš—</div>
    <div class="license-title">× ×”×’<span>×‘×¡×“×¨</span></div>
    <div class="license-subtitle">×”×–×Ÿ ××ª ×§×•×“ ×”×”×¤×¢×œ×” ×©×§×™×‘×œ×ª</div>
    <input type="text" class="license-input" id="licenseCodeInput" placeholder="XXXX-XXXX" maxlength="9" dir="ltr">
    <div class="license-error" id="licenseError">âŒ ×§×•×“ ×œ× ×ª×§×™×Ÿ, × ×¡×” ×©×•×‘</div>
    <button class="license-btn" onclick="activateLicense()">ğŸ”“ ×”×¤×¢×œ</button>
    <div class="license-footer">×œ×§×‘×œ×ª ×§×•×“ ×”×¤×¢×œ×” ×¦×•×¨ ×§×©×¨ ×¢× ×”××¤×ª×—</div>
  </div>
</div>

<header class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">ğŸš—</div>
      <div class="logo-text">× ×”×’<span>×‘×¡×“×¨</span></div>
      <span class="licensed-badge" id="licensedBadge"></span>
    </div>
    <div class="header-date" id="headerDate"></div>
  </div>
</header>

<nav class="nav-tabs">
  <button class="nav-tab active" data-page="dashboard" onclick="switchPage('dashboard')"><span class="tab-icon">ğŸ“Š</span> ×¨××©×™</button>
  <button class="nav-tab" data-page="calendar" onclick="switchPage('calendar')"><span class="tab-icon">ğŸ“…</span> ×™×•××Ÿ</button>
  <button class="nav-tab" data-page="students" onclick="switchPage('students')"><span class="tab-icon">ğŸ‘¤</span> ×ª×œ××™×“×™×</button>
  <button class="nav-tab" data-page="finance" onclick="switchPage('finance')"><span class="tab-icon">ğŸ’°</span> ×›×¡×¤×™×</button>
  <button class="nav-tab" data-page="vehicle" onclick="switchPage('vehicle')"><span class="tab-icon">ğŸš—</span> ×¨×›×‘</button>
</nav>

<main class="main">

  <!-- ========== DASHBOARD ========== -->
  <div class="page active" id="page-dashboard">
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-number" id="statStudents">0</div>
        <div class="stat-label">×ª×œ××™×“×™×</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statLessonsToday">0</div>
        <div class="stat-label">×”×™×•×</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statDebtTotal">0</div>
        <div class="stat-label">×—×•×‘ ×¤×ª×•×— â‚ª</div>
      </div>
    </div>
    <div class="section-title">×©×™×¢×•×¨×™× ×§×¨×•×‘×™×</div>
    <div id="upcomingLessons"></div>
    <div style="margin-top:16px;">
      <button class="btn btn-primary" onclick="openNewLessonModal()">â• ×§×‘×™×¢×ª ×©×™×¢×•×¨ ×—×“×©</button>
    </div>
    <div id="tomorrowLessons" style="margin-top:20px;"></div>
    <div id="debtAlerts" style="margin-top:20px;"></div>
    <div style="margin-top:24px;display:flex;gap:8px;">
      <button class="btn btn-outline btn-sm" style="flex:1;" onclick="exportData()">ğŸ“¥ ×™×™×¦×•× ×’×™×‘×•×™</button>
      <button class="btn btn-outline btn-sm" style="flex:1;" onclick="importData()">ğŸ“¤ ×™×™×‘×•× ×’×™×‘×•×™</button>
    </div>
  </div>

  <!-- ========== CALENDAR ========== -->
  <div class="page" id="page-calendar">
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="calPrev()">â†’</button>
      <div>
        <span class="cal-nav-title" id="calTitle"></span>
        <button class="btn-sm btn-outline" style="margin-right:8px;padding:4px 10px;font-size:11px;" onclick="calToday()">×”×™×•×</button>
      </div>
      <button class="cal-nav-btn" onclick="calNext()">â†</button>
    </div>
    <div class="cal-scroll">
      <div class="cal-week-header" id="calWeekHeader"></div>
      <div class="cal-body" id="calBody"></div>
    </div>
    <div style="margin-top:12px;">
      <button class="btn btn-primary" onclick="openNewLessonModal()">â• ×©×™×¢×•×¨ ×—×“×©</button>
    </div>
  </div>

  <!-- ========== STUDENTS ========== -->
  <div class="page" id="page-students">
    <div style="display:flex;gap:6px;margin-bottom:12px;">
      <button class="btn btn-primary" style="flex:1" onclick="openNewStudentModal()">â• ×ª×œ××™×“ ×—×“×©</button>
    </div>
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" placeholder="×—×™×¤×•×© ×ª×œ××™×“..." id="studentSearch" oninput="renderStudents()">
    </div>
    <div id="studentsList"></div>
  </div>

  <!-- ========== FINANCE ========== -->
  <div class="page" id="page-finance">
    <div class="month-picker">
      <button class="cal-nav-btn" onclick="finPrev()">â†’</button>
      <span class="month-picker-label" id="finMonthLabel"></span>
      <button class="cal-nav-btn" onclick="finNext()">â†</button>
    </div>
    <!-- Date Range Filter -->
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span style="font-size:12px;color:var(--text-dim);">ğŸ“… ×¡×™× ×•×Ÿ:</span>
        <input type="date" id="finDateFrom" class="form-input" style="flex:1;min-width:110px;padding:6px 8px;font-size:12px;" onchange="applyDateFilter()">
        <span style="font-size:12px;color:var(--text-dim);">×¢×“</span>
        <input type="date" id="finDateTo" class="form-input" style="flex:1;min-width:110px;padding:6px 8px;font-size:12px;" onchange="applyDateFilter()">
        <button class="btn btn-outline btn-sm" style="padding:6px 10px;font-size:11px;" onclick="clearDateFilter()">× ×§×”</button>
      </div>
    </div>
    <div class="stats-bar four" id="finStats"></div>
    <div class="section-title">×—×•×‘×•×ª ×¤×ª×•×—×™×</div>
    <div id="debtList"></div>
    <div class="section-title" style="margin-top:18px;">×ª×©×œ×•××™× ××—×¨×•× ×™×</div>
    <div id="paymentsList"></div>
  </div>

  <!-- ========== VEHICLE ========== -->
  <div class="page" id="page-vehicle">
    <div class="section-title">ğŸš— ×¤×¨×˜×™ ×”×¨×›×‘</div>
    <div class="card vehicle-card" id="vehicleDetails">
      <div id="vehicleInfo">
        <div class="empty-state" style="padding:30px;">
          <div style="font-size:40px;margin-bottom:10px;">ğŸš—</div>
          <div style="color:var(--text-dim);">×œ× ×”×•×’×“×¨ ×¨×›×‘ ×¢×“×™×™×Ÿ</div>
          <button class="btn btn-primary btn-sm" style="margin-top:14px;" onclick="openVehicleEditModal()">â• ×”×•×¡×£ ×¨×›×‘</button>
        </div>
      </div>
    </div>

    <div class="section-title" style="margin-top:20px;">ğŸ“… ×ª×–×›×•×¨×•×ª</div>
    <div id="vehicleReminders" class="reminders-list"></div>

    <div class="section-title" style="margin-top:20px;">ğŸ“Š ××¢×§×‘ ×§×™×œ×•××˜×¨××–'</div>
    <div class="card" style="padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span style="color:var(--text-dim);font-size:13px;">×§×™×œ×•××˜×¨××–' × ×•×›×—×™</span>
        <span style="font-size:24px;font-weight:700;color:var(--accent);" id="currentKm">â€”</span>
      </div>
      <button class="btn btn-outline btn-sm" style="width:100%;" onclick="openKmUpdateModal()">ğŸ“ ×¢×“×›×•×Ÿ ×§×™×œ×•××˜×¨××–'</button>
      <div id="kmHistory" style="margin-top:16px;"></div>
    </div>
  </div>

</main>

<!-- ===== MODAL: NEW STUDENT ===== -->
<div class="modal-overlay" id="modalNewStudent">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ‘¤ ×ª×œ××™×“ ×—×“×©</div>
    <div class="form-group">
      <label class="form-label">×©× ××œ× *</label>
      <input class="form-input" id="newStudentName" placeholder="×™×©×¨××œ ×™×©×¨××œ×™">
    </div>
    <div class="form-group">
      <label class="form-label">×˜×œ×¤×•×Ÿ *</label>
      <input class="form-input" id="newStudentPhone" type="tel" placeholder="050-1234567" dir="ltr">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">××—×™×¨ ×œ×©×™×¢×•×¨ (â‚ª)</label>
        <input class="form-input" id="newStudentPrice" type="number" placeholder="170" dir="ltr">
      </div>
      <div class="form-group">
        <label class="form-label">×©×™×¢×•×¨×™× ×©×‘×•×¦×¢×•</label>
        <div class="lesson-count">
          <button type="button" class="count-btn" onclick="adjustCount('newStudentLessons',-1)">âˆ’</button>
          <span class="count-display" id="newStudentLessons">0</span>
          <button type="button" class="count-btn" onclick="adjustCount('newStudentLessons',1)">+</button>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">×”×¢×¨×•×ª</label>
      <textarea class="form-textarea" id="newStudentNotes" placeholder="×”×¢×¨×•×ª..."></textarea>
    </div>
    <div class="form-group" style="display:flex;align-items:center;gap:10px;">
      <input type="checkbox" id="newStudentWantsExtra" style="width:20px;height:20px;accent-color:var(--accent);">
      <label for="newStudentWantsExtra" style="font-size:14px;color:var(--text);cursor:pointer;">××—×¤×© ×©×¢×•×ª × ×•×¡×¤×•×ª ğŸ””</label>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-primary" style="flex:2" onclick="preventDoubleClick(saveNewStudent)">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalNewStudent')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: NEW LESSON ===== -->
<div class="modal-overlay" id="modalNewLesson">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="lessonModalTitle">ğŸ“… ×§×‘×™×¢×ª ×©×™×¢×•×¨</div>
    <div class="form-group">
      <label class="form-label">×ª×œ××™×“ *</label>
      <select class="form-select" id="lessonStudent"><option value="">â€” ×‘×—×¨ â€”</option></select>
    </div>
    <div class="form-row three">
      <div class="form-group">
        <label class="form-label">×ª××¨×™×š *</label>
        <input class="form-input" id="lessonDate" type="date">
      </div>
      <div class="form-group">
        <label class="form-label">×©×¢×” *</label>
        <input class="form-input" id="lessonTime" type="time">
      </div>
      <div class="form-group">
        <label class="form-label">××©×š</label>
        <select class="form-select" id="lessonDuration">
          <option value="40">40 ×“×§×³</option>
          <option value="80">80 ×“×§×³</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">×›×ª×•×‘×ª ××™×¡×•×£</label>
      <input class="form-input" id="lessonAddress" placeholder="×¨×—×•×‘, ×¢×™×¨">
    </div>
    <div id="waPreviewSection" style="display:none;">
      <div class="wa-preview-label">ğŸ’¬ ×ª×¦×•×’×” ××§×“×™××”:</div>
      <div class="wa-preview" id="waPreviewText"></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:7px;margin-top:16px;">
      <button type="button" class="btn btn-primary" onclick="preventDoubleClick(()=>saveLesson(false))">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-whatsapp" onclick="preventDoubleClick(()=>saveLesson(true))">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        ×©××™×¨×” + ×•×•××˜×¡××¤
      </button>
      <button type="button" class="btn btn-outline" onclick="closeModal('modalNewLesson')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: PAYMENT ===== -->
<div class="modal-overlay" id="modalPayment">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’³ ×¨×™×©×•× ×ª×©×œ×•×</div>
    <div class="form-group">
      <label class="form-label">×ª×œ××™×“</label>
      <select class="form-select" id="payStudent"><option value="">â€” ×‘×—×¨ â€”</option></select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">×¡×›×•× (â‚ª) *</label>
        <input class="form-input" id="payAmount" type="number" placeholder="170" dir="ltr">
      </div>
      <div class="form-group">
        <label class="form-label">×××¦×¢×™ ×ª×©×œ×•×</label>
        <select class="form-select" id="payMethod">
          <option value="××–×•××Ÿ">××–×•××Ÿ</option>
          <option value="×‘×™×˜">×‘×™×˜</option>
          <option value="×¤×™×™×‘×•×§×¡">×¤×™×™×‘×•×§×¡</option>
          <option value="×”×¢×‘×¨×”">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
          <option value="××©×¨××™">××©×¨××™</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">×ª××¨×™×š</label>
      <input class="form-input" id="payDate" type="date">
    </div>
    <div class="form-group">
      <label class="form-label">×”×¢×¨×”</label>
      <input class="form-input" id="payNote" placeholder="×œ×“×•×’××”: ×ª×©×œ×•× ×¢×œ 5 ×©×™×¢×•×¨×™×">
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-primary" style="flex:2" onclick="preventDoubleClick(savePayment)">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalPayment')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: STUDENT DETAIL ===== -->
<div class="modal-overlay" id="modalStudentDetail">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="detailStudentTitle">ğŸ‘¤</div>
    <div id="detailStudentContent"></div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalStudentDetail')">×¡×’×™×¨×”</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: VEHICLE EDIT ===== -->
<div class="modal-overlay" id="modalVehicleEdit">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸš— ×¤×¨×˜×™ ×”×¨×›×‘</div>
    <div class="form-group">
      <label class="form-label">××¡×¤×¨ ×¨×›×‘ *</label>
      <input class="form-input" id="vehiclePlate" placeholder="12-345-67" dir="ltr">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">×™×¦×¨×Ÿ</label>
        <input class="form-input" id="vehicleMake" placeholder="×§×™×”">
      </div>
      <div class="form-group">
        <label class="form-label">×“×’×</label>
        <input class="form-input" id="vehicleModel" placeholder="× ×™×¨×•">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">×©× ×ª ×™×™×¦×•×¨</label>
        <input class="form-input" id="vehicleYear" type="number" placeholder="2022" dir="ltr">
      </div>
      <div class="form-group">
        <label class="form-label">×¡×•×’ ×ª×™×‘×”</label>
        <select class="form-input" id="vehicleTransmission">
          <option value="××•×˜×•××˜">××•×˜×•××˜</option>
          <option value="×™×“× ×™">×™×“× ×™</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">×¦×‘×¢</label>
      <input class="form-input" id="vehicleColor" placeholder="×œ×‘×Ÿ">
    </div>
    <div class="section-title" style="margin-top:16px;">ğŸ“… ×ª×–×›×•×¨×•×ª</div>
    <div class="form-group">
      <label class="form-label">×˜×¡×˜ ×©× ×ª×™</label>
      <input class="form-input" id="vehicleTestDate" type="date" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">×‘×™×˜×•×— ×—×•×‘×”</label>
      <input class="form-input" id="vehicleInsuranceDate" type="date" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">×‘×™×˜×•×— ××§×™×£</label>
      <input class="form-input" id="vehicleFullInsuranceDate" type="date" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">×˜×™×¤×•×œ ×”×‘×</label>
      <input class="form-input" id="vehicleServiceDate" type="date" dir="ltr">
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-primary" style="flex:2" onclick="saveVehicle()">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalVehicleEdit')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: KM UPDATE ===== -->
<div class="modal-overlay" id="modalKmUpdate">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“Š ×¢×“×›×•×Ÿ ×§×™×œ×•××˜×¨××–'</div>
    <div class="form-group">
      <label class="form-label">×§×™×œ×•××˜×¨××–' × ×•×›×—×™</label>
      <input class="form-input" id="newKmValue" type="number" placeholder="50000" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">×ª××¨×™×š</label>
      <input class="form-input" id="kmUpdateDate" type="date" dir="ltr">
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-primary" style="flex:2" onclick="saveKmUpdate()">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalKmUpdate')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// LICENSE SYSTEM (with hashed codes for security)
// ============================================================
// ×¤×•× ×§×¦×™×™×ª Hash ×¤×©×•×˜×” - ×”×•×¤×›×ª ×§×•×“ ×œ×¢×¨×š ××•×¦×¤×Ÿ
function hashCode(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  // Add salt and secondary hash for better security
  const salted = 'NBS_' + Math.abs(hash).toString(16) + '_DRV';
  let hash2 = 5381;
  for (let i = 0; i < salted.length; i++) {
    hash2 = ((hash2 << 5) + hash2) + salted.charCodeAt(i);
  }
  return Math.abs(hash2).toString(36).toUpperCase();
}

// ×§×•×“×™ ×”×¤×¢×œ×” ××•×¦×¤× ×™× - ×œ×”×•×¡×¤×ª ×§×•×“ ×—×“×©:
// 1. ×”×¤×¢×œ ×‘×§×•× ×¡×•×œ: hashCode('NAHAG-XXX')
// 2. ×”×•×¡×£ ××ª ×”×ª×•×¦××” ×œ××˜×” ×¢× ×©× ×”××•×¨×”
const VALID_LICENSES = {
  'MZHCWP': '××•×¨×” ×œ×“×•×’××”',       // NAHAG-001
  'MYRXUG': '××•×¨×” × ×”×™×’×” 2',      // NAHAG-002
  'NDLQ5P': '××•×¨×” × ×”×™×’×” 3',      // NAHAG-003
  'NCWB3G': '××•×¨×” × ×”×™×’×” 4',      // NAHAG-004
  'NC6W17': '××•×¨×” × ×”×™×’×” 5',      // NAHAG-005
  '1F70W2A': '××‘×™ ××œ×—×¨×¨',        // NAHAG-AVI
  // ×œ×”×•×¡×¤×ª ×§×•×“×™×: hashCode('CODE') ×‘×§×•× ×¡×•×œ â† ×”×•×¡×£ ×ª×•×¦××” ×›××Ÿ
};

let currentLicense = null;
let licensedName = null;

function checkLicense() {
  const savedHash = localStorage.getItem('drv_license_hash');
  const savedName = localStorage.getItem('drv_licensed_name');

  // Check new hash-based license
  if (savedHash && VALID_LICENSES[savedHash]) {
    currentLicense = savedHash;
    licensedName = savedName || VALID_LICENSES[savedHash];
    hideLicenseScreen();
    updateLicensedBadge();
    return true;
  }

  // Migrate old plain-text license to hash
  const oldLicense = localStorage.getItem('drv_license');
  if (oldLicense) {
    const oldHash = hashCode(oldLicense.toUpperCase());
    if (VALID_LICENSES[oldHash]) {
      localStorage.setItem('drv_license_hash', oldHash);
      localStorage.removeItem('drv_license'); // Clean up old key
      currentLicense = oldHash;
      licensedName = savedName || VALID_LICENSES[oldHash];
      hideLicenseScreen();
      updateLicensedBadge();
      return true;
    }
  }

  showLicenseScreen();
  return false;
}

function showLicenseScreen() {
  document.getElementById('licenseScreen').classList.remove('hidden');
}

function hideLicenseScreen() {
  document.getElementById('licenseScreen').classList.add('hidden');
}

function activateLicense() {
  const input = document.getElementById('licenseCodeInput');
  const error = document.getElementById('licenseError');
  const code = input.value.trim().toUpperCase();
  const codeHash = hashCode(code);

  if (VALID_LICENSES[codeHash]) {
    // ×§×•×“ ×ª×§×™×Ÿ
    currentLicense = codeHash;
    licensedName = VALID_LICENSES[codeHash];
    localStorage.setItem('drv_license_hash', codeHash);
    localStorage.setItem('drv_licensed_name', licensedName);
    error.classList.remove('show');
    hideLicenseScreen();
    updateLicensedBadge();
    showToast('âœ… ×”××¤×œ×™×§×¦×™×” ×”×•×¤×¢×œ×” ×‘×”×¦×œ×—×”!');
    renderAll();
  } else {
    // ×§×•×“ ×œ× ×ª×§×™×Ÿ
    error.classList.add('show');
    input.style.borderColor = 'var(--danger)';
    setTimeout(() => { input.style.borderColor = ''; }, 2000);
  }
}

function updateLicensedBadge() {
  const badge = document.getElementById('licensedBadge');
  if (licensedName) {
    badge.textContent = licensedName;
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
}

// ×”×•×¡×£ ××§×£ ××•×˜×•××˜×™ ×‘×–××Ÿ ×”×§×œ×“×”
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('licenseCodeInput');
  if (input) {
    input.addEventListener('input', (e) => {
      let val = e.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
      if (val.length > 5) {
        val = val.slice(0, 5) + '-' + val.slice(5, 8);
      }
      e.target.value = val;
    });

    // ××¤×©×¨ ×œ×œ×—×•×¥ Enter ×œ×”×¤×¢×œ×”
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') activateLicense();
    });
  }
});

// ============================================================
// DATA
// ============================================================
let students, lessons, payments;
let dataCorrupted = false;

try {
  students = JSON.parse(localStorage.getItem('drv_students') || '[]');
  lessons = JSON.parse(localStorage.getItem('drv_lessons') || '[]');
  payments = JSON.parse(localStorage.getItem('drv_payments') || '[]');

  // Basic validation
  if (!Array.isArray(students) || !Array.isArray(lessons) || !Array.isArray(payments)) {
    throw new Error('Invalid data format');
  }
} catch(e) {
  dataCorrupted = true;
  students = []; lessons = []; payments = [];
  // Show error after page loads
  setTimeout(() => {
    alert('âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×!\n\n×”× ×ª×•× ×™× × ×¤×’××• ××• ×œ× ×ª×§×™× ×™×.\n× × ×œ×™×™×‘× ×’×™×‘×•×™ ×× ×™×© ×œ×š.');
  }, 500);
}

// Returns true if save succeeded, false if failed
function saveData() {
  try {
    localStorage.setItem('drv_students', JSON.stringify(students));
    localStorage.setItem('drv_lessons', JSON.stringify(lessons));
    localStorage.setItem('drv_payments', JSON.stringify(payments));
    return true;
  } catch(e) {
    showToast('âŒ ×©×’×™××” ×‘×©××™×¨×”! ×”× ×ª×•× ×™× ×œ× × ×©××¨×•');
    return false;
  }
}

// ============================================================
// UTILS
// ============================================================
function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function formatPhone(p) { let c=p.replace(/[\s\-()+"]/g,''); c=c.replace(/^\+/,''); if(c.startsWith('972')) return c; if(c.startsWith('0')) return '972'+c.slice(1); return '972'+c; }
const DAYS_HEB = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
const DAYS_SHORT = ['××³','×‘×³','×’×³','×“×³','×”×³','×•×³','×©×³'];
const MONTHS_HEB = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];

function formatDateHeb(ds) {
  const d = new Date(ds+'T00:00:00');
  return `×™×•× ${DAYS_HEB[d.getDay()]}, ${d.getDate()} ${MONTHS_HEB[d.getMonth()]}`;
}
function dateStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

// REAL date functions - for calculations and customer messages
function getRealTodayStr() { return dateStr(new Date()); }
function getRealTomorrowStr() { const t = new Date(); t.setDate(t.getDate()+1); return dateStr(t); }

// "Working day" extends until 4:00 AM - for UI display only (dashboard, calendar)
function getWorkingDate() {
  const now = new Date();
  if (now.getHours() < 4) {
    now.setDate(now.getDate() - 1); // Before 4AM = still "yesterday"
  }
  return now;
}
function todayStr() { return dateStr(getWorkingDate()); }
function tomorrowStr() { const t = getWorkingDate(); t.setDate(t.getDate()+1); return dateStr(t); }
function isToday(ds) { return ds === todayStr(); }
function getInitials(n) { if(!n || !n.trim()) return '?'; return n.split(' ').map(w=>w[0]).join('').slice(0,2); }
function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
function fmtMoney(n) { return n.toLocaleString('he-IL'); }
function escHtml(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

// Sanitize string - remove potentially dangerous content and limit length
function sanitizeString(str, maxLen = 500) {
  if (typeof str !== 'string') return '';
  // Trim and limit length
  let clean = str.trim().slice(0, maxLen);
  // Remove null bytes and control characters (except newlines/tabs)
  clean = clean.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
  return clean;
}

// Validate and sanitize ID (alphanumeric only)
function sanitizeId(id) {
  if (typeof id !== 'string') return '';
  return id.replace(/[^a-zA-Z0-9_-]/g, '').slice(0, 50);
}

// Validate phone number format
function isValidPhone(phone) {
  if (typeof phone !== 'string') return false;
  const digits = phone.replace(/[\s\-()+"]/g, '').replace(/^\+/, '');
  return digits.length >= 9 && digits.length <= 15 && /^\d+$/.test(digits);
}

// Validate date string format (YYYY-MM-DD)
function isValidDateStr(dateStr) {
  if (typeof dateStr !== 'string') return false;
  return /^\d{4}-\d{2}-\d{2}$/.test(dateStr);
}

// Validate time string format (HH:MM)
function isValidTimeStr(timeStr) {
  if (typeof timeStr !== 'string') return false;
  return /^\d{2}:\d{2}$/.test(timeStr);
}

// Validate and sanitize a student object
function validateStudent(obj) {
  if (!obj || typeof obj !== 'object') return null;

  const id = sanitizeId(obj.id);
  const name = sanitizeString(obj.name, 100);
  const phone = sanitizeString(obj.phone, 20);

  // Required fields must be valid
  if (!id || !name || !isValidPhone(phone)) return null;

  return {
    id: id,
    name: name,
    phone: phone,
    price: (typeof obj.price === 'number' && obj.price >= 0 && obj.price <= 10000) ? obj.price : 170,
    notes: sanitizeString(obj.notes || '', 1000),
    wantsExtraLessons: obj.wantsExtraLessons === true,
    createdAt: isValidDateStr(obj.createdAt?.slice(0, 10)) ? obj.createdAt : new Date().toISOString()
  };
}

// Validate and sanitize a lesson object
function validateLesson(obj, validStudentIds) {
  if (!obj || typeof obj !== 'object') return null;

  const id = sanitizeId(obj.id);
  const studentId = sanitizeId(obj.studentId);
  const date = obj.date;
  const time = obj.time;

  // Required fields must be valid
  if (!id || !studentId || !isValidDateStr(date) || !isValidTimeStr(time)) return null;
  // Student must exist
  if (!validStudentIds.has(studentId)) return null;

  return {
    id: id,
    studentId: studentId,
    studentName: sanitizeString(obj.studentName || '', 100),
    date: date,
    time: time,
    duration: (typeof obj.duration === 'number' && obj.duration >= 15 && obj.duration <= 480) ? obj.duration : 45,
    address: sanitizeString(obj.address || '', 200),
    priceAtTime: (typeof obj.priceAtTime === 'number' && obj.priceAtTime >= 0 && obj.priceAtTime <= 10000) ? obj.priceAtTime : 0,
    status: ['scheduled', 'completed', 'cancelled'].includes(obj.status) ? obj.status : 'scheduled',
    createdAt: obj.createdAt || new Date().toISOString()
  };
}

// Validate and sanitize a payment object
function validatePayment(obj, validStudentIds) {
  if (!obj || typeof obj !== 'object') return null;

  const id = sanitizeId(obj.id);
  const studentId = sanitizeId(obj.studentId);
  const date = obj.date;
  const amount = obj.amount;

  // Required fields must be valid
  if (!id || !studentId || !isValidDateStr(date)) return null;
  if (typeof amount !== 'number' || amount <= 0 || amount > 100000) return null;
  // Student must exist
  if (!validStudentIds.has(studentId)) return null;

  const validMethods = ['cash', 'transfer', 'bit', 'paybox', 'check', 'other'];

  return {
    id: id,
    studentId: studentId,
    studentName: sanitizeString(obj.studentName || '', 100),
    date: date,
    amount: amount,
    method: validMethods.includes(obj.method) ? obj.method : 'cash',
    note: sanitizeString(obj.note || '', 500),
    createdAt: obj.createdAt || new Date().toISOString()
  };
}

// Validate entire import data structure
function validateImportData(data) {
  if (!data || typeof data !== 'object') return null;
  if (!Array.isArray(data.students) || !Array.isArray(data.lessons) || !Array.isArray(data.payments)) return null;

  // Validate students first
  const validStudents = [];
  const validStudentIds = new Set();
  for (const s of data.students) {
    const validated = validateStudent(s);
    if (validated) {
      validStudents.push(validated);
      validStudentIds.add(validated.id);
    }
  }

  // Validate lessons (must reference valid students)
  const validLessons = [];
  for (const l of data.lessons) {
    const validated = validateLesson(l, validStudentIds);
    if (validated) validLessons.push(validated);
  }

  // Validate payments (must reference valid students)
  const validPayments = [];
  for (const p of data.payments) {
    const validated = validatePayment(p, validStudentIds);
    if (validated) validPayments.push(validated);
  }

  return {
    students: validStudents,
    lessons: validLessons,
    payments: validPayments,
    skipped: {
      students: data.students.length - validStudents.length,
      lessons: data.lessons.length - validLessons.length,
      payments: data.payments.length - validPayments.length
    }
  };
}

function populateStudentSelect(selId, preselectId) {
  const sel = document.getElementById(selId);
  sel.innerHTML = '<option value="">â€” ×‘×—×¨ ×ª×œ××™×“ â€”</option>';
  students.forEach(s=>{ sel.innerHTML += `<option value="${s.id}" ${s.id===preselectId?'selected':''}>${escHtml(s.name)}</option>`; });
}

// Student balance = total paid - sum of completed lesson prices
// Only counts lessons that actually happened (status = 'completed' or past date)
function getStudentBalance(s) {
  const totalPaid = payments.filter(p=>p.studentId===s.id).reduce((sum,p)=>sum+p.amount,0);

  // Calculate owed based on completed lessons (past or marked complete)
  const today = getRealTodayStr(); // Use real date, not working date
  const studentLessons = lessons.filter(l => l.studentId === s.id);

  let totalOwed = 0;
  studentLessons.forEach(l => {
    // Lesson counts as "done" if it's in the past OR marked as completed
    const isPast = l.date < today;
    const isCompleted = l.status === 'completed';
    if (isPast || isCompleted) {
      // Use stored price if available, otherwise use current student price
      totalOwed += (l.priceAtTime !== undefined) ? l.priceAtTime : (s.price || 0);
    }
  });

  return totalPaid - totalOwed; // negative = owes money
}

// Get count of completed lessons for student
function getCompletedLessonsCount(s) {
  const today = getRealTodayStr();
  return lessons.filter(l => {
    if (l.studentId !== s.id) return false;
    const isPast = l.date < today;
    const isCompleted = l.status === 'completed';
    return isPast || isCompleted;
  }).length;
}

// ============================================================
// NAV
// ============================================================
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelector(`[data-page="${page}"]`).classList.add('active');
  renderAll();
}

// ============================================================
// MODALS
// ============================================================
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// Double-click prevention
let isSaving = false;
function preventDoubleClick(fn) {
  if (isSaving) return;
  isSaving = true;
  try {
    fn();
  } finally {
    setTimeout(() => { isSaving = false; }, 500);
  }
}
function adjustCount(id,d) { const el=document.getElementById(id); let v=parseInt(el.textContent)+d; if(v<0)v=0; el.textContent=v; }

// Helper: transition from student detail to edit modal
function editStudentFromDetail(sid) {
  const s = students.find(x => x.id === sid);
  if (!s) {
    showToast('âš ï¸ ×©×’×™××” - ×ª×œ××™×“ ×œ× × ××¦×');
    closeModal('modalStudentDetail');
    return;
  }
  closeModal('modalStudentDetail');
  openNewStudentModal(sid);
}

// Helper: transition from student detail to payment modal
function paymentFromDetail(sid) {
  const s = students.find(x => x.id === sid);
  if (!s) {
    showToast('âš ï¸ ×©×’×™××” - ×ª×œ××™×“ ×œ× × ××¦×');
    closeModal('modalStudentDetail');
    return;
  }
  closeModal('modalStudentDetail');
  openPaymentModal(sid);
}

// ---- NEW / EDIT STUDENT ----
let editingStudentId = null;
function openNewStudentModal(editId) {
  editingStudentId = editId || null;
  if(editingStudentId) {
    const s = students.find(x=>x.id===editingStudentId);
    if(!s) { showToast('âš ï¸ ×ª×œ××™×“ ×œ× × ××¦×'); return; }
    document.getElementById('newStudentName').value = s.name;
    document.getElementById('newStudentPhone').value = s.phone;
    document.getElementById('newStudentPrice').value = s.price||170;
    document.getElementById('newStudentNotes').value = s.notes||'';
    document.getElementById('newStudentLessons').textContent = getCompletedLessonsCount(s);
    document.getElementById('newStudentWantsExtra').checked = s.wantsExtraLessons||false;
    document.querySelector('#modalNewStudent .modal-title').textContent = 'âœï¸ ×¢×¨×™×›×ª ×ª×œ××™×“';
  } else {
    ['newStudentName','newStudentPhone','newStudentNotes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('newStudentPrice').value = '170';
    document.getElementById('newStudentLessons').textContent = '0';
    document.getElementById('newStudentWantsExtra').checked = false;
    document.querySelector('#modalNewStudent .modal-title').textContent = 'ğŸ‘¤ ×ª×œ××™×“ ×—×“×©';
  }
  openModal('modalNewStudent');
}
function saveNewStudent() {
  const name = document.getElementById('newStudentName').value.trim();
  const phone = document.getElementById('newStudentPhone').value.trim();
  const price = parseInt(document.getElementById('newStudentPrice').value)||170;
  const notes = document.getElementById('newStudentNotes').value.trim();
  const ld = parseInt(document.getElementById('newStudentLessons').textContent);
  const wantsExtra = document.getElementById('newStudentWantsExtra').checked;
  if(!name||!phone){ showToast('âš ï¸ × × ×œ××œ× ×©× ×•×˜×œ×¤×•×Ÿ'); return; }
  const digits = phone.replace(/[\s\-()+"]/g,'').replace(/^\+/,'');
  if(digits.length < 9 || digits.length > 13 || !/^\d+$/.test(digits)){ showToast('âš ï¸ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ'); return; }
  if(price < 0 || price > 1000){ showToast('âš ï¸ ××—×™×¨ ×œ× ×ª×§×™×Ÿ (0-1000)'); return; }
  // Check for duplicate phone (only when adding new student)
  if(!editingStudentId) {
    const existingByPhone = students.find(s => formatPhone(s.phone) === formatPhone(phone));
    if(existingByPhone) {
      if(!confirm(`×›×‘×¨ ×§×™×™× ×ª×œ××™×“ ×¢× ××¡×¤×¨ ×–×”: ${existingByPhone.name}\n\n×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) return;
    }
  }
  if(editingStudentId) {
    const s = students.find(x=>x.id===editingStudentId);
    if(s) {
      s.name=name; s.phone=phone; s.price=price; s.notes=notes; s.wantsExtraLessons=wantsExtra;
      // Note: lessonsDone is now calculated dynamically, not stored
      // Update cached name in lessons/payments
      lessons.filter(l=>l.studentId===editingStudentId).forEach(l=>l.studentName=name);
      payments.filter(p=>p.studentId===editingStudentId).forEach(p=>p.studentName=name);
    }
    if(!saveData()) return; // Stop if save failed
    closeModal('modalNewStudent');
    showToast('âœ… ×ª×œ××™×“ ×¢×•×“×›×Ÿ');
    renderAll();
    editingStudentId = null;
  } else {
    students.push({ id:genId(), name, phone, price, notes, wantsExtraLessons:wantsExtra, createdAt:new Date().toISOString() });
    if(!saveData()) return; // Stop if save failed
    closeModal('modalNewStudent');
    showToast('âœ… ×ª×œ××™×“ × ×•×¡×£');
    renderAll();
  }
}

// ---- NEW LESSON ----
let lessonModalInitialized = false;
let editingLessonId = null;

function openNewLessonModal(prefillDate, prefillTime, editLessonId) {
  editingLessonId = editLessonId || null;
  const today = todayStr();
  const dateInput = document.getElementById('lessonDate');

  if (editingLessonId) {
    // Edit mode
    const lesson = lessons.find(l => l.id === editingLessonId);
    if (!lesson) { showToast('âš ï¸ ×©×™×¢×•×¨ ×œ× × ××¦×'); return; }

    document.getElementById('lessonModalTitle').textContent = 'âœï¸ ×¢×¨×™×›×ª ×©×™×¢×•×¨';
    populateStudentSelect('lessonStudent', lesson.studentId);
    dateInput.min = ''; // Allow editing past lessons
    dateInput.value = lesson.date;
    document.getElementById('lessonTime').value = lesson.time;
    document.getElementById('lessonDuration').value = lesson.duration || 40;
    document.getElementById('lessonAddress').value = lesson.address || '';
  } else {
    // New lesson mode
    document.getElementById('lessonModalTitle').textContent = 'ğŸ“… ×§×‘×™×¢×ª ×©×™×¢×•×¨';
    populateStudentSelect('lessonStudent');
    dateInput.min = today; // Prevent selecting past dates
    dateInput.value = (prefillDate && prefillDate >= today) ? prefillDate : today;
    document.getElementById('lessonTime').value = prefillTime || '';
    document.getElementById('lessonDuration').value = '40';
    document.getElementById('lessonAddress').value = '';
  }

  document.getElementById('waPreviewSection').style.display = 'none';
  openModal('modalNewLesson');

  // Only bind event handlers once
  if (!lessonModalInitialized) {
    ['lessonStudent','lessonDate','lessonTime','lessonDuration','lessonAddress'].forEach(id=>{
      document.getElementById(id).onchange = updateWaPreview;
      document.getElementById(id).oninput = updateWaPreview;
    });
    lessonModalInitialized = true;
  }
}

function openEditLessonModal(lessonId) {
  openNewLessonModal(null, null, lessonId);
}

function buildWaMsg(sName,date,time,dur,addr) {
  let m = `×©×œ×•× ${sName} ğŸ‘‹\n× ×§×‘×¢ ×œ×š ×©×™×¢×•×¨ × ×”×™×’×”:\n\nğŸ“… ${formatDateHeb(date)}\nğŸ• ${time}\nâ±ï¸ ${dur} ×“×§×•×ª\n`;
  if(addr) m += `ğŸ“ ${addr}\n`;
  m += `\n× ×ª×¨××”! ğŸš—`;
  return m;
}

// Build reminder message for tomorrow's lesson
// Uses real tomorrow date, not "working day" logic
function buildReminderMsg(sName, lessonDate, time, dur, addr) {
  const realToday = getRealTodayStr();
  const realTomorrow = getRealTomorrowStr();

  // Determine correct day reference for the message
  let dayText;
  if (lessonDate === realToday) {
    dayText = '*×”×™×•×*';
  } else if (lessonDate === realTomorrow) {
    dayText = '*××—×¨*';
  } else {
    dayText = `×‘${formatDateHeb(lessonDate)}`;
  }

  let m = `×”×™×™ ${sName} ğŸ‘‹\n\n×ª×–×›×•×¨×ª ×œ×©×™×¢×•×¨ × ×”×™×’×” ${dayText}:\nğŸ• ${time}\nâ±ï¸ ${dur} ×“×§×•×ª\n`;
  if(addr) m += `ğŸ“ ${addr}\n`;
  m += `\n×××©×¨/×ª? ğŸš—`;
  return m;
}

// Send reminder for specific lesson
function sendTomorrowReminder(lid) {
  const l = lessons.find(x=>x.id===lid); if(!l) return;
  const s = students.find(x=>x.id===l.studentId); if(!s) return;
  const msg = buildReminderMsg(s.name, l.date, l.time, l.duration, l.address);
  window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`,'_blank');
}

// Send reminders to all students with lessons tomorrow (opens one by one with delay)
function sendAllTomorrowReminders() {
  const tmrw = tomorrowStr();
  const tmrwLessons = lessons.filter(l=>l.date===tmrw).sort((a,b)=>a.time.localeCompare(b.time));
  if(tmrwLessons.length===0) { showToast('××™×Ÿ ×©×™×¢×•×¨×™× ××—×¨'); return; }
  const popupWarning = tmrwLessons.length > 3 ? '\n\nâš ï¸ ×©×™× ×œ×‘: ×× ×—×œ×•× ×•×ª ×œ× × ×¤×ª×—×™×, ×™×© ×œ××©×¨ pop-ups ×‘×“×¤×“×¤×Ÿ.' : '';
  if(!confirm(`×œ×©×œ×•×— ×ª×–×›×•×¨×ª ×œ-${tmrwLessons.length} ×ª×œ××™×“×™×?${popupWarning}`)) return;

  let i = 0;
  function sendNext() {
    if(i >= tmrwLessons.length) { showToast(`âœ… × ×©×œ×—×• ${tmrwLessons.length} ×ª×–×›×•×¨×•×ª`); return; }
    const l = tmrwLessons[i];
    const s = students.find(x=>x.id===l.studentId);
    if(s) {
      const msg = buildReminderMsg(s.name, l.date, l.time, l.duration, l.address);
      window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`,'_blank');
    }
    i++;
    if(i < tmrwLessons.length) setTimeout(sendNext, 800);
    else showToast(`âœ… × ×©×œ×—×• ${tmrwLessons.length} ×ª×–×›×•×¨×•×ª`);
  }
  sendNext();
}
function updateWaPreview() {
  const sid=document.getElementById('lessonStudent').value, d=document.getElementById('lessonDate').value, t=document.getElementById('lessonTime').value, dur=document.getElementById('lessonDuration').value, addr=document.getElementById('lessonAddress').value.trim();
  if(sid&&d&&t) {
    const s=students.find(x=>x.id===sid);
    if(s){ document.getElementById('waPreviewText').textContent=buildWaMsg(s.name,d,t,dur,addr); document.getElementById('waPreviewSection').style.display='block'; }
  }
}

function saveLesson(withWa) {
  const sid=document.getElementById('lessonStudent').value, d=document.getElementById('lessonDate').value, t=document.getElementById('lessonTime').value;
  const dur=document.getElementById('lessonDuration').value, addr=document.getElementById('lessonAddress').value.trim();
  if(!sid||!d||!t){ showToast('âš ï¸ × × ×œ××œ× ×ª×œ××™×“, ×ª××¨×™×š ×•×©×¢×”'); return; }

  // Validate not in the past (only for new lessons)
  const now = new Date();
  const today = todayStr();
  if(!editingLessonId) {
    if(d < today) { showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×©×™×¢×•×¨ ×‘×ª××¨×™×š ×©×¢×‘×¨'); return; }
    if(d === today) {
      const [hh, mm] = t.split(':').map(Number);
      const lessonTime = hh * 60 + mm;
      const currentTime = now.getHours() * 60 + now.getMinutes();
      if(lessonTime < currentTime) { showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×©×™×¢×•×¨ ×‘×©×¢×” ×©×¢×‘×¨×”'); return; }
    }
  }

  // Check for conflicting lessons (same time slot)
  const [newH, newM] = t.split(':').map(Number);
  const newStart = newH * 60 + newM;
  const newEnd = newStart + parseInt(dur);
  const conflict = lessons.find(l => {
    if(l.id === editingLessonId) return false; // Skip self when editing
    if(l.date !== d) return false;
    const [lh, lm] = l.time.split(':').map(Number);
    const lStart = lh * 60 + lm;
    const lEnd = lStart + (l.duration || 40);
    return (newStart < lEnd && newEnd > lStart); // overlapping
  });
  if(conflict) {
    showToast(`âš ï¸ ×™×© ×›×‘×¨ ×©×™×¢×•×¨ ×‘-${conflict.time} ×¢× ${conflict.studentName}`);
    return;
  }

  const s = students.find(x=>x.id===sid);
  if(!s){ showToast('âš ï¸ ×ª×œ××™×“ ×œ× × ××¦×'); return; }

  if(editingLessonId) {
    // Update existing lesson
    const lesson = lessons.find(l => l.id === editingLessonId);
    if(lesson) {
      lesson.studentId = sid;
      lesson.studentName = s.name;
      lesson.date = d;
      lesson.time = t;
      lesson.duration = parseInt(dur);
      lesson.address = addr;
      // Keep original priceAtTime - don't update it
    }
    if(!saveData()) return; // Stop if save failed
    closeModal('modalNewLesson');
    showToast('âœ… ×©×™×¢×•×¨ ×¢×•×“×›×Ÿ');
    renderAll();
    editingLessonId = null;
  } else {
    // Create new lesson with price stored at creation time
    lessons.push({
      id: genId(),
      studentId: sid,
      studentName: s.name,
      date: d,
      time: t,
      duration: parseInt(dur),
      address: addr,
      priceAtTime: s.price || 0, // Store current price for accurate billing
      status: 'scheduled', // Will be 'completed' after lesson happens
      createdAt: new Date().toISOString()
    });
    if(!saveData()) return; // Stop if save failed
    closeModal('modalNewLesson');
    showToast('âœ… ×©×™×¢×•×¨ × ×§×‘×¢');
    renderAll();
  }

  if(withWa) {
    const msg = buildWaMsg(s.name,d,t,dur,addr);
    setTimeout(()=>window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`,'_blank'),400);
  }
}

function sendLessonWa(lid) {
  const l=lessons.find(x=>x.id===lid); if(!l)return;
  const s=students.find(x=>x.id===l.studentId); if(!s)return;
  const msg=buildWaMsg(s.name,l.date,l.time,l.duration,l.address);
  window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`,'_blank');
}
function deleteLesson(lid) {
  if(!confirm('×œ××—×•×§ ××ª ×”×©×™×¢×•×¨?'))return;
  const lesson = lessons.find(l=>l.id===lid);
  if(!lesson) return;

  // Save lesson details before deleting
  const deletedLesson = { ...lesson };

  // Delete the lesson (no need to update lessonsDone - calculated dynamically)
  lessons=lessons.filter(l=>l.id!==lid);
  if(!saveData()) return; // Stop if save failed
  showToast('ğŸ—‘ï¸ ×©×™×¢×•×¨ × ××—×§');
  renderAll();

  // Check if there are students who want extra lessons and don't have a lesson on this date
  const studentsWantingExtra = students.filter(st =>
    st.wantsExtraLessons &&
    st.id !== deletedLesson.studentId && // Not the student whose lesson was deleted
    !lessons.some(l => l.studentId === st.id && l.date === deletedLesson.date) // No lesson on this date
  );

  if(studentsWantingExtra.length > 0) {
    offerSlotNotification(deletedLesson, studentsWantingExtra);
  }
}

// Offer to send notification about available slot
function offerSlotNotification(lesson, eligibleStudents) {
  const count = eligibleStudents.length;
  const popupWarning = count > 3 ? '\n\nâš ï¸ ×©×™× ×œ×‘: ×× ×—×œ×•× ×•×ª ×œ× × ×¤×ª×—×™×, ×™×© ×œ××©×¨ pop-ups ×‘×“×¤×“×¤×Ÿ.' : '';
  if(!confirm(`×”×ª×¤× ×” ××§×•× ×‘×™×•××Ÿ!\n\n×™×© ${count} ×ª×œ××™×“×™× ×©××—×¤×©×™× ×©×¢×•×ª ×•×¤× ×•×™×™× ×‘×ª××¨×™×š ×–×”.\n\n×œ×©×œ×•×— ×œ×”× ×”×•×“×¢×”?${popupWarning}`)) return;

  const msg = buildSlotAvailableMsg(lesson.date, lesson.time, lesson.duration, lesson.address);

  let i = 0;
  function sendNext() {
    if(i >= eligibleStudents.length) {
      showToast(`âœ… × ×©×œ×—×• ${eligibleStudents.length} ×”×•×“×¢×•×ª`);
      return;
    }
    const st = eligibleStudents[i];
    window.open(`https://wa.me/${formatPhone(st.phone)}?text=${encodeURIComponent(msg)}`,'_blank');
    i++;
    if(i < eligibleStudents.length) setTimeout(sendNext, 800);
    else showToast(`âœ… × ×©×œ×—×• ${eligibleStudents.length} ×”×•×“×¢×•×ª`);
  }
  sendNext();
}

// Build message for available slot
function buildSlotAvailableMsg(date, time, dur, addr) {
  let m = `×”×™×™! ğŸ‘‹\n\n×”×ª×¤× ×” ××§×•× ×œ×©×™×¢×•×¨ × ×”×™×’×”:\nğŸ“… ${formatDateHeb(date)}\nğŸ• ${time}\nâ±ï¸ ${dur} ×“×§×•×ª\n`;
  if(addr) m += `ğŸ“ ${addr}\n`;
  m += `\n××ª××™× ×œ×š? ğŸš—`;
  return m;
}

// ---- PAYMENT ----
function openPaymentModal(prefillStudentId) {
  populateStudentSelect('payStudent', prefillStudentId);
  document.getElementById('payAmount').value = '';
  document.getElementById('payMethod').value = '××–×•××Ÿ';
  document.getElementById('payDate').value = todayStr();
  document.getElementById('payNote').value = '';
  if(prefillStudentId) {
    const s=students.find(x=>x.id===prefillStudentId);
    if(s) document.getElementById('payAmount').value = s.price||'';
  }
  openModal('modalPayment');
}
function savePayment() {
  const sid=document.getElementById('payStudent').value;
  const amount=parseFloat(document.getElementById('payAmount').value);
  const method=document.getElementById('payMethod').value;
  const date=document.getElementById('payDate').value;
  const note=document.getElementById('payNote').value.trim();

  // Validation
  if(!sid){ showToast('âš ï¸ × × ×œ×‘×—×•×¨ ×ª×œ××™×“'); return; }
  if(!amount || isNaN(amount)){ showToast('âš ï¸ × × ×œ×”×–×™×Ÿ ×¡×›×•×'); return; }
  if(amount <= 0){ showToast('âš ï¸ ×¡×›×•× ×—×™×™×‘ ×œ×”×™×•×ª ×—×™×•×‘×™'); return; }
  if(amount > 50000){ showToast('âš ï¸ ×¡×›×•× ×—×¨×™×’ - ×‘×“×•×§ ×©×•×‘'); return; }
  if(!date){ showToast('âš ï¸ × × ×œ×‘×—×•×¨ ×ª××¨×™×š'); return; }

  const s=students.find(x=>x.id===sid);
  if(!s){ showToast('âš ï¸ ×ª×œ××™×“ ×œ× × ××¦×'); return; }

  payments.push({ id:genId(), studentId:sid, studentName:s.name, amount, method, date, note, createdAt:new Date().toISOString() });
  if(!saveData()) return; // Stop if save failed
  closeModal('modalPayment');
  showToast('âœ… ×ª×©×œ×•× × ×¨×©×');
  renderAll();
}

function deletePayment(pid) {
  if(!confirm('×œ××—×•×§ ××ª ×”×ª×©×œ×•×?')) return;
  payments = payments.filter(p => p.id !== pid);
  if(!saveData()) return; // Stop if save failed
  showToast('ğŸ—‘ï¸ ×ª×©×œ×•× × ××—×§');
  renderAll();
}

// ---- SEND DEBT REMINDER WA ----
function sendDebtWa(sid) {
  const s=students.find(x=>x.id===sid); if(!s)return;
  const bal = getStudentBalance(s);
  const debt = Math.abs(bal);
  const msg = `×©×œ×•× ${s.name} ğŸ‘‹\n×¨×¦×™×ª×™ ×œ×¢×“×›×Ÿ ×©×™×© ×™×ª×¨×ª ×—×•×‘ ×¤×ª×•×—×” ×©×œ ${fmtMoney(debt)} â‚ª.\n××©××— ×œ×¡×’×•×¨ ×›×©× ×•×— ×œ×š ğŸ™\n×ª×•×“×”!`;
  window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`,'_blank');
}

// ---- STUDENT DETAIL ----
function deleteStudent(sid) {
  const s=students.find(x=>x.id===sid);
  if(!s) return;

  // Check for future lessons
  const today = todayStr();
  const futureLessons = lessons.filter(l => l.studentId === sid && l.date >= today);

  let confirmMsg = `×œ××—×•×§ ××ª ${s.name}? ×›×œ ×”×©×™×¢×•×¨×™× ×•×”×ª×©×œ×•××™× ×©×œ×• ×™×™××—×§×• ×’×.`;
  if(futureLessons.length > 0) {
    confirmMsg += `\n\nâš ï¸ ×œ×ª×œ××™×“ ×™×© ${futureLessons.length} ×©×™×¢×•×¨×™× ×¢×ª×™×“×™×™× ×©×™×™××—×§×•!`;
  }
  if(!confirm(confirmMsg)) return;

  // Save future lessons data before deleting
  const deletedLessons = [...futureLessons];

  students=students.filter(x=>x.id!==sid);
  lessons=lessons.filter(l=>l.studentId!==sid);
  payments=payments.filter(p=>p.studentId!==sid);
  if(!saveData()) return; // Stop if save failed
  closeModal('modalStudentDetail');
  showToast('ğŸ—‘ï¸ ×ª×œ××™×“ × ××—×§');
  renderAll();

  // Offer to notify about available slots
  if(deletedLessons.length > 0) {
    const studentsWantingExtra = students.filter(st => st.wantsExtraLessons);
    if(studentsWantingExtra.length > 0 && confirm(`×”×ª×¤× ×• ${deletedLessons.length} ××§×•××•×ª ×‘×™×•××Ÿ.\n\n×œ×©×œ×•×— ×”×•×“×¢×” ×œ-${studentsWantingExtra.length} ×ª×œ××™×“×™× ×©××—×¤×©×™× ×©×¢×•×ª?`)) {
      // Notify about the first available slot
      offerSlotNotification(deletedLessons[0], studentsWantingExtra);
    }
  }
}
function openStudentDetail(sid) {
  const s=students.find(x=>x.id===sid); if(!s)return;
  document.getElementById('detailStudentTitle').innerHTML=`ğŸ‘¤ ${escHtml(s.name)}`;
  const sLessons=lessons.filter(l=>l.studentId===sid).sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time));
  const sPayments=payments.filter(p=>p.studentId===sid).sort((a,b)=>b.date.localeCompare(a.date));
  const bal=getStudentBalance(s);
  const totalPaid=sPayments.reduce((sum,p)=>sum+p.amount,0);
  const completedCount = getCompletedLessonsCount(s);
  const balColor = bal < 0 ? 'red' : 'accent';

  let h = `
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:14px;">
      <div class="student-avatar" style="width:50px;height:50px;font-size:20px;">${getInitials(s.name)}</div>
      <div>
        <div style="font-size:17px;font-weight:700;">${escHtml(s.name)}</div>
        <div style="font-size:13px;color:var(--text-dim);direction:ltr;text-align:right;">${escHtml(s.phone)}</div>
      </div>
    </div>
    <div class="stats-bar four">
      <div class="stat-card"><div class="stat-number">${completedCount}</div><div class="stat-label">×‘×•×¦×¢×•</div></div>
      <div class="stat-card"><div class="stat-number">${Math.max(0,28-completedCount)}</div><div class="stat-label">× ×•×ª×¨×•</div></div>
      <div class="stat-card"><div class="stat-number">${fmtMoney(totalPaid)}</div><div class="stat-label">×©×•×œ× â‚ª</div></div>
      <div class="stat-card"><div class="stat-number ${balColor}">${bal<0?fmtMoney(Math.abs(bal)):bal>0?fmtMoney(bal):'0'}</div><div class="stat-label">${bal<0?'×—×•×‘ â‚ª':bal>0?'×–×›×•×ª â‚ª':'×××•×–×Ÿ'}</div></div>
    </div>`;
  if(s.notes) h += `<div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">ğŸ“ ${escHtml(s.notes)}</div>`;
  if(s.wantsExtraLessons) h += `<div style="font-size:12px;color:var(--blue);margin-bottom:12px;">ğŸ”” ××—×¤×© ×©×¢×•×ª × ×•×¡×¤×•×ª</div>`;

  h += `<div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">
    <button class="btn btn-whatsapp btn-sm" style="flex:1;min-width:45%;" onclick="window.open('https://wa.me/${formatPhone(s.phone)}','_blank')">ğŸ’¬ ×•×•××˜×¡××¤</button>
    <button class="btn btn-primary btn-sm" style="flex:1;min-width:45%;" onclick="paymentFromDetail('${s.id}')">ğŸ’³ ×ª×©×œ×•×</button>
    <button class="btn btn-outline btn-sm" style="flex:1;min-width:45%;" onclick="editStudentFromDetail('${s.id}')">âœï¸ ×¢×¨×™×›×”</button>
    ${bal<0?`<button class="btn btn-outline btn-sm" style="flex:1;min-width:45%;border-color:var(--warning);color:var(--warning);" onclick="sendDebtWa('${s.id}')">âš ï¸ ×ª×–×›×•×¨×ª ×—×•×‘</button>`:''}
  </div>`;

  if(sPayments.length>0) {
    h += `<div class="section-title">×ª×©×œ×•××™×</div>`;
    sPayments.slice(0,10).forEach(p=>{
      h += `<div class="payment-item">
        <div class="payment-amount income">+${fmtMoney(p.amount)}</div>
        <div class="payment-info">
          <div class="payment-name">${escHtml(p.method)}</div>
          <div class="payment-meta">${formatDateHeb(p.date)}${p.note?' Â· '+escHtml(p.note):''}</div>
        </div>
        <button class="icon-btn" onclick="event.stopPropagation();deletePayment('${p.id}')" title="××—×™×§×”" style="color:var(--danger);">ğŸ—‘ï¸</button>
      </div>`;
    });
  }
  if(sLessons.length>0) {
    h += `<div class="section-title" style="margin-top:14px;">×©×™×¢×•×¨×™× ××—×¨×•× ×™×</div>`;
    sLessons.slice(0,8).forEach(l=>{
      h += `<div class="lesson-item" style="padding:8px 10px;">
        <div class="lesson-time" style="min-width:50px;padding:5px 7px;"><div class="lesson-hour" style="font-size:14px;">${l.time}</div></div>
        <div class="lesson-details"><div style="font-size:13px;font-weight:500;">${formatDateHeb(l.date)}</div><div style="font-size:11px;color:var(--text-dim);">${l.duration} ×“×§×³${l.address?' Â· '+escHtml(l.address):''}</div></div>
        <button class="icon-btn" onclick="closeModal('modalStudentDetail');openEditLessonModal('${l.id}')" title="×¢×¨×™×›×”" style="margin-right:auto;">âœï¸</button>
      </div>`;
    });
  }
  h += `<button class="btn-danger-outline" style="margin-top:14px;width:100%;" onclick="deleteStudent('${s.id}')">ğŸ—‘ï¸ ××—×™×§×ª ×ª×œ××™×“</button>`;
  document.getElementById('detailStudentContent').innerHTML=h;
  openModal('modalStudentDetail');
}

// ============================================================
// CALENDAR
// ============================================================
let calWeekStart = getWeekStart(new Date());

function getWeekStart(d) {
  const r = new Date(d);
  r.setDate(r.getDate() - r.getDay());
  r.setHours(0,0,0,0);
  return r;
}
function calPrev() { calWeekStart = new Date(calWeekStart); calWeekStart.setDate(calWeekStart.getDate()-7); renderCalendar(); }
function calNext() { calWeekStart = new Date(calWeekStart); calWeekStart.setDate(calWeekStart.getDate()+7); renderCalendar(); }
function calToday() { calWeekStart = getWeekStart(new Date()); renderCalendar(); }

function renderCalendar() {
  const START_HOUR = 7, END_HOUR = 21;
  const days = [];
  for(let i=0;i<7;i++) {
    const d = new Date(calWeekStart);
    d.setDate(d.getDate()+i);
    days.push(d);
  }

  // Title
  const m1 = MONTHS_HEB[days[0].getMonth()], m2 = MONTHS_HEB[days[6].getMonth()];
  document.getElementById('calTitle').textContent = m1===m2 ? `${days[0].getDate()}â€“${days[6].getDate()} ${m1}` : `${days[0].getDate()} ${m1} â€“ ${days[6].getDate()} ${m2}`;

  // Header
  const todayD = todayStr();
  let hdr = '<div></div>';
  days.forEach(d => {
    const ds = dateStr(d);
    const isTd = ds===todayD;
    hdr += `<div class="cal-day-label ${isTd?'today':''}"><span class="cal-day-num">${d.getDate()}</span>${DAYS_SHORT[d.getDay()]}</div>`;
  });
  document.getElementById('calWeekHeader').innerHTML = hdr;

  // Body
  let body = '';
  for(let h=START_HOUR; h<END_HOUR; h++) {
    body += `<div class="cal-hour-label">${String(h).padStart(2,'0')}:00</div>`;
    days.forEach(d => {
      const ds = dateStr(d);
      const isTd = ds===todayD;
      body += `<div class="cal-cell ${isTd?'today-col':''}" data-date="${ds}" data-hour="${h}" onclick="onCalCellClick('${ds}','${String(h).padStart(2,'0')}:00')"></div>`;
    });
  }
  document.getElementById('calBody').innerHTML = body;

  // Place events - group by day to handle overlaps
  const eventsByDay = {};
  lessons.forEach(l => {
    const [lh,lm] = l.time.split(':').map(Number);
    if(lh < START_HOUR || lh >= END_HOUR) return;
    const dayIdx = days.findIndex(d => dateStr(d) === l.date);
    if(dayIdx < 0) return;
    if(!eventsByDay[dayIdx]) eventsByDay[dayIdx] = [];
    eventsByDay[dayIdx].push({ lesson: l, startMin: lh*60+lm, endMin: lh*60+lm+(l.duration||40) });
  });

  Object.keys(eventsByDay).forEach(dayIdx => {
    const evts = eventsByDay[dayIdx].sort((a,b)=>a.startMin-b.startMin);
    evts.forEach((evt,i) => {
      const l = evt.lesson;
      const [lh,lm] = l.time.split(':').map(Number);
      const cellIdx = (lh - START_HOUR) * 8 + 1 + parseInt(dayIdx);
      const cells = document.getElementById('calBody').children;
      if(!cells[cellIdx]) return;
      const cell = cells[cellIdx];

      // Count overlaps before this event
      let overlapIdx = 0;
      for(let j=0;j<i;j++) {
        if(evts[j].startMin < evt.endMin && evts[j].endMin > evt.startMin) overlapIdx++;
      }

      const durSlots = (l.duration||40) / 60;
      const topPx = (lm / 60) * 48;
      const heightPx = Math.max(durSlots * 48, 22);

      const ev = document.createElement('div');
      ev.className = 'cal-event';
      ev.style.top = topPx + 'px';
      ev.style.height = heightPx + 'px';
      if(overlapIdx > 0) {
        ev.style.right = (2 + overlapIdx * 20) + 'px';
        ev.style.opacity = '0.9';
        ev.style.borderRight = '2px solid #000';
      }
      ev.innerHTML = `<div>${escHtml(l.studentName)}</div><div class="ev-time">${l.time}</div>`;
      ev.onclick = (e) => { e.stopPropagation(); openEditLessonModal(l.id); };
      ev.title = `${l.studentName} - ${l.time} (×œ×—×¥ ×œ×¢×¨×™×›×”)`;
      cell.appendChild(ev);
    });
  });
}

function onCalCellClick(date, time) {
  const today = todayStr();
  if(date < today) { showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×©×™×¢×•×¨ ×‘×ª××¨×™×š ×©×¢×‘×¨'); return; }
  if(date === today) {
    const now = new Date();
    const [hh, mm] = time.split(':').map(Number);
    const clickedTime = hh * 60 + mm;
    const currentTime = now.getHours() * 60 + now.getMinutes();
    if(clickedTime < currentTime) { showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×©×™×¢×•×¨ ×‘×©×¢×” ×©×¢×‘×¨×”'); return; }
  }
  openNewLessonModal(date, time);
}

// ============================================================
// FINANCE
// ============================================================
let finMonth = new Date().getMonth();
let finYear = new Date().getFullYear();
let finDateFrom = '';
let finDateTo = '';

function finPrev() {
  clearDateFilter(true); // Clear filter silently
  finMonth--;
  if(finMonth<0){finMonth=11;finYear--;}
  renderFinance();
}
function finNext() {
  clearDateFilter(true); // Clear filter silently
  finMonth++;
  if(finMonth>11){finMonth=0;finYear++;}
  renderFinance();
}

function applyDateFilter() {
  finDateFrom = document.getElementById('finDateFrom').value;
  finDateTo = document.getElementById('finDateTo').value;
  renderFinance();
}

function clearDateFilter(silent) {
  finDateFrom = '';
  finDateTo = '';
  const fromEl = document.getElementById('finDateFrom');
  const toEl = document.getElementById('finDateTo');
  if(fromEl) fromEl.value = '';
  if(toEl) toEl.value = '';
  if(!silent) renderFinance();
}

function renderFinance() {
  let mPayments, mLessons;
  const labelEl = document.getElementById('finMonthLabel');

  // Check if date range filter is active
  if(finDateFrom || finDateTo) {
    const from = finDateFrom || '1900-01-01';
    const to = finDateTo || '2999-12-31';
    mPayments = payments.filter(p => p.date >= from && p.date <= to);
    mLessons = lessons.filter(l => l.date >= from && l.date <= to);

    // Show date range in label
    const fromDisplay = finDateFrom ? new Date(finDateFrom+'T00:00:00').toLocaleDateString('he-IL') : '×”×ª×—×œ×”';
    const toDisplay = finDateTo ? new Date(finDateTo+'T00:00:00').toLocaleDateString('he-IL') : '×¡×•×£';
    labelEl.innerHTML = `<span style="font-size:12px;">ğŸ“… ${fromDisplay} â€” ${toDisplay}</span>`;
  } else {
    // Default: filter by month
    const mStr = `${finYear}-${String(finMonth+1).padStart(2,'0')}`;
    mPayments = payments.filter(p => p.date.startsWith(mStr));
    mLessons = lessons.filter(l => l.date.startsWith(mStr));
    labelEl.textContent = `${MONTHS_HEB[finMonth]} ${finYear}`;
  }
  const totalIncome = mPayments.reduce((s,p)=>s+p.amount,0);
  const totalLessons = mLessons.length;
  const expectedIncome = mLessons.reduce((s,l)=>{
    const st = students.find(x=>x.id===l.studentId);
    return s + (st?.price||0);
  },0);

  // Debts
  const studentsWithDebt = students.filter(s=>getStudentBalance(s)<0).sort((a,b)=>getStudentBalance(a)-getStudentBalance(b));
  const totalDebt = studentsWithDebt.reduce((s,st)=>s+Math.abs(getStudentBalance(st)),0);

  document.getElementById('finStats').innerHTML = `
    <div class="stat-card"><div class="stat-number">${fmtMoney(totalIncome)}</div><div class="stat-label">×”×›× ×¡×•×ª â‚ª</div></div>
    <div class="stat-card"><div class="stat-number blue">${totalLessons}</div><div class="stat-label">×©×™×¢×•×¨×™×</div></div>
    <div class="stat-card"><div class="stat-number yellow">${fmtMoney(expectedIncome)}</div><div class="stat-label">×¦×¤×•×™ â‚ª</div></div>
    <div class="stat-card"><div class="stat-number red">${fmtMoney(totalDebt)}</div><div class="stat-label">×—×•×‘×•×ª â‚ª</div></div>
  `;

  // Debt list
  const debtC = document.getElementById('debtList');
  if(studentsWithDebt.length===0) {
    debtC.innerHTML = '<div style="text-align:center;padding:16px;font-size:13px;color:var(--text-muted);">ğŸ‰ ××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™×!</div>';
  } else {
    let dh = '';
    studentsWithDebt.forEach(s => {
      const debt = Math.abs(getStudentBalance(s));
      const completedCount = getCompletedLessonsCount(s);
      dh += `<div class="debt-student" onclick="openStudentDetail('${s.id}')">
        <div class="student-avatar" style="width:36px;height:36px;font-size:13px;">${escHtml(getInitials(s.name))}</div>
        <div class="debt-info"><div class="debt-name">${escHtml(s.name)}</div><div class="debt-detail">${completedCount} ×©×™×¢×•×¨×™×</div></div>
        <div class="debt-amount">${fmtMoney(debt)} â‚ª</div>
        <button class="icon-btn wa" onclick="event.stopPropagation();sendDebtWa('${s.id}')" title="×ª×–×›×•×¨×ª ×—×•×‘">ğŸ’¬</button>
      </div>`;
    });
    debtC.innerHTML = dh;
  }

  // Recent payments
  const payC = document.getElementById('paymentsList');
  const recent = mPayments.sort((a,b)=>b.date.localeCompare(a.date));
  if(recent.length===0) {
    payC.innerHTML = `<div style="text-align:center;padding:16px;font-size:13px;color:var(--text-muted);">××™×Ÿ ×ª×©×œ×•××™× ×”×—×•×“×©</div>
      <button class="btn btn-primary" style="margin-top:8px;" onclick="openPaymentModal()">ğŸ’³ ×¨×™×©×•× ×ª×©×œ×•×</button>`;
  } else {
    let ph = '';
    recent.forEach(p => {
      ph += `<div class="payment-item">
        <div class="payment-amount income">+${fmtMoney(p.amount)}</div>
        <div class="payment-info">
          <div class="payment-name">${escHtml(p.studentName)}</div>
          <div class="payment-meta">${formatDateHeb(p.date)} Â· ${escHtml(p.method)}${p.note?' Â· '+escHtml(p.note):''}</div>
        </div>
        <button class="icon-btn" onclick="deletePayment('${p.id}')" title="××—×™×§×”" style="color:var(--danger);">ğŸ—‘ï¸</button>
      </div>`;
    });
    ph += `<button class="btn btn-primary" style="margin-top:10px;" onclick="openPaymentModal()">ğŸ’³ ×¨×™×©×•× ×ª×©×œ×•×</button>`;
    payC.innerHTML = ph;
  }
}

// ============================================================
// RENDER
// ============================================================
function renderAll() {
  renderDashboard();
  renderCalendar();
  renderStudents();
  renderFinance();
  renderVehiclePage();
  updateHeader();
}

function updateHeader() {
  const n = getWorkingDate();
  document.getElementById('headerDate').textContent = `×™×•× ${DAYS_HEB[n.getDay()]}, ${n.getDate()} ${MONTHS_HEB[n.getMonth()]} ${n.getFullYear()}`;
}

function renderDashboard() {
  const td = todayStr();
  document.getElementById('statStudents').textContent = students.length;
  document.getElementById('statLessonsToday').textContent = lessons.filter(l=>l.date===td).length;

  const totalDebt = students.filter(s=>getStudentBalance(s)<0).reduce((sum,s)=>sum+Math.abs(getStudentBalance(s)),0);
  const debtEl = document.getElementById('statDebtTotal');
  debtEl.textContent = fmtMoney(totalDebt);
  debtEl.className = totalDebt > 0 ? 'stat-number red' : 'stat-number';

  // Upcoming
  const upcoming = lessons.filter(l=>l.date>=td).sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time)).slice(0,5);
  const uc = document.getElementById('upcomingLessons');
  if(upcoming.length===0) {
    uc.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-text">××™×Ÿ ×©×™×¢×•×¨×™× ×§×¨×•×‘×™×</div><div class="empty-sub">×œ×—×¥ ×œ××˜×” ×›×“×™ ×œ×§×‘×•×¢ ×©×™×¢×•×¨</div></div>';
  } else {
    let h='';
    upcoming.forEach(l => {
      const tBadge = isToday(l.date)?'<span class="badge badge-green">×”×™×•×</span>':'';
      h += `<div class="lesson-item"><div class="lesson-time"><div class="lesson-hour">${l.time}</div><div class="lesson-date-small">${l.date.slice(5).replace('-','/')}</div></div><div class="lesson-details"><div class="lesson-student-name">${escHtml(l.studentName)} ${tBadge}</div><div class="lesson-info">${l.duration} ×“×§×³${l.address?' Â· ğŸ“ '+escHtml(l.address):''}</div></div><div class="lesson-actions"><button class="icon-btn" onclick="openEditLessonModal('${l.id}')" title="×¢×¨×™×›×”">âœï¸</button><button class="icon-btn wa" onclick="sendLessonWa('${l.id}')" title="×•×•××˜×¡××¤">ğŸ’¬</button><button class="icon-btn" onclick="deleteLesson('${l.id}')" title="××—×™×§×”" style="color:var(--danger);">âœ•</button></div></div>`;
    });
    uc.innerHTML = h;
  }

  // Tomorrow's lessons section
  const tmrw = tomorrowStr();
  const tmrwLessons = lessons.filter(l=>l.date===tmrw).sort((a,b)=>a.time.localeCompare(b.time));
  const tlc = document.getElementById('tomorrowLessons');
  if(tmrwLessons.length > 0) {
    let tlh = `<div class="section-title">ğŸ“… ×©×™×¢×•×¨×™× ××—×¨ (${tmrwLessons.length})</div>`;
    tmrwLessons.forEach(l => {
      tlh += `<div class="lesson-item">
        <div class="lesson-time"><div class="lesson-hour">${l.time}</div><div class="lesson-date-small">${l.duration} ×“×§×³</div></div>
        <div class="lesson-details">
          <div class="lesson-student-name">${escHtml(l.studentName)}</div>
          <div class="lesson-info">${l.address ? 'ğŸ“ '+escHtml(l.address) : ''}</div>
        </div>
        <div class="lesson-actions">
          <button class="icon-btn" onclick="openEditLessonModal('${l.id}')" title="×¢×¨×™×›×”">âœï¸</button>
          <button class="icon-btn wa" onclick="sendTomorrowReminder('${l.id}')" title="×©×œ×™×—×ª ×ª×–×›×•×¨×ª">ğŸ’¬</button>
        </div>
      </div>`;
    });
    tlh += `<button class="btn btn-whatsapp" style="margin-top:10px;" onclick="sendAllTomorrowReminders()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      ğŸ“¨ ×©×œ×— ×ª×–×›×•×¨×ª ×œ×›×•×œ×
    </button>`;
    tlc.innerHTML = tlh;
  } else {
    tlc.innerHTML = '';
  }

  // Debt alerts on dashboard
  const debtStudents = students.filter(s=>getStudentBalance(s)<-300).sort((a,b)=>getStudentBalance(a)-getStudentBalance(b)).slice(0,3);
  const da = document.getElementById('debtAlerts');
  if(debtStudents.length>0) {
    let dh = '<div class="section-title" style="margin-top:0;">âš ï¸ ×—×•×‘×•×ª ×©×“×•×¨×©×™× ×˜×™×¤×•×œ</div>';
    debtStudents.forEach(s => {
      const debt=Math.abs(getStudentBalance(s));
      const completedCount = getCompletedLessonsCount(s);
      dh += `<div class="debt-student" onclick="openStudentDetail('${s.id}')"><div class="student-avatar" style="width:34px;height:34px;font-size:12px;background:linear-gradient(135deg,var(--warning),#d97706);">${escHtml(getInitials(s.name))}</div><div class="debt-info"><div class="debt-name">${escHtml(s.name)}</div><div class="debt-detail">${completedCount} ×©×™×¢×•×¨×™× ×œ×œ× ×ª×©×œ×•× ××œ×</div></div><div class="debt-amount" style="font-size:16px;">${fmtMoney(debt)} â‚ª</div></div>`;
    });
    da.innerHTML = dh;
  } else {
    da.innerHTML = '';
  }
}

function renderStudents() {
  const search = (document.getElementById('studentSearch')?.value||'').trim().toLowerCase();
  const filtered = students.filter(s=>!search||s.name.toLowerCase().includes(search)||s.phone.includes(search));
  const c = document.getElementById('studentsList');
  if(students.length===0){ c.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ‘¤</div><div class="empty-text">×¢×“×™×™×Ÿ ××™×Ÿ ×ª×œ××™×“×™×</div></div>'; return; }
  if(filtered.length===0){ c.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ”</div><div class="empty-text">×œ× × ××¦××• ×ª×•×¦××•×ª</div></div>'; return; }
  let h='';
  filtered.forEach(s => {
    const completedCount = getCompletedLessonsCount(s);
    const rem=Math.max(0,28-completedCount);
    const bal=getStudentBalance(s);
    const lessonBadge = rem<=5?'badge-green':'badge-yellow';
    const debtBadge = bal<0?`<span class="badge badge-red">×—×•×‘ ${fmtMoney(Math.abs(bal))} â‚ª</span>`:'';
    const extraBadge = s.wantsExtraLessons?`<span class="badge badge-blue">ğŸ”” ××—×¤×© ×©×¢×•×ª</span>`:'';
    h += `<div class="student-item" onclick="openStudentDetail('${s.id}')"><div class="student-avatar">${escHtml(getInitials(s.name))}</div><div class="student-info"><div class="student-name">${escHtml(s.name)}</div><div class="student-meta"><span>${completedCount}/28</span><span class="badge ${lessonBadge}">${rem===0?'××•×›×Ÿ!':'× ×•×ª×¨×• '+rem}</span>${debtBadge}${extraBadge}</div></div><div class="student-actions"><button class="icon-btn wa" onclick="event.stopPropagation();window.open('https://wa.me/${formatPhone(s.phone)}','_blank')" title="×•×•××˜×¡××¤">ğŸ’¬</button></div></div>`;
  });
  c.innerHTML=h;
}

// ---- EXPORT / IMPORT ----
function exportData() {
  const data = { students, lessons, payments, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nahag-baseder-backup-${todayStr()}.json`;
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
  localStorage.setItem('drv_last_backup', todayStr());
  showToast('ğŸ“¥ ×’×™×‘×•×™ ×”×•×¨×“ ×‘×”×¦×œ×—×”');
}

function checkBackupReminder() {
  const lastBackup = localStorage.getItem('drv_last_backup');
  const reminderShown = localStorage.getItem('drv_backup_reminder_shown');

  if (!lastBackup) {
    // First time user - only remind once, then mark as shown
    if (students.length > 0 && !reminderShown) {
      localStorage.setItem('drv_backup_reminder_shown', 'true');
      setTimeout(() => {
        if (confirm('ğŸ’¾ ×˜×¨× ×‘×™×¦×¢×ª ×’×™×‘×•×™ ×œ× ×ª×•× ×™× ×©×œ×š.\n\n××•××œ×¥ ×œ×’×‘×•×ª ××ª ×”× ×ª×•× ×™× ×‘××•×¤×Ÿ ×§×‘×•×¢.\n\n×œ×’×‘×•×ª ×¢×›×©×™×•?')) {
          exportData();
        }
      }, 2000);
    }
    return;
  }

  const lastDate = new Date(lastBackup);
  const now = new Date();
  const daysSinceBackup = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));

  if (daysSinceBackup >= 7) {
    setTimeout(() => {
      if (confirm(`ğŸ’¾ ×¢×‘×¨×• ${daysSinceBackup} ×™××™× ×××– ×”×’×™×‘×•×™ ×”××—×¨×•×Ÿ.\n\n××•××œ×¥ ×œ×’×‘×•×ª ××ª ×”× ×ª×•× ×™× ×‘××•×¤×Ÿ ×©×‘×•×¢×™.\n\n×œ×’×‘×•×ª ×¢×›×©×™×•?`)) {
        exportData();
      }
    }, 2000);
  }
}
function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const rawData = JSON.parse(ev.target.result);
        if(!rawData.students || !rawData.lessons || !rawData.payments) {
          showToast('âš ï¸ ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ - ×—×¡×¨×™× ×©×“×•×ª × ×“×¨×©×™×');
          return;
        }

        // Validate and sanitize all imported data
        const validated = validateImportData(rawData);
        if (!validated) {
          showToast('âš ï¸ ×”× ×ª×•× ×™× ×‘×§×•×‘×¥ ×œ× ×ª×§×™× ×™×');
          return;
        }

        // Build confirmation message with skip info
        let confirmMsg = `×œ×™×™×‘× ${validated.students.length} ×ª×œ××™×“×™×, ${validated.lessons.length} ×©×™×¢×•×¨×™× ×•-${validated.payments.length} ×ª×©×œ×•××™×?`;
        const totalSkipped = validated.skipped.students + validated.skipped.lessons + validated.skipped.payments;
        if (totalSkipped > 0) {
          confirmMsg += `\n\nâš ï¸ ${totalSkipped} ×¨×©×•××•×ª ×œ× ×ª×§×™× ×•×ª ×™×“×•×œ×’×•:`;
          if (validated.skipped.students > 0) confirmMsg += `\n- ${validated.skipped.students} ×ª×œ××™×“×™×`;
          if (validated.skipped.lessons > 0) confirmMsg += `\n- ${validated.skipped.lessons} ×©×™×¢×•×¨×™×`;
          if (validated.skipped.payments > 0) confirmMsg += `\n- ${validated.skipped.payments} ×ª×©×œ×•××™×`;
        }
        confirmMsg += '\n\n×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ×™×•×—×œ×¤×•.';

        if(!confirm(confirmMsg)) return;

        students = validated.students;
        lessons = validated.lessons;
        payments = validated.payments;

        if(!saveData()) {
          showToast('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×');
          return;
        }

        showToast('âœ… × ×ª×•× ×™× ×™×•×‘××• ×‘×”×¦×œ×—×”');
        renderAll();
      } catch(err) {
        console.error('Import error:', err);
        showToast('âš ï¸ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// Close modals on Escape key only (not on overlay click)
document.addEventListener('keydown',e=>{
  if(e.key==='Escape') document.querySelectorAll('.modal-overlay.show').forEach(o=>o.classList.remove('show'));
});

// ============================================================
// VEHICLE MANAGEMENT
// ============================================================
let vehicleData;
try {
  vehicleData = JSON.parse(localStorage.getItem('drv_vehicle') || 'null');
} catch(e) {
  vehicleData = null;
}

let kmHistory;
try {
  kmHistory = JSON.parse(localStorage.getItem('drv_km_history') || '[]');
} catch(e) {
  kmHistory = [];
}

function saveVehicleData() {
  try {
    localStorage.setItem('drv_vehicle', JSON.stringify(vehicleData));
    localStorage.setItem('drv_km_history', JSON.stringify(kmHistory));
  } catch(e) {
    showToast('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”');
  }
}

function openVehicleEditModal() {
  if (vehicleData) {
    document.getElementById('vehiclePlate').value = vehicleData.plate || '';
    document.getElementById('vehicleMake').value = vehicleData.make || '';
    document.getElementById('vehicleModel').value = vehicleData.model || '';
    document.getElementById('vehicleYear').value = vehicleData.year || '';
    document.getElementById('vehicleTransmission').value = vehicleData.transmission || '××•×˜×•××˜';
    document.getElementById('vehicleColor').value = vehicleData.color || '';
    document.getElementById('vehicleTestDate').value = vehicleData.testDate || '';
    document.getElementById('vehicleInsuranceDate').value = vehicleData.insuranceDate || '';
    document.getElementById('vehicleFullInsuranceDate').value = vehicleData.fullInsuranceDate || '';
    document.getElementById('vehicleServiceDate').value = vehicleData.serviceDate || '';
  } else {
    document.getElementById('vehiclePlate').value = '';
    document.getElementById('vehicleMake').value = '';
    document.getElementById('vehicleModel').value = '';
    document.getElementById('vehicleYear').value = '';
    document.getElementById('vehicleTransmission').value = '××•×˜×•××˜';
    document.getElementById('vehicleColor').value = '';
    document.getElementById('vehicleTestDate').value = '';
    document.getElementById('vehicleInsuranceDate').value = '';
    document.getElementById('vehicleFullInsuranceDate').value = '';
    document.getElementById('vehicleServiceDate').value = '';
  }
  document.getElementById('modalVehicleEdit').classList.add('show');
}

function saveVehicle() {
  const plate = document.getElementById('vehiclePlate').value.trim();
  if (!plate) {
    showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¨×›×‘');
    return;
  }

  vehicleData = {
    plate: plate,
    make: document.getElementById('vehicleMake').value.trim(),
    model: document.getElementById('vehicleModel').value.trim(),
    year: document.getElementById('vehicleYear').value.trim(),
    transmission: document.getElementById('vehicleTransmission').value,
    color: document.getElementById('vehicleColor').value.trim(),
    testDate: document.getElementById('vehicleTestDate').value,
    insuranceDate: document.getElementById('vehicleInsuranceDate').value,
    fullInsuranceDate: document.getElementById('vehicleFullInsuranceDate').value,
    serviceDate: document.getElementById('vehicleServiceDate').value
  };

  saveVehicleData();
  closeModal('modalVehicleEdit');
  renderVehiclePage();
  showToast('âœ… ×¤×¨×˜×™ ×”×¨×›×‘ × ×©××¨×•');
}

function openKmUpdateModal() {
  document.getElementById('newKmValue').value = '';
  document.getElementById('kmUpdateDate').value = todayStr();
  document.getElementById('modalKmUpdate').classList.add('show');
}

function saveKmUpdate() {
  const km = parseInt(document.getElementById('newKmValue').value);
  const date = document.getElementById('kmUpdateDate').value;

  if (!km || km <= 0) {
    showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×§×™×œ×•××˜×¨××–\' ×ª×§×™×Ÿ');
    return;
  }

  if (!date) {
    showToast('âŒ ×™×© ×œ×‘×—×•×¨ ×ª××¨×™×š');
    return;
  }

  // Validate KM is not lower than previous
  if (kmHistory.length > 0 && km < kmHistory[0].km) {
    showToast('âŒ ×§×™×œ×•××˜×¨××–\' ×œ× ×™×›×•×œ ×œ×”×™×•×ª × ××•×š ××”×¢×¨×š ×”×§×•×“× (' + kmHistory[0].km.toLocaleString() + ')');
    return;
  }

  // Add to history
  kmHistory.unshift({
    km: km,
    date: date,
    timestamp: Date.now()
  });

  // Keep only last 20 entries
  if (kmHistory.length > 20) {
    kmHistory = kmHistory.slice(0, 20);
  }

  saveVehicleData();
  closeModal('modalKmUpdate');
  renderVehiclePage();
  showToast('âœ… ×”×§×™×œ×•××˜×¨××–\' ×¢×•×“×›×Ÿ');
}

function renderVehiclePage() {
  const infoEl = document.getElementById('vehicleInfo');
  const remindersEl = document.getElementById('vehicleReminders');
  const currentKmEl = document.getElementById('currentKm');
  const kmHistoryEl = document.getElementById('kmHistory');

  // Vehicle Info
  if (!vehicleData) {
    infoEl.innerHTML = `
      <div class="empty-state" style="padding:30px;">
        <div style="font-size:40px;margin-bottom:10px;">ğŸš—</div>
        <div style="color:var(--text-dim);">×œ× ×”×•×’×“×¨ ×¨×›×‘ ×¢×“×™×™×Ÿ</div>
        <button class="btn btn-primary btn-sm" style="margin-top:14px;" onclick="openVehicleEditModal()">â• ×”×•×¡×£ ×¨×›×‘</button>
      </div>`;
    remindersEl.innerHTML = '<div style="color:var(--text-dim);font-size:13px;text-align:center;padding:20px;">×”×’×“×¨ ×¨×›×‘ ×›×“×™ ×œ×¨××•×ª ×ª×–×›×•×¨×•×ª</div>';
    currentKmEl.textContent = 'â€”';
    kmHistoryEl.innerHTML = '';
    return;
  }

  // Has vehicle data
  const vehicleName = [vehicleData.make, vehicleData.model].filter(Boolean).join(' ') || '×”×¨×›×‘ ×©×œ×™';
  infoEl.innerHTML = `
    <div class="vehicle-header">
      <div class="vehicle-title-row">
        <div class="vehicle-icon">ğŸš—</div>
        <div class="vehicle-main-info">
          <h3>${escHtml(vehicleName)}</h3>
          <div class="vehicle-plate">${escHtml(vehicleData.plate)}</div>
        </div>
      </div>
      <button class="icon-btn" onclick="openVehicleEditModal()" title="×¢×¨×™×›×”">âœï¸</button>
    </div>
    <div class="vehicle-details-grid">
      ${vehicleData.year ? `<div class="vehicle-detail-item"><span class="vehicle-detail-label">×©× ×ª ×™×™×¦×•×¨</span><span class="vehicle-detail-value">${vehicleData.year}</span></div>` : ''}
      ${vehicleData.transmission ? `<div class="vehicle-detail-item"><span class="vehicle-detail-label">×¡×•×’ ×ª×™×‘×”</span><span class="vehicle-detail-value">${vehicleData.transmission}</span></div>` : ''}
      ${vehicleData.color ? `<div class="vehicle-detail-item"><span class="vehicle-detail-label">×¦×‘×¢</span><span class="vehicle-detail-value">${vehicleData.color}</span></div>` : ''}
    </div>`;

  // Reminders
  const reminders = [];
  const today = new Date();
  today.setHours(0,0,0,0);

  const reminderTypes = [
    { key: 'testDate', label: '×˜×¡×˜ ×©× ×ª×™', icon: 'ğŸ”§' },
    { key: 'insuranceDate', label: '×‘×™×˜×•×— ×—×•×‘×”', icon: 'ğŸ“‹' },
    { key: 'fullInsuranceDate', label: '×‘×™×˜×•×— ××§×™×£', icon: 'ğŸ›¡ï¸' },
    { key: 'serviceDate', label: '×˜×™×¤×•×œ ×”×‘×', icon: 'âš™ï¸' }
  ];

  reminderTypes.forEach(type => {
    if (vehicleData[type.key]) {
      const dueDate = new Date(vehicleData[type.key] + 'T00:00:00');
      const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
      reminders.push({
        ...type,
        date: vehicleData[type.key],
        daysUntil: daysUntil
      });
    }
  });

  if (reminders.length === 0) {
    remindersEl.innerHTML = '<div style="color:var(--text-dim);font-size:13px;text-align:center;padding:20px;">×œ× ×”×•×’×“×¨×• ×ª×–×›×•×¨×•×ª</div>';
  } else {
    remindersEl.innerHTML = reminders.map(r => {
      let statusClass = 'ok';
      let daysText = '';

      if (r.daysUntil < 0) {
        statusClass = 'danger';
        daysText = `×¢×‘×¨ ×œ×¤× ×™ ${Math.abs(r.daysUntil)} ×™××™×`;
      } else if (r.daysUntil === 0) {
        statusClass = 'danger';
        daysText = '×”×™×•×!';
      } else if (r.daysUntil <= 14) {
        statusClass = 'warning';
        daysText = `×‘×¢×•×“ ${r.daysUntil} ×™××™×`;
      } else {
        daysText = `×‘×¢×•×“ ${r.daysUntil} ×™××™×`;
      }

      const dateFormatted = new Date(r.date + 'T00:00:00').toLocaleDateString('he-IL');

      return `
        <div class="reminder-item ${statusClass}">
          <div class="reminder-icon">${r.icon}</div>
          <div class="reminder-content">
            <div class="reminder-title">${r.label}</div>
            <div class="reminder-date">${dateFormatted}</div>
          </div>
          <div class="reminder-days">${daysText}</div>
        </div>`;
    }).join('');
  }

  // KM Display
  if (kmHistory.length > 0) {
    const latestKm = kmHistory[0].km;
    currentKmEl.textContent = latestKm.toLocaleString() + ' ×§"×';

    // KM History
    kmHistoryEl.innerHTML = `
      <div class="section-title" style="margin-top:8px;font-size:12px;">×”×™×¡×˜×•×¨×™×”</div>
      <div class="km-history-list">
        ${kmHistory.slice(0, 5).map((entry, i) => {
          const dateFormatted = new Date(entry.date + 'T00:00:00').toLocaleDateString('he-IL');
          let diffText = '';
          if (i < kmHistory.length - 1) {
            const diff = entry.km - kmHistory[i + 1].km;
            if (diff > 0) diffText = `+${diff.toLocaleString()}`;
          }
          return `
            <div class="km-history-item">
              <span class="km-history-date">${dateFormatted}</span>
              <span class="km-history-value">${entry.km.toLocaleString()} ×§"× ${diffText ? `<span class="km-history-diff">(${diffText})</span>` : ''}</span>
            </div>`;
        }).join('')}
      </div>`;
  } else {
    currentKmEl.textContent = 'â€”';
    kmHistoryEl.innerHTML = '';
  }
}

function checkVehicleReminders() {
  if (!vehicleData) return;

  const today = new Date();
  today.setHours(0,0,0,0);

  const reminderTypes = [
    { key: 'testDate', label: '×˜×¡×˜ ×©× ×ª×™' },
    { key: 'insuranceDate', label: '×‘×™×˜×•×— ×—×•×‘×”' },
    { key: 'fullInsuranceDate', label: '×‘×™×˜×•×— ××§×™×£' },
    { key: 'serviceDate', label: '×˜×™×¤×•×œ ×”×‘×' }
  ];

  const warnings = [];

  reminderTypes.forEach(type => {
    if (vehicleData[type.key]) {
      const dueDate = new Date(vehicleData[type.key] + 'T00:00:00');
      const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

      if (daysUntil <= 14 && daysUntil >= 0) {
        warnings.push(`${type.label} ×‘×¢×•×“ ${daysUntil} ×™××™×`);
      } else if (daysUntil < 0) {
        warnings.push(`${type.label} ×¢×‘×¨!`);
      }
    }
  });

  if (warnings.length > 0) {
    setTimeout(() => {
      showToast('ğŸš— ×ª×–×›×•×¨×•×ª ×¨×›×‘: ' + warnings[0]);
    }, 2000);
  }
}

// INIT
if (checkLicense()) {
  renderAll();
  checkBackupReminder();
  checkVehicleReminders();
}

// ============================================================
// SERVICE WORKER REGISTRATION (PWA)
// ============================================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => {
        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New version available
              if (confirm('×’×¨×¡×” ×—×“×©×” ×–××™× ×”! ×œ×¨×¢× ×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”?')) {
                newWorker.postMessage('skipWaiting');
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(() => {
        // Service worker registration failed silently
      });
  });
}

// Handle app install prompt (Android)
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // Show install button in header if not already installed
  const installBtn = document.createElement('button');
  installBtn.id = 'pwaInstallBtn';
  installBtn.className = 'btn btn-sm btn-outline';
  installBtn.style.cssText = 'position:fixed;bottom:70px;left:10px;z-index:999;font-size:11px;padding:6px 10px;';
  installBtn.innerHTML = 'ğŸ“² ×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×”';
  installBtn.onclick = async () => {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      installBtn.remove();
    }
    deferredPrompt = null;
  };
  document.body.appendChild(installBtn);
});

// Hide install button if already installed
window.addEventListener('appinstalled', () => {
  const installBtn = document.getElementById('pwaInstallBtn');
  if (installBtn) installBtn.remove();
});
</script>
</body>
</html>
