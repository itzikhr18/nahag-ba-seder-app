<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<!-- PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="× ×”×’ ×‘×¡×“×¨">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f5f7fa">
<meta name="format-detection" content="telephone=no">
<meta name="application-name" content="× ×”×’ ×‘×¡×“×¨">
<meta name="description" content="××¤×œ×™×§×¦×™×” ×œ× ×™×”×•×œ ×ª×œ××™×“×™×, ×©×™×¢×•×¨×™× ×•×ª×©×œ×•××™× ×œ××•×¨×™ × ×”×™×’×”">

<!-- Manifest -->
<link rel="manifest" href="./manifest.json">

<!-- iOS Icons -->
<link rel="apple-touch-icon" href="./icons/icon-180x180.png">
<link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png">
<link rel="apple-touch-icon" sizes="167x167" href="./icons/icon-167x167.png">
<link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180x180.png">

<!-- Android/Chrome Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="96x96" href="./icons/icon-96x96.png">

<title>× ×”×’ ×‘×¡×“×¨ â€” × ×™×”×•×œ ×©×™×¢×•×¨×™ × ×”×™×’×”</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection, writeBatch, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
  import { getAuth, signInAnonymously, onAuthStateChanged, signInWithPhoneNumber, RecaptchaVerifier, linkWithCredential, PhoneAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

  const firebaseConfig = {
    apiKey: "AIzaSyC5TE_diBTNBYT2IMPJH0YsgD31spBqnE",
    authDomain: "nahag-ba-seder.firebaseapp.com",
    projectId: "nahag-ba-seder",
    storageBucket: "nahag-ba-seder.firebasestorage.app",
    messagingSenderId: "992942358011",
    appId: "1:992942358011:web:d9b5147cb48def6163df5e",
    measurementId: "G-L0JZFEGHXL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Make Firebase available globally
  window.firebaseDB = db;
  window.firebaseAuth = auth;
  window.firebaseDoc = doc;
  window.firebaseSetDoc = setDoc;
  window.firebaseGetDoc = getDoc;
  window.firebaseGetDocs = getDocs;
  window.firebaseDeleteDoc = deleteDoc;
  window.firebaseCollection = collection;
  window.firebaseWriteBatch = writeBatch;
  window.firebaseOnSnapshot = onSnapshot;
  window.firebaseSignInAnonymously = signInAnonymously;
  window.firebaseOnAuthStateChanged = onAuthStateChanged;
  window.firebaseSignInWithPhoneNumber = signInWithPhoneNumber;
  window.firebaseRecaptchaVerifier = RecaptchaVerifier;
  window.firebaseLinkWithCredential = linkWithCredential;
  window.firebasePhoneAuthProvider = PhoneAuthProvider;
  window.firebaseSignOut = signOut;
  window.firebaseReady = true;

  // Dispatch event when Firebase is ready
  window.dispatchEvent(new Event('firebaseReady'));
</script>
<style>
  :root {
    --bg: #f5f7fa;
    --surface: #ffffff;
    --surface-hover: #f0f2f5;
    --card: #ffffff;
    --border: #e0e4ea;
    --accent: #22c55e;
    --accent-dim: #16a34a;
    --accent-glow: rgba(34, 197, 94, 0.10);
    --success: #22c55e;
    --whatsapp: #25D366;
    --whatsapp-dark: #128C7E;
    --text: #1a1d27;
    --text-dim: #6b7080;
    --text-muted: #9ca3af;
    --danger: #ef4444;
    --danger-dim: rgba(239, 68, 68, 0.08);
    --warning: #e89209;
    --warning-dim: rgba(245, 158, 11, 0.08);
    --blue: #3b82f6;
    --blue-dim: rgba(59, 130, 246, 0.08);
    --radius: 14px;
    --radius-sm: 10px;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== HEADER ===== */
  .header {
    background: linear-gradient(135deg, var(--surface) 0%, #eef1f5 100%);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(20px);
  }
  .header-inner { max-width: 600px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--accent), var(--accent-dim)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
  .logo-text { font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 20px; letter-spacing: -0.5px; }
  .logo-text span { color: var(--accent); }
  .header-date { font-size: 13px; color: var(--text-dim); }

  /* ===== NAV ===== */
  .nav-tabs { display: flex; gap: 3px; padding: 10px 16px; max-width: 600px; margin: 0 auto; background: var(--bg); position: sticky; top: 70px; z-index: 99; }
  .nav-tab { flex: 1; padding: 9px 4px; border: none; background: var(--surface); color: var(--text-dim); font-family: 'Heebo', sans-serif; font-size: 12.5px; font-weight: 500; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.25s; display: flex; align-items: center; justify-content: center; gap: 4px; }
  .nav-tab:hover { background: var(--surface-hover); color: var(--text); }
  .nav-tab.active { background: var(--accent); color: #000; font-weight: 600; }
  .nav-tab .tab-icon { font-size: 14px; }

  /* ===== MAIN ===== */
  .main { max-width: 600px; margin: 0 auto; padding: 16px 16px 100px; }
  .page { display: none; }
  .page.active { display: block; }
  .section-title { font-size: 14px; font-weight: 600; color: var(--text-dim); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* ===== STATS ===== */
  .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
  .stats-bar.four { grid-template-columns: repeat(4, 1fr); }
  .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 8px; text-align: center; box-shadow: var(--shadow); }
  .stat-number { font-family: 'Rubik', sans-serif; font-size: 24px; font-weight: 700; color: var(--accent); line-height: 1; }
  .stat-number.red { color: var(--danger); }
  .stat-number.blue { color: var(--blue); }
  .stat-number.yellow { color: var(--warning); }
  .stat-label { font-size: 11px; color: var(--text-dim); margin-top: 3px; }

  /* ===== FORMS ===== */
  .form-group { margin-bottom: 12px; }
  .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-dim); margin-bottom: 5px; }
  .form-input, .form-select, .form-textarea {
    width: 100%; padding: 11px 12px; background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text); font-family: 'Heebo', sans-serif; font-size: 15px;
    transition: border-color 0.2s; direction: rtl;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
  .form-input::placeholder { color: var(--text-muted); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .form-row.three { grid-template-columns: 1fr 1fr 1fr; }
  .form-textarea { min-height: 50px; resize: vertical; }

  /* ===== BUTTONS ===== */
  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 11px 18px; border: none; border-radius: var(--radius-sm); font-family: 'Heebo', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%; }
  .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dim)); color: #000; }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(34,197,94,0.3); }
  .btn-whatsapp { background: linear-gradient(135deg, var(--whatsapp), var(--whatsapp-dark)); color: #fff; font-size: 16px; padding: 13px 18px; }
  .btn-whatsapp:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(37,211,102,0.35); }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger-outline { background: transparent; border: 1px solid var(--danger); color: var(--danger); font-size: 13px; padding: 8px 14px; width: auto; }
  .btn-sm { padding: 8px 14px; font-size: 13px; width: auto; }

  /* ===== STUDENT / LESSON ITEMS ===== */
  .student-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
  .student-item:hover { border-color: var(--accent); background: var(--surface-hover); }
  .student-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-dim)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 15px; color: #000; flex-shrink: 0; }
  .student-info { flex: 1; min-width: 0; }
  .student-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
  .student-meta { font-size: 11px; color: var(--text-dim); display: flex; gap: 10px; flex-wrap: wrap; }
  .student-actions { display: flex; gap: 5px; }
  .icon-btn { width: 34px; height: 34px; border: 1px solid var(--border); background: var(--surface); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 15px; color: var(--text-dim); }
  .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
  .icon-btn.wa:hover { border-color: var(--whatsapp); color: var(--whatsapp); }

  .lesson-item { display: flex; gap: 12px; padding: 12px 14px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; align-items: center; }
  .lesson-time { background: var(--surface); border-radius: 8px; padding: 7px 10px; text-align: center; min-width: 58px; flex-shrink: 0; }
  .lesson-hour { font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 16px; color: var(--accent); line-height: 1.1; }
  .lesson-date-small { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
  .lesson-details { flex: 1; }
  .lesson-student-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
  .lesson-info { font-size: 11px; color: var(--text-dim); }
  .lesson-actions { display: flex; gap: 5px; flex-shrink: 0; }

  /* ===== EMPTY ===== */
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); }
  .empty-icon { font-size: 44px; margin-bottom: 10px; opacity: 0.5; }
  .empty-text { font-size: 14px; margin-bottom: 4px; }
  .empty-sub { font-size: 12px; color: var(--text-muted); }

  /* ===== MODAL ===== */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 200; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.show { display: flex; }
  .modal { background: var(--surface); border-radius: var(--radius) var(--radius) 0 0; padding: 20px 18px 28px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch; animation: slideUp 0.3s ease; }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 14px; }
  .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

  /* ===== TOAST ===== */
  .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(200px); background: var(--accent); color: #000; padding: 12px 24px; border-radius: var(--radius-sm); font-weight: 600; font-size: 14px; z-index: 300; transition: transform 0.3s ease; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* ===== BADGE ===== */
  .badge { display: inline-block; padding: 2px 7px; border-radius: 6px; font-size: 10px; font-weight: 600; }
  .badge-green { background: rgba(34,197,94,0.15); color: var(--accent); }
  .badge-yellow { background: var(--warning-dim); color: var(--warning); }
  .badge-red { background: var(--danger-dim); color: var(--danger); }
  .badge-blue { background: var(--blue-dim); color: var(--blue); }

  /* ===== DAY HEADER ===== */
  .day-header { font-size: 13px; font-weight: 600; color: var(--text-dim); padding: 8px 0 4px; display: flex; align-items: center; gap: 8px; }
  .day-header .day-dot { width: 7px; height: 7px; background: var(--accent); border-radius: 50%; }

  /* ===== SEARCH ===== */
  .search-box { position: relative; margin-bottom: 14px; }
  .search-box input { width: 100%; padding: 9px 12px 9px 36px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'Heebo', sans-serif; font-size: 13px; }
  .search-box input:focus { outline: none; border-color: var(--accent); }
  .search-box .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px; }

  /* ===== WA PREVIEW ===== */
  .wa-preview { background: #dcf8c6; border-radius: var(--radius-sm); padding: 12px 14px; margin: 12px 0; font-size: 13px; line-height: 1.7; color: #1a3a1a; direction: rtl; white-space: pre-line; border: 1px solid #b8e6a0; }
  .wa-preview-label { font-size: 11px; color: var(--text-dim); margin-bottom: 5px; display: flex; align-items: center; gap: 6px; }

  /* ===== COUNTER ===== */
  .lesson-count { display: flex; align-items: center; gap: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 7px 12px; }
  .count-btn { width: 30px; height: 30px; border: 1px solid var(--border); background: var(--card); color: var(--text); border-radius: 8px; font-size: 17px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 600; transition: all 0.15s; }
  .count-btn:hover { border-color: var(--accent); color: var(--accent); }
  .count-display { font-family: 'Rubik', sans-serif; font-size: 18px; font-weight: 700; min-width: 28px; text-align: center; }

  /* ===== WEEKLY CALENDAR ===== */
  .cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .cal-nav-title { font-family: 'Rubik', sans-serif; font-weight: 600; font-size: 15px; }
  .cal-nav-btn { width: 34px; height: 34px; border: 1px solid var(--border); background: var(--surface); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); font-size: 16px; transition: all 0.15s; }
  .cal-nav-btn:hover { border-color: var(--accent); color: var(--accent); }

  .cal-week-header { display: grid; grid-template-columns: 44px repeat(7, 1fr); gap: 0; margin-bottom: 2px; }
  .cal-day-label { text-align: center; font-size: 11px; color: var(--text-muted); padding: 4px 0; font-weight: 500; }
  .cal-day-label.today { color: var(--accent); font-weight: 700; }
  .cal-day-num { font-family: 'Rubik', sans-serif; font-size: 13px; font-weight: 600; display: block; }

  .cal-body { display: grid; grid-template-columns: 44px repeat(7, 1fr); gap: 0; position: relative; }
  .cal-hour-label { font-size: 10px; color: var(--text-muted); text-align: center; height: 48px; display: flex; align-items: flex-start; justify-content: center; padding-top: 2px; font-family: 'Rubik', sans-serif; border-top: 1px solid var(--border); }
  .cal-cell { height: 48px; border-top: 1px solid var(--border); border-right: 1px solid var(--border); position: relative; cursor: pointer; transition: background 0.15s; }
  .cal-cell:hover { background: var(--surface-hover); }
  .cal-cell.today-col { background: rgba(34,197,94,0.04); }

  .cal-event { position: absolute; right: 2px; left: 2px; background: linear-gradient(135deg, var(--accent), var(--accent-dim)); border-radius: 6px; padding: 3px 5px; font-size: 10px; font-weight: 600; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; z-index: 5; line-height: 1.2; box-shadow: 0 1px 4px rgba(0,0,0,0.15); }
  .cal-event:hover { filter: brightness(1.1); transform: scale(1.02); }
  .cal-event.completed { background: linear-gradient(135deg, #8bc49a, #6dab7f); opacity: 0.7; }
  .cal-event .ev-time { font-family: 'Rubik', sans-serif; font-size: 9px; opacity: 0.8; }
  .cal-event .ev-status { font-size: 8px; opacity: 0.7; }

  .cal-scroll { max-height: min(480px, 60vh); overflow-y: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); -webkit-overflow-scrolling: touch; }

  /* ===== PAYMENT ITEM ===== */
  .payment-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; }
  .payment-amount { font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 16px; min-width: 70px; text-align: center; }
  .payment-amount.income { color: var(--accent); }
  .payment-amount.debt { color: var(--danger); }
  .payment-info { flex: 1; }
  .payment-name { font-weight: 600; font-size: 13px; }
  .payment-meta { font-size: 11px; color: var(--text-dim); }

  /* ===== DEBT LIST IN FINANCE ===== */
  .debt-student { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
  .debt-student:hover { border-color: var(--warning); }
  .debt-amount { font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 18px; color: var(--danger); }
  .debt-info { flex: 1; }
  .debt-name { font-weight: 600; font-size: 14px; }
  .debt-detail { font-size: 11px; color: var(--text-dim); }

  /* ===== MONTH PICKER ===== */
  .month-picker { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; justify-content: center; }
  .month-picker-label { font-family: 'Rubik', sans-serif; font-weight: 600; font-size: 15px; min-width: 120px; text-align: center; }

  /* ===== LICENSE SCREEN ===== */
  .license-screen {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .license-screen.hidden { display: none; }
  .license-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 30px 24px;
    max-width: 360px;
    width: 100%;
    text-align: center;
  }
  .license-logo { font-size: 48px; margin-bottom: 12px; }
  .license-title { font-family: 'Rubik', sans-serif; font-size: 22px; font-weight: 700; margin-bottom: 6px; }
  .license-title span { color: var(--accent); }
  .license-subtitle { font-size: 13px; color: var(--text-dim); margin-bottom: 24px; }
  .license-input {
    width: 100%;
    padding: 14px 16px;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Rubik', sans-serif;
    font-size: 18px;
    text-align: center;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }
  .license-input:focus { outline: none; border-color: var(--accent); }
  .license-input::placeholder { letter-spacing: 0; font-size: 14px; }
  .license-error { color: var(--danger); font-size: 13px; margin-bottom: 12px; display: none; }
  .license-error.show { display: block; }
  .license-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim));
    border: none;
    border-radius: var(--radius-sm);
    color: #000;
    font-family: 'Heebo', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
  }
  .license-btn:hover { filter: brightness(1.1); }
  .license-footer { margin-top: 20px; font-size: 11px; color: var(--text-muted); }

  /* ===== LOGIN SCREEN (Phone Auth) ===== */
  .login-screen {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .login-screen.hidden { display: none; }
  .login-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 30px 24px;
    max-width: 360px;
    width: 100%;
    text-align: center;
  }
  .login-logo { font-size: 48px; margin-bottom: 12px; }
  .login-title { font-family: 'Rubik', sans-serif; font-size: 22px; font-weight: 700; margin-bottom: 6px; }
  .login-title span { color: var(--accent); }
  .login-subtitle { font-size: 13px; color: var(--text-dim); margin-bottom: 24px; }
  .login-phone-row {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    direction: ltr;
  }
  .login-prefix {
    width: 70px;
    padding: 14px 8px;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Rubik', sans-serif;
    font-size: 16px;
    text-align: center;
  }
  .login-prefix:focus { outline: none; border-color: var(--accent); }
  .login-phone-input {
    flex: 1;
    padding: 14px 16px;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Rubik', sans-serif;
    font-size: 18px;
    letter-spacing: 1px;
  }
  .login-phone-input:focus { outline: none; border-color: var(--accent); }
  .login-phone-input::placeholder { letter-spacing: 0; font-size: 14px; }
  .login-otp-input {
    width: 100%;
    padding: 14px 16px;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Rubik', sans-serif;
    font-size: 24px;
    text-align: center;
    letter-spacing: 8px;
    margin-bottom: 12px;
    direction: ltr;
  }
  .login-otp-input:focus { outline: none; border-color: var(--accent); }
  .login-otp-input::placeholder { letter-spacing: 0; font-size: 14px; }
  .login-error { color: var(--danger); font-size: 13px; margin-bottom: 12px; display: none; }
  .login-error.show { display: block; }
  .login-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim));
    border: none;
    border-radius: var(--radius-sm);
    color: #000;
    font-family: 'Heebo', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-bottom: 8px;
  }
  .login-btn:hover { filter: brightness(1.1); }
  .login-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: none; }
  .login-btn-outline {
    width: 100%;
    padding: 12px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-dim);
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    margin-bottom: 8px;
  }
  .login-btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .login-step { display: none; }
  .login-step.active { display: block; }
  .login-footer { margin-top: 16px; font-size: 11px; color: var(--text-muted); }
  .login-timer { font-size: 12px; color: var(--text-dim); margin-bottom: 12px; }

  /* ===== LICENSED USER BADGE ===== */
  .licensed-badge {
    font-size: 10px;
    color: var(--accent);
    background: var(--accent-glow);
    padding: 2px 8px;
    border-radius: 10px;
    margin-right: 8px;
  }

  /* ===== SCROLLBAR ===== */
  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ===== MOBILE FIXES ===== */
  /* Prevent iOS zoom on input focus - must be 16px+ */
  @media screen and (max-width: 768px) {
    .form-input, .form-select, .form-textarea { font-size: 16px; }
  }

  /* Safe area for iPhone notch/dynamic island */
  @supports (padding: env(safe-area-inset-top)) {
    .header { padding-top: calc(16px + env(safe-area-inset-top)); }
    .nav-tabs { top: calc(70px + env(safe-area-inset-top)); }
    .main { padding-bottom: calc(100px + env(safe-area-inset-bottom)); }
    .modal { padding-bottom: calc(28px + env(safe-area-inset-bottom)); }
    .toast { bottom: calc(80px + env(safe-area-inset-bottom)); }
  }

  /* Touch: prevent text selection on interactive elements */
  .btn, .nav-tab, .icon-btn, .cal-nav-btn, .count-btn, .student-item, .debt-student {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }

  /* Improve touch targets - minimum 44px */
  .icon-btn { min-width: 44px; min-height: 44px; }
  .cal-nav-btn { min-width: 44px; min-height: 44px; }
  .count-btn { min-width: 44px; min-height: 44px; }

  @media (max-width: 400px) {
    .form-row { grid-template-columns: 1fr; }
    .form-row.three { grid-template-columns: 1fr 1fr; }
    .stats-bar.four { grid-template-columns: repeat(2, 1fr); }
    .stat-number { font-size: 20px; }
    .cal-week-header, .cal-body { grid-template-columns: 36px repeat(7, 1fr); }
    .cal-hour-label { font-size: 9px; }
    .cal-event { font-size: 9px; padding: 2px 3px; }
  }
  @media (max-width: 340px) {
    .form-row.three { grid-template-columns: 1fr; }
    .nav-tab { font-size: 11px; padding: 8px 2px; }
  }

  /* ===== VEHICLE PAGE ===== */
  .vehicle-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }
  .vehicle-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }
  .vehicle-title-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .vehicle-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }
  .vehicle-main-info h3 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 2px;
  }
  .vehicle-plate {
    font-family: 'Rubik', sans-serif;
    font-size: 14px;
    color: var(--accent);
    letter-spacing: 1px;
  }
  .vehicle-details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }
  .vehicle-detail-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .vehicle-detail-label {
    font-size: 11px;
    color: var(--text-muted);
  }
  .vehicle-detail-value {
    font-size: 14px;
    font-weight: 500;
  }

  /* ===== REMINDERS LIST ===== */
  .reminders-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .reminder-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
  }
  .reminder-item.warning {
    border-color: var(--warning);
    background: var(--warning-dim);
  }
  .reminder-item.danger {
    border-color: var(--danger);
    background: var(--danger-dim);
  }
  .reminder-item.ok {
    border-color: var(--accent);
  }
  .reminder-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    background: var(--surface);
  }
  .reminder-item.warning .reminder-icon { background: var(--warning); }
  .reminder-item.danger .reminder-icon { background: var(--danger); }
  .reminder-item.ok .reminder-icon { background: var(--accent-dim); }
  .reminder-content {
    flex: 1;
    min-width: 0;
  }
  .reminder-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 2px;
  }
  .reminder-date {
    font-size: 12px;
    color: var(--text-dim);
  }
  .reminder-days {
    font-family: 'Rubik', sans-serif;
    font-size: 13px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 8px;
    white-space: nowrap;
  }
  .reminder-item.warning .reminder-days { color: var(--warning); background: rgba(245,158,11,0.2); }
  .reminder-item.danger .reminder-days { color: var(--danger); background: rgba(239,68,68,0.2); }
  .reminder-item.ok .reminder-days { color: var(--accent); background: var(--accent-glow); }

  /* ===== KM HISTORY ===== */
  .km-history-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .km-history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--surface);
    border-radius: var(--radius-sm);
    font-size: 13px;
  }
  .km-history-date {
    color: var(--text-dim);
  }
  .km-history-value {
    font-family: 'Rubik', sans-serif;
    font-weight: 600;
    color: var(--text);
  }
  .km-history-diff {
    font-size: 11px;
    color: var(--accent);
  }

  /* ===== OFFLINE INDICATOR ===== */
  .offline-banner {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
    padding: 8px 16px;
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    z-index: 10000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  .offline-banner.show { display: block; }
  body.is-offline { padding-top: 36px !important; }
  body.is-offline .header { top: 36px; }
  body.is-offline .nav-tabs { top: calc(106px + env(safe-area-inset-top, 0px)); }

  /* ===== SYNC INDICATOR ===== */
  .sync-indicator {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 14px;
    display: none;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    z-index: 150;
    box-shadow: var(--shadow);
  }
  .sync-indicator.show { display: flex; }
  .sync-indicator.syncing { border-color: var(--blue); }
  .sync-indicator.synced { border-color: var(--accent); }
  .sync-indicator.error { border-color: var(--danger); }
  .sync-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== CUSTOM CONFIRM MODAL ===== */
  .confirm-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }
  .confirm-overlay.show { display: flex; }
  .confirm-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px 20px;
    max-width: 340px;
    width: 100%;
    text-align: center;
    animation: slideUp 0.2s ease;
  }
  .confirm-icon { font-size: 40px; margin-bottom: 12px; }
  .confirm-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
  .confirm-message { font-size: 14px; color: var(--text-dim); margin-bottom: 20px; white-space: pre-line; line-height: 1.5; }
  .confirm-buttons { display: flex; gap: 10px; }
  .confirm-buttons .btn { flex: 1; }

  /* ===== LOADING OVERLAY ===== */
  .loading-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(245, 247, 250, 0.9);
    z-index: 9998;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
  }
  .loading-overlay.show { display: flex; }
  .loading-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  .loading-text { font-size: 14px; color: var(--text); }

  /* ===== UNDO TOAST ===== */
  .undo-toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(200px);
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    z-index: 300;
    transition: transform 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: var(--shadow);
  }
  .undo-toast.show { transform: translateX(-50%) translateY(0); }
  .undo-toast .undo-btn {
    background: var(--accent);
    color: #000;
    border: none;
    padding: 6px 14px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- ===== LOGIN SCREEN (Phone Auth) ===== -->
<div class="login-screen hidden" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">ğŸš—</div>
    <div class="login-title">× ×”×’<span>×‘×¡×“×¨</span></div>
    <div class="login-subtitle">×”×ª×—×‘×¨ ×¢× ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ×š</div>

    <!-- Step 1: Phone Number -->
    <div class="login-step active" id="loginStepPhone">
      <div class="login-phone-row">
        <input type="text" class="login-prefix" id="loginPrefix" value="+972" readonly>
        <input type="tel" class="login-phone-input" id="loginPhone" placeholder="50-1234567" maxlength="11" inputmode="tel">
      </div>
      <div class="login-error" id="loginPhoneError"></div>
      <button class="login-btn" id="loginSendCodeBtn" onclick="sendOtpCode()">ğŸ“± ×©×œ×— ×§×•×“ ××™××•×ª</button>
    </div>

    <!-- Step 2: OTP Code -->
    <div class="login-step" id="loginStepOtp">
      <div style="font-size:13px;color:var(--text-dim);margin-bottom:12px;" id="loginOtpInfo">×§×•×“ ××™××•×ª × ×©×œ×— ×œ...</div>
      <input type="text" class="login-otp-input" id="loginOtpCode" placeholder="000000" maxlength="6" inputmode="numeric">
      <div class="login-error" id="loginOtpError"></div>
      <div class="login-timer" id="loginTimer"></div>
      <button class="login-btn" id="loginVerifyBtn" onclick="verifyOtpCode()">ğŸ”“ ×›× ×™×¡×”</button>
      <button class="login-btn-outline" onclick="resetLoginToPhone()">â† ×©×™× ×•×™ ××¡×¤×¨</button>
    </div>

    <div class="login-footer">×”×›× ×™×¡×” ×××•×‘×˜×—×ª ×‘×××¦×¢×•×ª Firebase Authentication</div>
    <div id="recaptcha-container"></div>
  </div>
</div>

<!-- ===== LICENSE ACTIVATION SCREEN ===== -->
<div class="license-screen" id="licenseScreen">
  <div class="license-box">
    <div class="license-logo">ğŸš—</div>
    <div class="license-title">× ×”×’<span>×‘×¡×“×¨</span></div>
    <div class="license-subtitle">×”×–×Ÿ ××ª ×§×•×“ ×”×”×¤×¢×œ×” ×©×§×™×‘×œ×ª</div>
    <input type="text" class="license-input" id="licenseCodeInput" placeholder="XXXX-XXXX" maxlength="9" dir="ltr">
    <div class="license-error" id="licenseError">âŒ ×§×•×“ ×œ× ×ª×§×™×Ÿ, × ×¡×” ×©×•×‘</div>
    <button class="license-btn" onclick="activateLicense()">ğŸ”“ ×”×¤×¢×œ</button>
    <div class="license-footer">×œ×§×‘×œ×ª ×§×•×“ ×”×¤×¢×œ×” ×¦×•×¨ ×§×©×¨ ×¢× ×”××¤×ª×—</div>
  </div>
</div>

<header class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">ğŸš—</div>
      <div class="logo-text">× ×”×’<span>×‘×¡×“×¨</span></div>
      <span class="licensed-badge" id="licensedBadge"></span>
    </div>
    <div class="header-date" id="headerDate"></div>
  </div>
</header>

<nav class="nav-tabs">
  <button class="nav-tab active" data-page="dashboard" onclick="switchPage('dashboard')"><span class="tab-icon">ğŸ“Š</span> ×¨××©×™</button>
  <button class="nav-tab" data-page="calendar" onclick="switchPage('calendar')"><span class="tab-icon">ğŸ“…</span> ×™×•××Ÿ</button>
  <button class="nav-tab" data-page="students" onclick="switchPage('students')"><span class="tab-icon">ğŸ‘¤</span> ×ª×œ××™×“×™×</button>
  <button class="nav-tab" data-page="finance" onclick="switchPage('finance')"><span class="tab-icon">ğŸ’°</span> ×›×¡×¤×™×</button>
  <button class="nav-tab" data-page="vehicle" onclick="switchPage('vehicle')"><span class="tab-icon">ğŸš—</span> ×¨×›×‘</button>
</nav>

<main class="main">

  <!-- ========== DASHBOARD ========== -->
  <div class="page active" id="page-dashboard">
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-number" id="statStudents">0</div>
        <div class="stat-label">×ª×œ××™×“×™×</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statLessonsToday">0</div>
        <div class="stat-label">×”×™×•×</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statDebtTotal">0</div>
        <div class="stat-label">×—×•×‘ ×¤×ª×•×— â‚ª</div>
      </div>
    </div>
    <div class="section-title">×©×™×¢×•×¨×™× ×§×¨×•×‘×™×</div>
    <div id="upcomingLessons"></div>
    <div style="margin-top:16px;">
      <button class="btn btn-primary" onclick="openNewLessonModal()">â• ×§×‘×™×¢×ª ×©×™×¢×•×¨ ×—×“×©</button>
    </div>
    <div id="tomorrowLessons" style="margin-top:20px;"></div>
    <div id="weeklyForecast" style="margin-top:20px;"></div>
    <div id="debtAlerts" style="margin-top:20px;"></div>
    <div style="margin-top:24px;display:flex;gap:8px;">
      <button class="btn btn-outline btn-sm" style="flex:1;" onclick="exportData()">ğŸ“¥ ×™×™×¦×•× ×’×™×‘×•×™</button>
      <button class="btn btn-outline btn-sm" style="flex:1;" onclick="importData()">ğŸ“¤ ×™×™×‘×•× ×’×™×‘×•×™</button>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
      <span style="font-size:12px;color:var(--text-muted);flex:1;" id="loggedInPhone"></span>
      <button class="btn btn-outline btn-sm" style="flex:0 0 auto;border-color:var(--danger);color:var(--danger);" onclick="logoutUser()">ğŸšª ×”×ª× ×ª×§</button>
    </div>
  </div>

  <!-- ========== CALENDAR ========== -->
  <div class="page" id="page-calendar">
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="calPrev()">â†’</button>
      <div>
        <span class="cal-nav-title" id="calTitle"></span>
        <button class="btn-sm btn-outline" style="margin-right:8px;padding:4px 10px;font-size:11px;" onclick="calToday()">×”×™×•×</button>
      </div>
      <button class="cal-nav-btn" onclick="calNext()">â†</button>
    </div>
    <div class="cal-scroll">
      <div class="cal-week-header" id="calWeekHeader"></div>
      <div class="cal-body" id="calBody"></div>
    </div>
    <div style="margin-top:12px;">
      <button class="btn btn-primary" onclick="openNewLessonModal()">â• ×©×™×¢×•×¨ ×—×“×©</button>
    </div>
  </div>

  <!-- ========== STUDENTS ========== -->
  <div class="page" id="page-students">
    <div style="display:flex;gap:6px;margin-bottom:12px;">
      <button class="btn btn-primary" style="flex:1" onclick="openNewStudentModal()">â• ×ª×œ××™×“ ×—×“×©</button>
    </div>
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" placeholder="×—×™×¤×•×© ×ª×œ××™×“..." id="studentSearch" oninput="renderStudents()">
    </div>
    <div id="studentsList"></div>
  </div>

  <!-- ========== FINANCE ========== -->
  <div class="page" id="page-finance">
    <div class="month-picker">
      <button class="cal-nav-btn" onclick="finPrev()">â†’</button>
      <span class="month-picker-label" id="finMonthLabel"></span>
      <button class="cal-nav-btn" onclick="finNext()">â†</button>
    </div>
    <!-- Date Range Filter -->
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span style="font-size:12px;color:var(--text-dim);">ğŸ“… ×¡×™× ×•×Ÿ:</span>
        <input type="date" id="finDateFrom" class="form-input" style="flex:1;min-width:110px;padding:6px 8px;font-size:12px;" onchange="applyDateFilter()">
        <span style="font-size:12px;color:var(--text-dim);">×¢×“</span>
        <input type="date" id="finDateTo" class="form-input" style="flex:1;min-width:110px;padding:6px 8px;font-size:12px;" onchange="applyDateFilter()">
        <button class="btn btn-outline btn-sm" style="padding:6px 10px;font-size:11px;" onclick="clearDateFilter()">× ×§×”</button>
      </div>
    </div>
    <div class="stats-bar four" id="finStats"></div>
    <div class="section-title">×—×•×‘×•×ª ×¤×ª×•×—×™×</div>
    <div id="debtList"></div>
    <div class="section-title" style="margin-top:18px;">×ª×©×œ×•××™× ××—×¨×•× ×™×</div>
    <div id="paymentsList"></div>
  </div>

  <!-- ========== VEHICLE ========== -->
  <div class="page" id="page-vehicle">
    <div class="section-title">ğŸš— ×¤×¨×˜×™ ×”×¨×›×‘</div>
    <div class="card vehicle-card" id="vehicleDetails">
      <div id="vehicleInfo">
        <div class="empty-state" style="padding:30px;">
          <div style="font-size:40px;margin-bottom:10px;">ğŸš—</div>
          <div style="color:var(--text-dim);">×œ× ×”×•×’×“×¨ ×¨×›×‘ ×¢×“×™×™×Ÿ</div>
          <button class="btn btn-primary btn-sm" style="margin-top:14px;" onclick="openVehicleEditModal()">â• ×”×•×¡×£ ×¨×›×‘</button>
        </div>
      </div>
    </div>

    <div class="section-title" style="margin-top:20px;">ğŸ“… ×ª×–×›×•×¨×•×ª</div>
    <div id="vehicleReminders" class="reminders-list"></div>

    <div class="section-title" style="margin-top:20px;">ğŸ“Š ××¢×§×‘ ×§×™×œ×•××˜×¨××–'</div>
    <div class="card" style="padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span style="color:var(--text-dim);font-size:13px;">×§×™×œ×•××˜×¨××–' × ×•×›×—×™</span>
        <span style="font-size:24px;font-weight:700;color:var(--accent);" id="currentKm">â€”</span>
      </div>
      <button class="btn btn-outline btn-sm" style="width:100%;" onclick="openKmUpdateModal()">ğŸ“ ×¢×“×›×•×Ÿ ×§×™×œ×•××˜×¨××–'</button>
      <div id="kmHistory" style="margin-top:16px;"></div>
    </div>
  </div>

</main>

<!-- ===== MODAL: NEW STUDENT ===== -->
<div class="modal-overlay" id="modalNewStudent">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ‘¤ ×ª×œ××™×“ ×—×“×©</div>
    <div class="form-group">
      <label class="form-label">×©× ××œ× *</label>
      <input class="form-input" id="newStudentName" placeholder="×™×©×¨××œ ×™×©×¨××œ×™">
    </div>
    <div class="form-group">
      <label class="form-label">×˜×œ×¤×•×Ÿ *</label>
      <input class="form-input" id="newStudentPhone" type="tel" placeholder="050-1234567" dir="ltr">
    </div>
    <div class="form-row three">
      <div class="form-group">
        <label class="form-label">××—×™×¨ ×œ×©×™×¢×•×¨ (â‚ª)</label>
        <input class="form-input" id="newStudentPrice" type="number" placeholder="170" dir="ltr">
      </div>
      <div class="form-group">
        <label class="form-label">×¡×”"×› ×©×™×¢×•×¨×™× × ×“×¨×©×™×</label>
        <input class="form-input" id="newStudentTotalLessons" type="number" placeholder="28" dir="ltr" min="1" max="100">
      </div>
      <div class="form-group">
        <label class="form-label">×©×™×¢×•×¨×™× ×©×‘×•×¦×¢×•</label>
        <div class="lesson-count">
          <button type="button" class="count-btn" onclick="adjustCount('newStudentLessons',-1)">âˆ’</button>
          <span class="count-display" id="newStudentLessons">0</span>
          <button type="button" class="count-btn" onclick="adjustCount('newStudentLessons',1)">+</button>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">×”×¢×¨×•×ª</label>
      <textarea class="form-textarea" id="newStudentNotes" placeholder="×”×¢×¨×•×ª..."></textarea>
    </div>
    <div class="form-group" style="display:flex;align-items:center;gap:10px;">
      <input type="checkbox" id="newStudentWantsExtra" style="width:20px;height:20px;accent-color:var(--accent);">
      <label for="newStudentWantsExtra" style="font-size:14px;color:var(--text);cursor:pointer;">××—×¤×© ×©×¢×•×ª × ×•×¡×¤×•×ª ğŸ””</label>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-primary" style="flex:2" onclick="preventDoubleClick(saveNewStudent)">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalNewStudent')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: NEW LESSON ===== -->
<div class="modal-overlay" id="modalNewLesson">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="lessonModalTitle">ğŸ“… ×§×‘×™×¢×ª ×©×™×¢×•×¨</div>
    <div class="form-group">
      <label class="form-label">×ª×œ××™×“ *</label>
      <select class="form-select" id="lessonStudent"><option value="">â€” ×‘×—×¨ â€”</option></select>
    </div>
    <div class="form-row three">
      <div class="form-group">
        <label class="form-label">×ª××¨×™×š *</label>
        <input class="form-input" id="lessonDate" type="date">
      </div>
      <div class="form-group">
        <label class="form-label">×©×¢×” *</label>
        <input class="form-input" id="lessonTime" type="text" inputmode="numeric" placeholder="00:00" maxlength="5" dir="ltr" style="text-align:center;font-family:'Rubik',sans-serif;font-size:18px;letter-spacing:2px;">
      </div>
      <div class="form-group">
        <label class="form-label">××©×š</label>
        <select class="form-select" id="lessonDuration">
          <option value="40">40 ×“×§×³</option>
          <option value="80">80 ×“×§×³</option>
        </select>
      </div>
    </div>
    <div class="form-group" id="lessonStatusGroup" style="display:none;">
      <label class="form-label">×¡×˜×˜×•×¡ ×©×™×¢×•×¨</label>
      <select class="form-select" id="lessonStatus">
        <option value="scheduled">ğŸ“… ××ª×•×›× ×Ÿ</option>
        <option value="completed">âœ… ×‘×•×¦×¢</option>
        <option value="cancelled">âŒ ×‘×•×˜×œ</option>
        <option value="no-show">ğŸš« ×œ× ×”×’×™×¢</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">×›×ª×•×‘×ª ××™×¡×•×£</label>
      <input class="form-input" id="lessonAddress" placeholder="×¨×—×•×‘, ×¢×™×¨">
    </div>
    <div id="waPreviewSection" style="display:none;">
      <div class="wa-preview-label">ğŸ’¬ ×ª×¦×•×’×” ××§×“×™××”:</div>
      <div class="wa-preview" id="waPreviewText"></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:7px;margin-top:16px;">
      <button type="button" class="btn btn-primary" onclick="preventDoubleClick(()=>saveLesson(false))">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-whatsapp" onclick="preventDoubleClick(()=>saveLesson(true))">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        ×©××™×¨×” + ×•×•××˜×¡××¤
      </button>
      <button type="button" class="btn btn-outline" style="border-color:var(--blue);color:var(--blue);" onclick="preventDoubleClick(()=>saveLesson('sms'))">ğŸ“± ×©××™×¨×” + SMS (×˜×œ×¤×•×Ÿ ×›×©×¨)</button>
      <button type="button" class="btn btn-outline" onclick="closeModal('modalNewLesson')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: PAYMENT ===== -->
<div class="modal-overlay" id="modalPayment">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ’³ ×¨×™×©×•× ×ª×©×œ×•×</div>
    <div class="form-group">
      <label class="form-label">×ª×œ××™×“</label>
      <select class="form-select" id="payStudent"><option value="">â€” ×‘×—×¨ â€”</option></select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">×¡×›×•× (â‚ª) *</label>
        <input class="form-input" id="payAmount" type="number" placeholder="170" dir="ltr">
      </div>
      <div class="form-group">
        <label class="form-label">×××¦×¢×™ ×ª×©×œ×•×</label>
        <select class="form-select" id="payMethod">
          <option value="××–×•××Ÿ">××–×•××Ÿ</option>
          <option value="×‘×™×˜">×‘×™×˜</option>
          <option value="×¤×™×™×‘×•×§×¡">×¤×™×™×‘×•×§×¡</option>
          <option value="×”×¢×‘×¨×”">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
          <option value="××©×¨××™">××©×¨××™</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">×ª××¨×™×š</label>
      <input class="form-input" id="payDate" type="date">
    </div>
    <div class="form-group">
      <label class="form-label">×”×¢×¨×”</label>
      <input class="form-input" id="payNote" placeholder="×œ×“×•×’××”: ×ª×©×œ×•× ×¢×œ 5 ×©×™×¢×•×¨×™×">
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-primary" style="flex:2" onclick="preventDoubleClick(savePayment)">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalPayment')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: STUDENT DETAIL ===== -->
<div class="modal-overlay" id="modalStudentDetail">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="detailStudentTitle">ğŸ‘¤</div>
    <div id="detailStudentContent"></div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalStudentDetail')">×¡×’×™×¨×”</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: VEHICLE EDIT ===== -->
<div class="modal-overlay" id="modalVehicleEdit">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸš— ×¤×¨×˜×™ ×”×¨×›×‘</div>
    <div class="form-group">
      <label class="form-label">××¡×¤×¨ ×¨×›×‘ *</label>
      <input class="form-input" id="vehiclePlate" placeholder="12-345-67" dir="ltr">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">×™×¦×¨×Ÿ</label>
        <input class="form-input" id="vehicleMake" placeholder="×§×™×”">
      </div>
      <div class="form-group">
        <label class="form-label">×“×’×</label>
        <input class="form-input" id="vehicleModel" placeholder="× ×™×¨×•">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">×©× ×ª ×™×™×¦×•×¨</label>
        <input class="form-input" id="vehicleYear" type="number" placeholder="2022" dir="ltr">
      </div>
      <div class="form-group">
        <label class="form-label">×¡×•×’ ×ª×™×‘×”</label>
        <select class="form-input" id="vehicleTransmission">
          <option value="××•×˜×•××˜">××•×˜×•××˜</option>
          <option value="×™×“× ×™">×™×“× ×™</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">×¦×‘×¢</label>
      <input class="form-input" id="vehicleColor" placeholder="×œ×‘×Ÿ">
    </div>
    <div class="section-title" style="margin-top:16px;">ğŸ“… ×ª×–×›×•×¨×•×ª</div>
    <div class="form-group">
      <label class="form-label">×˜×¡×˜ ×©× ×ª×™</label>
      <input class="form-input" id="vehicleTestDate" type="date" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">×‘×™×˜×•×— ×—×•×‘×”</label>
      <input class="form-input" id="vehicleInsuranceDate" type="date" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">×‘×™×˜×•×— ××§×™×£</label>
      <input class="form-input" id="vehicleFullInsuranceDate" type="date" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">×˜×™×¤×•×œ ×”×‘×</label>
      <input class="form-input" id="vehicleServiceDate" type="date" dir="ltr">
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-primary" style="flex:2" onclick="preventDoubleClick(saveVehicle)">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalVehicleEdit')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: KM UPDATE ===== -->
<div class="modal-overlay" id="modalKmUpdate">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“Š ×¢×“×›×•×Ÿ ×§×™×œ×•××˜×¨××–'</div>
    <div class="form-group">
      <label class="form-label">×§×™×œ×•××˜×¨××–' × ×•×›×—×™</label>
      <input class="form-input" id="newKmValue" type="number" placeholder="50000" dir="ltr">
    </div>
    <div class="form-group">
      <label class="form-label">×ª××¨×™×š</label>
      <input class="form-input" id="kmUpdateDate" type="date" dir="ltr">
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button type="button" class="btn btn-primary" style="flex:2" onclick="preventDoubleClick(saveKmUpdate)">ğŸ’¾ ×©××™×¨×”</button>
      <button type="button" class="btn btn-outline" style="flex:1" onclick="closeModal('modalKmUpdate')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- Reminder List Modal (WhatsApp per-student) -->
<div class="modal-overlay" id="modalReminderList">
  <div class="modal" style="max-width:450px;">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“¨ ×©×œ×™×—×ª ×ª×–×›×•×¨×•×ª ×œ××—×¨</div>
    <div id="reminderListContent"></div>
    <div style="margin-top:16px;">
      <button type="button" class="btn btn-outline" style="width:100%;" onclick="closeModal('modalReminderList')">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<!-- Slot Notification List Modal (WhatsApp per-student) -->
<div class="modal-overlay" id="modalSlotList">
  <div class="modal" style="max-width:450px;">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“… ×”×•×“×¢×” ×¢×œ ××§×•× ×¤× ×•×™</div>
    <div id="slotListContent"></div>
    <div style="margin-top:16px;">
      <button type="button" class="btn btn-outline" style="width:100%;" onclick="closeModal('modalSlotList')">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Offline Banner -->
<div class="offline-banner" id="offlineBanner">ğŸ“´ ××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ - ×©×™× ×•×™×™× ×™×™×©××¨×• ××§×•××™×ª</div>

<!-- Sync Indicator -->
<div class="sync-indicator" id="syncIndicator">
  <div class="sync-spinner"></div>
  <span id="syncText">××¡× ×›×¨×Ÿ...</span>
</div>

<!-- Custom Confirm Modal -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-icon" id="confirmIcon">âš ï¸</div>
    <div class="confirm-title" id="confirmTitle">××™×©×•×¨</div>
    <div class="confirm-message" id="confirmMessage"></div>
    <div class="confirm-buttons">
      <button class="btn btn-primary" id="confirmYes">××™×©×•×¨</button>
      <button class="btn btn-outline" id="confirmNo">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loadingText">×˜×•×¢×Ÿ...</div>
</div>

<!-- Undo Toast -->
<div class="undo-toast" id="undoToast">
  <span id="undoMessage">×¤×¨×™×˜ × ××—×§</span>
  <button class="undo-btn" id="undoBtn">â†©ï¸ ×‘×™×˜×•×œ</button>
</div>

<script>
// ============================================================
// LICENSE SYSTEM (with hashed codes for security)
// ============================================================
// ×¤×•× ×§×¦×™×™×ª Hash ×¤×©×•×˜×” - ×”×•×¤×›×ª ×§×•×“ ×œ×¢×¨×š ××•×¦×¤×Ÿ
function hashCode(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  // Add salt and secondary hash for better security
  const salted = 'NBS_' + Math.abs(hash).toString(16) + '_DRV';
  let hash2 = 5381;
  for (let i = 0; i < salted.length; i++) {
    hash2 = ((hash2 << 5) + hash2) + salted.charCodeAt(i);
  }
  return Math.abs(hash2).toString(36).toUpperCase();
}

// ×§×•×“×™ ×”×¤×¢×œ×” ××•×¦×¤× ×™× - ×œ×”×•×¡×¤×ª ×§×•×“ ×—×“×©:
// 1. ×”×¤×¢×œ ×‘×§×•× ×¡×•×œ: hashCode('NAHAG-XXX')
// 2. ×”×•×¡×£ ××ª ×”×ª×•×¦××” ×œ××˜×” ×¢× ×©× ×”××•×¨×”
const VALID_LICENSES = {
  'MZHCWP': '××•×¨×” ×œ×“×•×’××”',       // NAHAG-001
  'MYRXUG': '××•×¨×” × ×”×™×’×” 2',      // NAHAG-002
  'NDLQ5P': '××•×¨×” × ×”×™×’×” 3',      // NAHAG-003
  'NCWB3G': '××•×¨×” × ×”×™×’×” 4',      // NAHAG-004
  'NC6W17': '××•×¨×” × ×”×™×’×” 5',      // NAHAG-005
  '1F70W2A': '××‘×™ ××œ×—×¨×¨',        // NAHAG-AVI
  // ×œ×”×•×¡×¤×ª ×§×•×“×™×: hashCode('CODE') ×‘×§×•× ×¡×•×œ â† ×”×•×¡×£ ×ª×•×¦××” ×›××Ÿ
};

let currentLicense = null;
let licensedName = null;

function checkLicense() {
  const savedHash = localStorage.getItem('drv_license_hash');
  const savedName = localStorage.getItem('drv_licensed_name');

  // Check new hash-based license
  if (savedHash && VALID_LICENSES[savedHash]) {
    currentLicense = savedHash;
    licensedName = savedName || VALID_LICENSES[savedHash];
    hideLicenseScreen();
    updateLicensedBadge();
    return true;
  }

  // Migrate old plain-text license to hash
  const oldLicense = localStorage.getItem('drv_license');
  if (oldLicense) {
    const oldHash = hashCode(oldLicense.toUpperCase());
    if (VALID_LICENSES[oldHash]) {
      localStorage.setItem('drv_license_hash', oldHash);
      localStorage.removeItem('drv_license'); // Clean up old key
      currentLicense = oldHash;
      licensedName = savedName || VALID_LICENSES[oldHash];
      hideLicenseScreen();
      updateLicensedBadge();
      return true;
    }
  }

  showLicenseScreen();
  return false;
}

function showLicenseScreen() {
  document.getElementById('licenseScreen').classList.remove('hidden');
}

function hideLicenseScreen() {
  document.getElementById('licenseScreen').classList.add('hidden');
}

function activateLicense() {
  const input = document.getElementById('licenseCodeInput');
  const error = document.getElementById('licenseError');
  const code = input.value.trim().toUpperCase();
  const codeHash = hashCode(code);

  if (VALID_LICENSES[codeHash]) {
    // ×§×•×“ ×ª×§×™×Ÿ
    currentLicense = codeHash;
    licensedName = VALID_LICENSES[codeHash];
    localStorage.setItem('drv_license_hash', codeHash);
    localStorage.setItem('drv_licensed_name', licensedName);
    error.classList.remove('show');
    hideLicenseScreen();
    updateLicensedBadge();
    showToast('âœ… ×”××¤×œ×™×§×¦×™×” ×”×•×¤×¢×œ×” ×‘×”×¦×œ×—×”!');
    renderAll();
  } else {
    // ×§×•×“ ×œ× ×ª×§×™×Ÿ
    error.classList.add('show');
    input.style.borderColor = 'var(--danger)';
    setTimeout(() => { input.style.borderColor = ''; }, 2000);
  }
}

function updateLicensedBadge() {
  const badge = document.getElementById('licensedBadge');
  if (licensedName) {
    badge.textContent = licensedName;
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
}

// ×”×•×¡×£ ××§×£ ××•×˜×•××˜×™ ×‘×–××Ÿ ×”×§×œ×“×”
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('licenseCodeInput');
  if (input) {
    input.addEventListener('input', (e) => {
      let val = e.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
      if (val.length > 5) {
        val = val.slice(0, 5) + '-' + val.slice(5, 8);
      }
      e.target.value = val;
    });

    // ××¤×©×¨ ×œ×œ×—×•×¥ Enter ×œ×”×¤×¢×œ×”
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') activateLicense();
    });
  }
});

// ============================================================
// FIREBASE SYNC & CLOUD BACKUP (Subcollections + Firestore as source of truth)
// ============================================================
let firebaseUserId = null;
let isOnline = navigator.onLine;
let syncInProgress = false;
let pendingSync = false;
let lastSyncTime = null;
let hasPendingLocalChanges = false;

// Offline detection
window.addEventListener('online', () => {
  isOnline = true;
  document.getElementById('offlineBanner').classList.remove('show');
  document.body.classList.remove('is-offline');
  showToast('âœ… ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×—×–×¨');
  // Sync pending local changes to Firestore
  if (firebaseUserId && hasPendingLocalChanges) syncToCloud();
});

window.addEventListener('offline', () => {
  isOnline = false;
  document.getElementById('offlineBanner').classList.add('show');
  document.body.classList.add('is-offline');
});

// Initialize offline state
if (!navigator.onLine) {
  document.getElementById('offlineBanner').classList.add('show');
  document.body.classList.add('is-offline');
}

// Multi-tab sync: reload data when another tab modifies localStorage
window.addEventListener('storage', (e) => {
  if (e.key === 'drv_students' || e.key === 'drv_lessons' || e.key === 'drv_payments') {
    try {
      const rawStudents = JSON.parse(localStorage.getItem('drv_students') || '[]');
      const rawLessons = JSON.parse(localStorage.getItem('drv_lessons') || '[]');
      const rawPayments = JSON.parse(localStorage.getItem('drv_payments') || '[]');

      if (Array.isArray(rawStudents) && Array.isArray(rawLessons) && Array.isArray(rawPayments)) {
        const validStudentIds = new Set();
        const newStudents = [];
        for (const s of rawStudents) {
          const validated = validateStudent(s);
          if (validated) { newStudents.push(validated); validStudentIds.add(validated.id); }
        }
        const newLessons = [];
        for (const l of rawLessons) {
          const validated = validateLesson(l, validStudentIds);
          if (validated) newLessons.push(validated);
        }
        const newPayments = [];
        for (const p of rawPayments) {
          const validated = validatePayment(p, validStudentIds);
          if (validated) newPayments.push(validated);
        }
        students = newStudents;
        lessons = newLessons;
        payments = newPayments;
        invalidateBalanceCache();
        renderAll();
      }
    } catch (err) {
      console.error('Multi-tab sync error:', err);
    }
  } else if (e.key === 'drv_vehicle' || e.key === 'drv_km_history') {
    try {
      vehicleData = JSON.parse(localStorage.getItem('drv_vehicle') || 'null');
      kmHistory = JSON.parse(localStorage.getItem('drv_km_history') || '[]');
      if (currentPage === 'vehicle') renderVehiclePage();
    } catch (err) {
      console.error('Multi-tab vehicle sync error:', err);
    }
  }
});

// Show sync indicator
function showSyncIndicator(status, text) {
  const indicator = document.getElementById('syncIndicator');
  const textEl = document.getElementById('syncText');
  indicator.className = 'sync-indicator show ' + status;
  textEl.textContent = text;
  if (status === 'synced') {
    setTimeout(() => indicator.classList.remove('show'), 2000);
  }
}

// Save to localStorage as cache
function saveToLocalCache() {
  try {
    localStorage.setItem('drv_students', JSON.stringify(students));
    localStorage.setItem('drv_lessons', JSON.stringify(lessons));
    localStorage.setItem('drv_payments', JSON.stringify(payments));
    localStorage.setItem('drv_vehicle', JSON.stringify(vehicleData));
    localStorage.setItem('drv_km_history', JSON.stringify(kmHistory));
    localStorage.setItem('drv_last_save', new Date().toISOString());
  } catch(e) {
    console.error('localStorage save error:', e);
  }
}

// ---- SUBCOLLECTION SYNC: Write all data to Firestore subcollections ----
async function syncToCloud() {
  if (dataCorrupted) {
    console.warn('syncToCloud blocked: data is corrupted');
    return;
  }
  if (!window.firebaseReady || !firebaseUserId || !isOnline) {
    pendingSync = true;
    hasPendingLocalChanges = true;
    return;
  }
  if (syncInProgress) {
    pendingSync = true;
    return;
  }

  syncInProgress = true;
  showSyncIndicator('syncing', '××¡× ×›×¨×Ÿ...');

  try {
    const db = window.firebaseDB;
    const uid = firebaseUserId;

    // Update user profile doc
    const userDocRef = window.firebaseDoc(db, 'users', uid);
    await window.firebaseSetDoc(userDocRef, {
      phone: localStorage.getItem('drv_user_phone') || '',
      lastUpdated: new Date().toISOString(),
      appVersion: '3.0',
      dataFormat: 'subcollections'
    }, { merge: true });

    // Batch write students
    await syncSubcollection(db, uid, 'students', students, 'id');
    // Batch write lessons
    await syncSubcollection(db, uid, 'lessons', lessons, 'id');
    // Batch write payments
    await syncSubcollection(db, uid, 'payments', payments, 'id');

    // Vehicle data (single doc)
    const vehicleDocRef = window.firebaseDoc(db, 'users', uid, 'vehicle', 'data');
    if (vehicleData) {
      await window.firebaseSetDoc(vehicleDocRef, {
        ...vehicleData,
        kmHistory: kmHistory || [],
        lastUpdated: new Date().toISOString()
      });
    } else {
      // Write empty vehicle doc so we know the format
      await window.firebaseSetDoc(vehicleDocRef, {
        kmHistory: kmHistory || [],
        lastUpdated: new Date().toISOString()
      });
    }

    lastSyncTime = new Date();
    hasPendingLocalChanges = false;
    showSyncIndicator('synced', 'âœ“ ××¡×•× ×›×¨×Ÿ');
    localStorage.setItem('drv_last_cloud_sync', lastSyncTime.toISOString());
  } catch (err) {
    console.error('Sync error:', err);
    showSyncIndicator('error', 'âš ï¸ ×©×’×™××ª ×¡× ×›×¨×•×Ÿ');
    pendingSync = true;
    hasPendingLocalChanges = true;
  } finally {
    syncInProgress = false;
    if (pendingSync) {
      pendingSync = false;
      setTimeout(syncToCloud, 2000);
    }
  }
}

// Sync a subcollection: delete removed docs, set current docs using batch writes
async function syncSubcollection(db, uid, collName, items, idField) {
  const collRef = window.firebaseCollection(db, 'users', uid, collName);

  // Get existing docs in the subcollection
  const existingSnap = await window.firebaseGetDocs(collRef);
  const existingIds = new Set();
  existingSnap.forEach(doc => existingIds.add(doc.id));

  const currentIds = new Set(items.map(item => item[idField]));

  // Process in batches of 500 (Firestore limit)
  const BATCH_SIZE = 450;
  let batch = window.firebaseWriteBatch(db);
  let opCount = 0;

  // Delete removed items
  for (const existId of existingIds) {
    if (!currentIds.has(existId)) {
      const docRef = window.firebaseDoc(db, 'users', uid, collName, existId);
      batch.delete(docRef);
      opCount++;
      if (opCount >= BATCH_SIZE) {
        await batch.commit();
        batch = window.firebaseWriteBatch(db);
        opCount = 0;
      }
    }
  }

  // Set/update current items
  for (const item of items) {
    const docRef = window.firebaseDoc(db, 'users', uid, collName, item[idField]);
    batch.set(docRef, item);
    opCount++;
    if (opCount >= BATCH_SIZE) {
      await batch.commit();
      batch = window.firebaseWriteBatch(db);
      opCount = 0;
    }
  }

  if (opCount > 0) {
    await batch.commit();
  }
}

// ---- SUBCOLLECTION LOAD: Read all data from Firestore subcollections ----
async function loadFromCloud(forceLoad = false) {
  if (!window.firebaseReady || !firebaseUserId) return false;

  try {
    const db = window.firebaseDB;
    const uid = firebaseUserId;

    // Check user doc first
    const userDocRef = window.firebaseDoc(db, 'users', uid);
    const userDocSnap = await window.firebaseGetDoc(userDocRef);

    if (!userDocSnap.exists()) return false;

    const userData = userDocSnap.data();

    // Check if data is in old format (single-doc blob) and needs migration
    if (userData.students && Array.isArray(userData.students)) {
      console.log('Old format detected - migrating to subcollections...');
      await migrateOldFormatToSubcollections(db, uid, userData);
      // After migration, continue loading from subcollections
    }

    // Check timestamps
    const cloudTime = new Date(userData.lastUpdated || 0);
    const localTime = new Date(localStorage.getItem('drv_last_save') || 0);

    if (!forceLoad && cloudTime <= localTime && !hasPendingLocalChanges) {
      return false; // Local is newer or same
    }

    // Load from subcollections
    const [studentsSnap, lessonsSnap, paymentsSnap, vehicleSnap] = await Promise.all([
      window.firebaseGetDocs(window.firebaseCollection(db, 'users', uid, 'students')),
      window.firebaseGetDocs(window.firebaseCollection(db, 'users', uid, 'lessons')),
      window.firebaseGetDocs(window.firebaseCollection(db, 'users', uid, 'payments')),
      window.firebaseGetDoc(window.firebaseDoc(db, 'users', uid, 'vehicle', 'data'))
    ]);

    // Build arrays from subcollection docs
    const cloudStudents = [];
    const validStudentIds = new Set();
    studentsSnap.forEach(doc => {
      const validated = validateStudent(doc.data());
      if (validated) {
        cloudStudents.push(validated);
        validStudentIds.add(validated.id);
      }
    });

    const cloudLessons = [];
    lessonsSnap.forEach(doc => {
      const validated = validateLesson(doc.data(), validStudentIds);
      if (validated) cloudLessons.push(validated);
    });

    const cloudPayments = [];
    paymentsSnap.forEach(doc => {
      const validated = validatePayment(doc.data(), validStudentIds);
      if (validated) cloudPayments.push(validated);
    });

    let cloudVehicle = null;
    let cloudKmHistory = [];
    if (vehicleSnap.exists()) {
      const vData = vehicleSnap.data();
      cloudVehicle = validateVehicleData(vData);
      cloudKmHistory = validateKmHistory(vData.kmHistory);
    }

    // If we have pending local changes and cloud data, do last-write-wins merge
    if (hasPendingLocalChanges && !forceLoad) {
      // Merge: take items with latest timestamps
      students = mergeByTimestamp(students, cloudStudents);
      lessons = mergeByTimestamp(lessons, cloudLessons);
      payments = mergeByTimestamp(payments, cloudPayments);
    } else {
      // Direct load from cloud
      if (cloudStudents.length > 0 || cloudLessons.length > 0 || cloudPayments.length > 0 || forceLoad) {
        students = cloudStudents;
        lessons = cloudLessons;
        payments = cloudPayments;
      }
    }

    if (cloudVehicle !== undefined) vehicleData = cloudVehicle;
    kmHistory = cloudKmHistory;

    // Update localStorage cache
    saveToLocalCache();

    // Clear corrupted state if cloud load succeeded
    if (dataCorrupted) {
      dataCorrupted = false;
      const banner = document.getElementById('corruptedBanner');
      if (banner) {
        banner.remove();
        document.body.style.paddingTop = '';
      }
    }

    invalidateBalanceCache();
    hasPendingLocalChanges = false;
    return true;
  } catch (err) {
    console.error('Load from cloud error:', err);
    return false;
  }
}

// Last-write-wins merge for offline conflict resolution
function mergeByTimestamp(localItems, cloudItems) {
  const merged = new Map();

  // Add cloud items first
  for (const item of cloudItems) {
    merged.set(item.id, item);
  }

  // Override with local items that are newer (by createdAt or just override)
  for (const item of localItems) {
    const existing = merged.get(item.id);
    if (!existing) {
      merged.set(item.id, item); // New local item not in cloud
    } else {
      // Compare timestamps - local wins if newer
      const localTime = new Date(item.createdAt || 0).getTime();
      const cloudTime = new Date(existing.createdAt || 0).getTime();
      if (localTime >= cloudTime) {
        merged.set(item.id, item);
      }
    }
  }

  return Array.from(merged.values());
}

// Migrate old single-document format to subcollections
async function migrateOldFormatToSubcollections(db, uid, oldData) {
  try {
    showSyncIndicator('syncing', '××¢×‘×™×¨ × ×ª×•× ×™×...');

    const validStudentIds = new Set();
    const migratedStudents = [];
    if (Array.isArray(oldData.students)) {
      for (const s of oldData.students) {
        const validated = validateStudent(s);
        if (validated) {
          migratedStudents.push(validated);
          validStudentIds.add(validated.id);
        }
      }
    }

    const migratedLessons = [];
    if (Array.isArray(oldData.lessons)) {
      for (const l of oldData.lessons) {
        const validated = validateLesson(l, validStudentIds);
        if (validated) migratedLessons.push(validated);
      }
    }

    const migratedPayments = [];
    if (Array.isArray(oldData.payments)) {
      for (const p of oldData.payments) {
        const validated = validatePayment(p, validStudentIds);
        if (validated) migratedPayments.push(validated);
      }
    }

    // Write to subcollections
    await syncSubcollection(db, uid, 'students', migratedStudents, 'id');
    await syncSubcollection(db, uid, 'lessons', migratedLessons, 'id');
    await syncSubcollection(db, uid, 'payments', migratedPayments, 'id');

    // Vehicle data
    const vehicleDocRef = window.firebaseDoc(db, 'users', uid, 'vehicle', 'data');
    const vData = oldData.vehicleData ? validateVehicleData(oldData.vehicleData) : null;
    const kHistory = validateKmHistory(oldData.kmHistory);
    await window.firebaseSetDoc(vehicleDocRef, {
      ...(vData || {}),
      kmHistory: kHistory,
      lastUpdated: new Date().toISOString()
    });

    // Update user doc to mark migration complete and remove old blob data
    const userDocRef = window.firebaseDoc(db, 'users', uid);
    await window.firebaseSetDoc(userDocRef, {
      lastUpdated: new Date().toISOString(),
      appVersion: '3.0',
      dataFormat: 'subcollections',
      migratedAt: new Date().toISOString()
    });

    console.log('Migration to subcollections complete');
    showSyncIndicator('synced', 'âœ“ ××™×’×¨×¦×™×” ×”×•×©×œ××”');
  } catch (err) {
    console.error('Migration error:', err);
    showSyncIndicator('error', 'âš ï¸ ×©×’×™××ª ××™×’×¨×¦×™×”');
  }
}

// Validate cloud data (for old-format compatibility)
function validateCloudData(data) {
  const validatedStudents = [];
  const validStudentIds = new Set();
  if (Array.isArray(data.students)) {
    for (const s of data.students) {
      const validated = validateStudent(s);
      if (validated) {
        validatedStudents.push(validated);
        validStudentIds.add(validated.id);
      }
    }
  }
  const validatedLessons = [];
  if (Array.isArray(data.lessons)) {
    for (const l of data.lessons) {
      const validated = validateLesson(l, validStudentIds);
      if (validated) validatedLessons.push(validated);
    }
  }
  const validatedPayments = [];
  if (Array.isArray(data.payments)) {
    for (const p of data.payments) {
      const validated = validatePayment(p, validStudentIds);
      if (validated) validatedPayments.push(validated);
    }
  }
  const validatedVehicle = data.vehicleData !== undefined ? validateVehicleData(data.vehicleData) : undefined;
  const validatedKmHistory = validateKmHistory(data.kmHistory);
  return {
    students: validatedStudents,
    lessons: validatedLessons,
    payments: validatedPayments,
    vehicleData: validatedVehicle,
    kmHistory: validatedKmHistory
  };
}

// Force recovery from cloud
async function recoverFromCloud() {
  if (!window.firebaseReady || !firebaseUserId) {
    showToast('××™×Ÿ ×—×™×‘×•×¨ ×œ×¢× ×Ÿ - × × ×œ×”×ª×—×‘×¨ ×œ××™× ×˜×¨× ×˜');
    return;
  }

  const confirmed = await customConfirm(
    '×”×× ×œ×©×—×–×¨ ××ª ×”× ×ª×•× ×™× ××”×¢× ×Ÿ?\n\n×¤×¢×•×œ×” ×–×• ×ª×—×œ×™×£ ××ª ×”× ×ª×•× ×™× ×”××§×•××™×™× ×‘× ×ª×•× ×™× ××”×’×™×‘×•×™ ×”××—×¨×•×Ÿ ×‘×¢× ×Ÿ.',
    '×©×—×–×•×¨ ××”×¢× ×Ÿ',
    'â˜ï¸'
  );
  if (!confirmed) return;

  showLoading();
  try {
    const success = await loadFromCloud(true);
    if (success) {
      showToast('×”× ×ª×•× ×™× ×©×•×—×–×¨×• ×‘×”×¦×œ×—×” ××”×¢× ×Ÿ');
      renderAll();
    } else {
      showToast('×œ× × ××¦××• × ×ª×•× ×™× ×‘×¢× ×Ÿ ×œ×©×—×–×•×¨');
    }
  } finally {
    hideLoading();
  }
}

// ============================================================
// PHONE AUTH (OTP) SYSTEM
// ============================================================
let phoneRecaptchaVerifier = null;
let phoneConfirmationResult = null;
let otpTimerInterval = null;

function showLoginScreen() {
  document.getElementById('loginScreen').classList.remove('hidden');
}

function hideLoginScreen() {
  document.getElementById('loginScreen').classList.add('hidden');
}

function resetLoginToPhone() {
  document.getElementById('loginStepPhone').classList.add('active');
  document.getElementById('loginStepOtp').classList.remove('active');
  document.getElementById('loginPhoneError').classList.remove('show');
  document.getElementById('loginOtpError').classList.remove('show');
  document.getElementById('loginPhone').value = '';
  document.getElementById('loginOtpCode').value = '';
  document.getElementById('loginSendCodeBtn').disabled = false;
  if (otpTimerInterval) clearInterval(otpTimerInterval);
}

function setupRecaptcha() {
  if (phoneRecaptchaVerifier) return;
  try {
    phoneRecaptchaVerifier = new window.firebaseRecaptchaVerifier(window.firebaseAuth, 'recaptcha-container', {
      size: 'invisible',
      callback: () => {
        // reCAPTCHA solved
      }
    });
  } catch (err) {
    console.error('reCAPTCHA setup error:', err);
  }
}

async function sendOtpCode() {
  const phoneInput = document.getElementById('loginPhone').value.trim();
  const errorEl = document.getElementById('loginPhoneError');
  const sendBtn = document.getElementById('loginSendCodeBtn');

  // Clean and validate phone number
  const digits = phoneInput.replace(/[\s\-()]/g, '');
  if (!digits || digits.length < 9 || !/^\d+$/.test(digits)) {
    errorEl.textContent = 'âŒ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ';
    errorEl.classList.add('show');
    return;
  }

  // Format to international
  let fullNumber;
  if (digits.startsWith('0')) {
    fullNumber = '+972' + digits.slice(1);
  } else if (digits.startsWith('972')) {
    fullNumber = '+' + digits;
  } else {
    fullNumber = '+972' + digits;
  }

  errorEl.classList.remove('show');
  sendBtn.disabled = true;
  sendBtn.textContent = 'â³ ×©×•×œ×—...';

  try {
    setupRecaptcha();
    phoneConfirmationResult = await window.firebaseSignInWithPhoneNumber(
      window.firebaseAuth,
      fullNumber,
      phoneRecaptchaVerifier
    );

    // Switch to OTP step
    document.getElementById('loginStepPhone').classList.remove('active');
    document.getElementById('loginStepOtp').classList.add('active');
    document.getElementById('loginOtpInfo').textContent = `×§×•×“ ××™××•×ª × ×©×œ×— ×œ-${fullNumber}`;

    // Store phone for later use
    localStorage.setItem('drv_user_phone', fullNumber);

    // Start countdown timer (60 seconds)
    startOtpTimer(60);
  } catch (err) {
    console.error('Send OTP error:', err);
    let errorMsg = 'âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×§×•×“ (' + (err.code || err.message || 'unknown') + ')';
    if (err.code === 'auth/invalid-phone-number') errorMsg = 'âŒ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ';
    else if (err.code === 'auth/too-many-requests') errorMsg = 'âŒ ×™×•×ª×¨ ××“×™ × ×™×¡×™×•× ×•×ª, × ×¡×” ×××•×—×¨ ×™×•×ª×¨';
    else if (err.code === 'auth/quota-exceeded') errorMsg = 'âŒ ×—×¨×’×ª ×××›×¡×ª ×”×©×œ×™×—×•×ª, × ×¡×” ×××•×—×¨ ×™×•×ª×¨';
    else if (err.code === 'auth/operation-not-allowed') errorMsg = 'âŒ Phone Auth ×œ× ××•×¤×¢×œ - ×™×© ×œ×”×¤×¢×™×œ ×‘-Firebase Console';
    else if (err.code === 'auth/invalid-app-credential') errorMsg = 'âŒ ×‘×¢×™×™×ª reCAPTCHA - ×¨×¢× ×Ÿ ××ª ×”×“×£ ×•× ×¡×” ×©×•×‘';
    else if (err.code === 'auth/network-request-failed') errorMsg = 'âŒ ×‘×¢×™×™×ª ×¨×©×ª - ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜';
    errorEl.textContent = errorMsg;
    errorEl.classList.add('show');
    sendBtn.disabled = false;
    sendBtn.textContent = 'ğŸ“± ×©×œ×— ×§×•×“ ××™××•×ª';
    // Reset reCAPTCHA for retry
    phoneRecaptchaVerifier = null;
  }
}

function startOtpTimer(seconds) {
  let remaining = seconds;
  const timerEl = document.getElementById('loginTimer');
  timerEl.textContent = `× ×™×ª×Ÿ ×œ×©×œ×•×— ×©×•×‘ ×‘×¢×•×“ ${remaining} ×©× ×™×•×ª`;
  if (otpTimerInterval) clearInterval(otpTimerInterval);
  otpTimerInterval = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(otpTimerInterval);
      timerEl.innerHTML = '<button class="login-btn-outline" onclick="resetLoginToPhone();sendOtpCode()">ğŸ“± ×©×œ×— ×§×•×“ ×—×“×©</button>';
    } else {
      timerEl.textContent = `× ×™×ª×Ÿ ×œ×©×œ×•×— ×©×•×‘ ×‘×¢×•×“ ${remaining} ×©× ×™×•×ª`;
    }
  }, 1000);
}

async function verifyOtpCode() {
  const code = document.getElementById('loginOtpCode').value.trim();
  const errorEl = document.getElementById('loginOtpError');
  const verifyBtn = document.getElementById('loginVerifyBtn');

  if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
    errorEl.textContent = 'âŒ ×§×•×“ ××™××•×ª ×—×™×™×‘ ×œ×”×›×™×œ 6 ×¡×¤×¨×•×ª';
    errorEl.classList.add('show');
    return;
  }

  if (!phoneConfirmationResult) {
    errorEl.textContent = 'âŒ ×©×’×™××” - × × ×œ×©×œ×•×— ×§×•×“ ×—×“×©';
    errorEl.classList.add('show');
    return;
  }

  errorEl.classList.remove('show');
  verifyBtn.disabled = true;
  verifyBtn.textContent = 'â³ ××××ª...';

  try {
    await phoneConfirmationResult.confirm(code);
    // onAuthStateChanged will handle the rest
    hideLoginScreen();
    if (otpTimerInterval) clearInterval(otpTimerInterval);
  } catch (err) {
    console.error('Verify OTP error:', err);
    let errorMsg = 'âŒ ×§×•×“ ×©×’×•×™, × ×¡×” ×©×•×‘';
    if (err.code === 'auth/invalid-verification-code') errorMsg = 'âŒ ×§×•×“ ××™××•×ª ×©×’×•×™';
    else if (err.code === 'auth/code-expired') errorMsg = 'âŒ ×”×§×•×“ ×¤×’ ×ª×•×§×£ - ×©×œ×— ×§×•×“ ×—×“×©';
    errorEl.textContent = errorMsg;
    errorEl.classList.add('show');
    verifyBtn.disabled = false;
    verifyBtn.textContent = 'ğŸ”“ ×›× ×™×¡×”';
  }
}

async function logoutUser() {
  const confirmed = await customConfirm('×”×× ×œ×”×ª× ×ª×§?\n\n×”× ×ª×•× ×™× ×©×œ×š × ×©××¨×™× ×‘×¢× ×Ÿ ×•×ª×•×›×œ ×œ×”×ª×—×‘×¨ ×©×•×‘ ××›×œ ××›×©×™×¨.', '×”×ª× ×ª×§×•×ª', 'ğŸšª');
  if (!confirmed) return;

  try {
    await window.firebaseSignOut(window.firebaseAuth);
    firebaseUserId = null;
    localStorage.removeItem('drv_firebase_uid');
    localStorage.removeItem('drv_user_phone');
    showLoginScreen();
    showToast('âœ… ×”×ª× ×ª×§×ª ×‘×”×¦×œ×—×”');
  } catch (err) {
    console.error('Logout error:', err);
    showToast('âŒ ×©×’×™××” ×‘×”×ª× ×ª×§×•×ª');
  }
}

// Migrate anonymous auth data to phone auth account
async function migrateAnonymousToPhone(anonymousUid, newUid) {
  if (!anonymousUid || anonymousUid === newUid) return;
  try {
    const db = window.firebaseDB;

    // Check if anonymous user had old-format data
    const oldUserDoc = window.firebaseDoc(db, 'users', anonymousUid);
    const oldDocSnap = await window.firebaseGetDoc(oldUserDoc);

    if (oldDocSnap.exists()) {
      const oldData = oldDocSnap.data();

      // Check if old format (blob) or new format (subcollections)
      if (oldData.students && Array.isArray(oldData.students)) {
        // Old format: migrate blob to new user's subcollections
        await migrateOldFormatToSubcollections(db, newUid, oldData);
      } else {
        // New format: copy subcollections
        const collections = ['students', 'lessons', 'payments'];
        for (const collName of collections) {
          const oldCollRef = window.firebaseCollection(db, 'users', anonymousUid, collName);
          const snap = await window.firebaseGetDocs(oldCollRef);
          if (!snap.empty) {
            const items = [];
            snap.forEach(doc => items.push(doc.data()));
            await syncSubcollection(db, newUid, collName, items, 'id');
          }
        }

        // Copy vehicle data
        const oldVehicleDoc = window.firebaseDoc(db, 'users', anonymousUid, 'vehicle', 'data');
        const oldVehicleSnap = await window.firebaseGetDoc(oldVehicleDoc);
        if (oldVehicleSnap.exists()) {
          const newVehicleDoc = window.firebaseDoc(db, 'users', newUid, 'vehicle', 'data');
          await window.firebaseSetDoc(newVehicleDoc, oldVehicleSnap.data());
        }
      }

      console.log('Anonymous data migrated to phone auth account');
    }
  } catch (err) {
    console.error('Migration from anonymous error:', err);
  }
}

// Initialize Firebase auth - Phone Auth with persistent login
function initFirebaseAuth() {
  if (!window.firebaseReady) {
    window.addEventListener('firebaseReady', initFirebaseAuth);
    return;
  }

  window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
    if (user) {
      // User is signed in
      const isPhoneUser = user.providerData && user.providerData.some(p => p.providerId === 'phone');
      const isAnonymous = user.isAnonymous;

      if (isPhoneUser || isAnonymous) {
        const previousUid = localStorage.getItem('drv_firebase_uid');
        firebaseUserId = user.uid;
        localStorage.setItem('drv_firebase_uid', user.uid);

        // If we had anonymous data and now have phone auth, migrate
        if (isPhoneUser && previousUid && previousUid !== user.uid) {
          showLoading('××¢×‘×™×¨ × ×ª×•× ×™×...');
          await migrateAnonymousToPhone(previousUid, user.uid);
          hideLoading();
        }

        hideLoginScreen();

        // Update logged-in phone display
        const phoneDisplay = document.getElementById('loggedInPhone');
        if (phoneDisplay) {
          const phone = user.phoneNumber || localStorage.getItem('drv_user_phone') || '';
          phoneDisplay.textContent = phone ? `ğŸ“± ${phone}` : '';
        }

        // Try to load from cloud (Firestore is source of truth when online)
        if (isOnline) {
          const loadedFromCloud = await loadFromCloud();
          if (loadedFromCloud) {
            renderAll();
          } else {
            // No cloud data yet, or local is newer - sync local to cloud
            syncToCloud();
          }
        }
      }
    } else {
      // No user - show login screen
      firebaseUserId = null;
      showLoginScreen();
    }
  });
}

// Auto-format phone input
document.addEventListener('DOMContentLoaded', () => {
  const phoneInput = document.getElementById('loginPhone');
  if (phoneInput) {
    phoneInput.addEventListener('input', (e) => {
      let val = e.target.value.replace(/[^\d\-]/g, '');
      e.target.value = val;
    });
    phoneInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendOtpCode();
    });
  }
  const otpInput = document.getElementById('loginOtpCode');
  if (otpInput) {
    otpInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^\d]/g, '').slice(0, 6);
    });
    otpInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') verifyOtpCode();
    });
  }
});

// Start Firebase auth when ready
if (window.firebaseReady) {
  initFirebaseAuth();
} else {
  window.addEventListener('firebaseReady', initFirebaseAuth);
}

// ============================================================
// INDEXEDDB BACKUP LAYER
// ============================================================
const IDB_NAME = 'nahag-ba-seder-backup';
const IDB_VERSION = 1;
let idbDatabase = null;

function openIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(IDB_NAME, IDB_VERSION);

    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      idbDatabase = request.result;
      resolve(idbDatabase);
    };

    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('backup')) {
        db.createObjectStore('backup', { keyPath: 'id' });
      }
    };
  });
}

async function saveToIndexedDB() {
  try {
    if (!idbDatabase) await openIndexedDB();

    const transaction = idbDatabase.transaction(['backup'], 'readwrite');
    const store = transaction.objectStore('backup');

    await new Promise((resolve, reject) => {
      const request = store.put({
        id: 'main',
        students: students,
        lessons: lessons,
        payments: payments,
        vehicleData: vehicleData,
        kmHistory: kmHistory,
        savedAt: new Date().toISOString()
      });
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  } catch (err) {
    console.error('IndexedDB save error:', err);
  }
}

async function loadFromIndexedDB() {
  try {
    if (!idbDatabase) await openIndexedDB();

    return new Promise((resolve, reject) => {
      const transaction = idbDatabase.transaction(['backup'], 'readonly');
      const store = transaction.objectStore('backup');
      const request = store.get('main');

      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (err) {
    console.error('IndexedDB load error:', err);
    return null;
  }
}

// Initialize IndexedDB
openIndexedDB().catch(err => console.error('IndexedDB init error:', err));

// ============================================================
// CUSTOM CONFIRM DIALOG
// ============================================================
let confirmResolve = null;

function customConfirm(message, title = '××™×©×•×¨', icon = 'âš ï¸') {
  return new Promise((resolve) => {
    // If a previous confirm is still open, resolve it as false (cancelled)
    if (confirmResolve) {
      confirmResolve(false);
    }
    confirmResolve = resolve;
    document.getElementById('confirmIcon').textContent = icon;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmOverlay').classList.add('show');
  });
}

document.getElementById('confirmYes').addEventListener('click', () => {
  document.getElementById('confirmOverlay').classList.remove('show');
  if (confirmResolve) { confirmResolve(true); confirmResolve = null; }
});

document.getElementById('confirmNo').addEventListener('click', () => {
  document.getElementById('confirmOverlay').classList.remove('show');
  if (confirmResolve) { confirmResolve(false); confirmResolve = null; }
});

// ============================================================
// LOADING OVERLAY
// ============================================================
function showLoading(text = '×˜×•×¢×Ÿ...') {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loadingOverlay').classList.add('show');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('show');
}

// ============================================================
// UNDO/SOFT DELETE SYSTEM
// ============================================================
let deletedItems = { students: [], lessons: [], payments: [] };
let undoTimeout = null;

function showUndoToast(message, type, item) {
  const toast = document.getElementById('undoToast');
  document.getElementById('undoMessage').textContent = message;
  toast.classList.add('show');

  // Clear previous timeout
  if (undoTimeout) clearTimeout(undoTimeout);

  // Store the deleted item for undo
  deletedItems[type].push(item);

  // Auto-hide after 5 seconds - clear ALL types to prevent orphaned data
  undoTimeout = setTimeout(() => {
    toast.classList.remove('show');
    deletedItems = { students: [], lessons: [], payments: [] };
  }, 5000);
}

document.getElementById('undoBtn').addEventListener('click', () => {
  // Restore the last deleted item
  if (deletedItems.students.length > 0) {
    const item = deletedItems.students.pop();
    students.push(item.student);
    lessons.push(...item.lessons);
    payments.push(...item.payments);

    if (!saveData()) {
      // Revert the undo - remove the items we just added
      students = students.filter(s => s.id !== item.student.id);
      lessons = lessons.filter(l => !item.lessons.some(dl => dl.id === l.id));
      payments = payments.filter(p => !item.payments.some(dp => dp.id === p.id));
      deletedItems.students.push(item); // Put item back for retry
      showToast('âŒ ×©×—×–×•×¨ × ×›×©×œ - × ×¡×” ×©×•×‘');
      return;
    }
    renderAll();
    showToast('â†©ï¸ ×”×ª×œ××™×“ ×©×•×—×–×¨');

  } else if (deletedItems.lessons.length > 0) {
    const item = deletedItems.lessons.pop();
    lessons.push(item);

    if (!saveData()) {
      lessons = lessons.filter(l => l.id !== item.id);
      deletedItems.lessons.push(item);
      showToast('âŒ ×©×—×–×•×¨ × ×›×©×œ - × ×¡×” ×©×•×‘');
      return;
    }
    renderAll();
    showToast('â†©ï¸ ×”×©×™×¢×•×¨ ×©×•×—×–×¨');

  } else if (deletedItems.payments.length > 0) {
    const item = deletedItems.payments.pop();
    payments.push(item);

    if (!saveData()) {
      payments = payments.filter(p => p.id !== item.id);
      deletedItems.payments.push(item);
      showToast('âŒ ×©×—×–×•×¨ × ×›×©×œ - × ×¡×” ×©×•×‘');
      return;
    }
    renderAll();
    showToast('â†©ï¸ ×”×ª×©×œ×•× ×©×•×—×–×¨');
  }

  document.getElementById('undoToast').classList.remove('show');
  if (undoTimeout) clearTimeout(undoTimeout);
});

// ============================================================
// GLOBAL SETTINGS (configurable lessons count)
// ============================================================
const DEFAULT_TOTAL_LESSONS = 28;

function getTotalLessonsForStudent(student) {
  // Check if student has custom total, otherwise use default
  return (student && typeof student.totalLessons === 'number') ? student.totalLessons : DEFAULT_TOTAL_LESSONS;
}

// ============================================================
// DATA
// ============================================================
let students, lessons, payments;
let dataCorrupted = false;

try {
  const rawStudents = JSON.parse(localStorage.getItem('drv_students') || '[]');
  const rawLessons = JSON.parse(localStorage.getItem('drv_lessons') || '[]');
  const rawPayments = JSON.parse(localStorage.getItem('drv_payments') || '[]');

  // Basic validation
  if (!Array.isArray(rawStudents) || !Array.isArray(rawLessons) || !Array.isArray(rawPayments)) {
    throw new Error('Invalid data format');
  }

  // Per-record validation to prevent XSS from tampered localStorage
  const validStudentIds = new Set();
  students = [];
  for (const s of rawStudents) {
    const validated = validateStudent(s);
    if (validated) {
      students.push(validated);
      validStudentIds.add(validated.id);
    }
  }

  lessons = [];
  for (const l of rawLessons) {
    const validated = validateLesson(l, validStudentIds);
    if (validated) lessons.push(validated);
  }

  payments = [];
  for (const p of rawPayments) {
    const validated = validatePayment(p, validStudentIds);
    if (validated) payments.push(validated);
  }
} catch(e) {
  dataCorrupted = true;
  students = []; lessons = []; payments = [];
  // Show persistent warning after page loads
  setTimeout(() => {
    showCorruptedDataBanner();
  }, 500);
}

// One-time migration: Add status to legacy lessons without status
// This prevents automatic billing based on date alone
(function migrateLegacyLessons() {
  const MIGRATION_KEY = 'drv_migration_lesson_status_v1';
  if (localStorage.getItem(MIGRATION_KEY)) return; // Already migrated
  if (dataCorrupted) return; // Don't migrate corrupted data

  let migrated = false;
  const today = new Date().toISOString().slice(0, 10);

  lessons.forEach(lesson => {
    if (!lesson.status) {
      // Legacy lesson without status - assign based on date
      lesson.status = lesson.date < today ? 'completed' : 'scheduled';
      migrated = true;
    }
  });

  if (migrated) {
    // Save migrated lessons
    localStorage.setItem('drv_lessons', JSON.stringify(lessons));
    console.log('Migration complete: Added status to legacy lessons');
  }

  // Mark migration as done
  localStorage.setItem(MIGRATION_KEY, new Date().toISOString());
})();

// Show persistent warning banner for corrupted data
function showCorruptedDataBanner() {
  if (!dataCorrupted) return;
  const banner = document.createElement('div');
  banner.id = 'corruptedBanner';
  banner.innerHTML = `
    <div style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;padding:16px 20px;text-align:center;position:fixed;top:0;left:0;right:0;z-index:9999;font-size:14px;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <div style="font-weight:700;margin-bottom:8px;">âš ï¸ × ×ª×•× ×™× ×¤×’×•××™× - ××¦×‘ ×§×¨×™××” ×‘×œ×‘×“</div>
      <div style="font-size:12px;opacity:0.9;margin-bottom:12px;">×œ× × ×™×ª×Ÿ ×œ×‘×¦×¢ ×©×™× ×•×™×™×. × × ×œ×©×—×–×¨ ××”×¢× ×Ÿ ××• ×œ×™×™×‘× ×’×™×‘×•×™.</div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
        <button onclick="recoverFromCloud()" style="background:white;color:#dc2626;border:none;padding:8px 20px;border-radius:8px;font-weight:600;cursor:pointer;">â˜ï¸ ×©×—×–×•×¨ ××”×¢× ×Ÿ</button>
        <button onclick="importData()" style="background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:8px 20px;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ“¥ ×™×™×‘×•× ×’×™×‘×•×™</button>
      </div>
    </div>
  `;
  document.body.insertBefore(banner, document.body.firstChild);
  // Add padding to body to prevent content from being hidden under banner
  document.body.style.paddingTop = '120px';
}

// Returns true if save succeeded, false if failed
// Firestore = source of truth when online; localStorage = cache + offline fallback
function saveData() {
  if (dataCorrupted) {
    showToast('âŒ ××¦×‘ ×§×¨×™××” ×‘×œ×‘×“ - ×œ× × ×™×ª×Ÿ ×œ×©××•×¨. × × ×œ×™×™×‘× ×’×™×‘×•×™.');
    return false;
  }
  try {
    // Always save to localStorage as cache (fast, synchronous)
    localStorage.setItem('drv_students', JSON.stringify(students));
    localStorage.setItem('drv_lessons', JSON.stringify(lessons));
    localStorage.setItem('drv_payments', JSON.stringify(payments));
    localStorage.setItem('drv_last_save', new Date().toISOString());

    // Invalidate balance cache on any data change
    invalidateBalanceCache();

    // Backup to IndexedDB (async, non-blocking)
    saveToIndexedDB();

    // Sync to Firestore (source of truth) - async, non-blocking
    if (isOnline && firebaseUserId) {
      syncToCloud();
    } else {
      // Mark that we have pending local changes to sync when back online
      hasPendingLocalChanges = true;
    }

    return true;
  } catch(e) {
    showToast('âŒ ×©×’×™××” ×‘×©××™×¨×”! ×”× ×ª×•× ×™× ×œ× × ×©××¨×•');
    return false;
  }
}

// ============================================================
// UTILS
// ============================================================
function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function formatPhone(p) { let c=p.replace(/[\s\-()+"]/g,''); c=c.replace(/^\+/,''); if(c.startsWith('972')) return c; if(c.startsWith('0')) return '972'+c.slice(1); return '972'+c; }
const DAYS_HEB = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
const DAYS_SHORT = ['××³','×‘×³','×’×³','×“×³','×”×³','×•×³','×©×³'];
const MONTHS_HEB = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];

function formatDateHeb(ds) {
  const d = new Date(ds+'T00:00:00');
  return `×™×•× ${DAYS_HEB[d.getDay()]}, ${d.getDate()} ${MONTHS_HEB[d.getMonth()]}`;
}
function dateStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

// REAL date functions - for calculations and customer messages
function getRealTodayStr() { return dateStr(new Date()); }
function getRealTomorrowStr() { const t = new Date(); t.setDate(t.getDate()+1); return dateStr(t); }

// "Working day" extends until 4:00 AM - for UI display only (dashboard, calendar)
function getWorkingDate() {
  const now = new Date();
  if (now.getHours() < 4) {
    now.setDate(now.getDate() - 1); // Before 4AM = still "yesterday"
  }
  return now;
}
function todayStr() { return dateStr(getWorkingDate()); }
function tomorrowStr() { const t = getWorkingDate(); t.setDate(t.getDate()+1); return dateStr(t); }
function isToday(ds) { return ds === todayStr(); }
function getInitials(n) { if(!n || !n.trim()) return '?'; return n.split(' ').map(w=>w[0]).join('').slice(0,2); }
function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
function fmtMoney(n) { return n.toLocaleString('he-IL'); }
function escHtml(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

// Sanitize string - remove potentially dangerous content and limit length
function sanitizeString(str, maxLen = 500) {
  if (typeof str !== 'string') return '';
  // Trim and limit length
  let clean = str.trim().slice(0, maxLen);
  // Remove null bytes and control characters (except newlines/tabs)
  clean = clean.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
  return clean;
}

// Validate and sanitize ID (alphanumeric only)
function sanitizeId(id) {
  if (typeof id !== 'string') return '';
  return id.replace(/[^a-zA-Z0-9_-]/g, '').slice(0, 50);
}

// Validate phone number format
function isValidPhone(phone) {
  if (typeof phone !== 'string') return false;
  const digits = phone.replace(/[\s\-()+"]/g, '').replace(/^\+/, '');
  return digits.length >= 9 && digits.length <= 15 && /^\d+$/.test(digits);
}

// Validate date string format (YYYY-MM-DD)
function isValidDateStr(dateStr) {
  if (typeof dateStr !== 'string') return false;
  return /^\d{4}-\d{2}-\d{2}$/.test(dateStr);
}

// Validate time string format (HH:MM)
function isValidTimeStr(timeStr) {
  if (typeof timeStr !== 'string') return false;
  return /^\d{2}:\d{2}$/.test(timeStr);
}

// Validate and sanitize a student object
function validateStudent(obj) {
  if (!obj || typeof obj !== 'object') return null;

  const id = sanitizeId(obj.id);
  const name = sanitizeString(obj.name, 100);
  const phone = sanitizeString(obj.phone, 20);

  // Required fields must be valid
  if (!id || !name || !isValidPhone(phone)) return null;

  // Support legacy lessonsDone field and new initialCompletedLessons
  const legacyDone = (typeof obj.lessonsDone === 'number') ? obj.lessonsDone : 0;
  const initialDoneRaw = (typeof obj.initialCompletedLessons === 'number') ? obj.initialCompletedLessons : legacyDone;
  const initialCompletedLessons = (Number.isFinite(initialDoneRaw) && initialDoneRaw >= 0 && initialDoneRaw <= 1000)
    ? Math.floor(initialDoneRaw)
    : 0;

  // Preserve totalLessons (custom lesson count per student)
  const totalLessonsRaw = (typeof obj.totalLessons === 'number') ? obj.totalLessons : undefined;
  const totalLessons = (totalLessonsRaw !== undefined && Number.isFinite(totalLessonsRaw) && totalLessonsRaw >= 1 && totalLessonsRaw <= 100)
    ? Math.floor(totalLessonsRaw)
    : DEFAULT_TOTAL_LESSONS;

  return {
    id: id,
    name: name,
    phone: phone,
    price: (typeof obj.price === 'number' && obj.price >= 0 && obj.price <= 10000) ? obj.price : 170,
    totalLessons: totalLessons,
    initialCompletedLessons: initialCompletedLessons,
    notes: sanitizeString(obj.notes || '', 1000),
    wantsExtraLessons: obj.wantsExtraLessons === true,
    createdAt: isValidDateStr(obj.createdAt?.slice(0, 10)) ? obj.createdAt : new Date().toISOString()
  };
}

// Validate and sanitize a lesson object
function validateLesson(obj, validStudentIds) {
  if (!obj || typeof obj !== 'object') return null;

  const id = sanitizeId(obj.id);
  const studentId = sanitizeId(obj.studentId);
  const date = obj.date;
  const time = obj.time;

  // Required fields must be valid
  if (!id || !studentId || !isValidDateStr(date) || !isValidTimeStr(time)) return null;
  // Student must exist
  if (!validStudentIds.has(studentId)) return null;

  // Validate and fix status - don't allow completed/no-show for future lessons
  let status = ['scheduled', 'completed', 'cancelled', 'no-show'].includes(obj.status) ? obj.status : 'scheduled';
  const realToday = getRealTodayStr();
  if ((status === 'completed' || status === 'no-show') && date > realToday) {
    status = 'scheduled'; // Future lesson can't be completed/no-show
  }

  return {
    id: id,
    studentId: studentId,
    studentName: sanitizeString(obj.studentName || '', 100),
    date: date,
    time: time,
    duration: (typeof obj.duration === 'number' && obj.duration >= 15 && obj.duration <= 480) ? obj.duration : 40,
    address: sanitizeString(obj.address || '', 200),
    // Don't default priceAtTime to 0 - leave undefined so it falls back to student price
    priceAtTime: (typeof obj.priceAtTime === 'number' && obj.priceAtTime >= 0 && obj.priceAtTime <= 10000) ? obj.priceAtTime : undefined,
    status: status,
    createdAt: obj.createdAt || new Date().toISOString()
  };
}

// Validate and sanitize a payment object
function validatePayment(obj, validStudentIds) {
  if (!obj || typeof obj !== 'object') return null;

  const id = sanitizeId(obj.id);
  const studentId = sanitizeId(obj.studentId);
  const date = obj.date;
  const amount = obj.amount;

  // Required fields must be valid
  if (!id || !studentId || !isValidDateStr(date)) return null;
  if (typeof amount !== 'number' || amount <= 0 || amount > 100000) return null;
  // Student must exist
  if (!validStudentIds.has(studentId)) return null;

  // Accept both Hebrew (app default) and English (legacy) payment methods
  const validMethods = ['××–×•××Ÿ', '×‘×™×˜', '×¤×™×™×‘×•×§×¡', '×”×¢×‘×¨×”', '××©×¨××™', 'cash', 'transfer', 'bit', 'paybox', 'check', 'credit', 'other'];

  return {
    id: id,
    studentId: studentId,
    studentName: sanitizeString(obj.studentName || '', 100),
    date: date,
    amount: amount,
    method: validMethods.includes(obj.method) ? obj.method : '××–×•××Ÿ',
    note: sanitizeString(obj.note || '', 500),
    createdAt: obj.createdAt || new Date().toISOString()
  };
}

// Validate and sanitize vehicle data
function validateVehicleData(obj) {
  if (obj === null) return null;
  if (!obj || typeof obj !== 'object') return null;

  const plate = sanitizeString(obj.plate || '', 20);
  if (!plate) return null;

  let year = sanitizeString(obj.year || '', 10);
  if (year && !/^\d{4}$/.test(year)) year = '';

  const transmissionRaw = sanitizeString(obj.transmission || '', 20);
  const transmission = (transmissionRaw === '×™×“× ×™') ? '×™×“× ×™' : '××•×˜×•××˜';

  const fixDate = (d) => (isValidDateStr(d) ? d : '');

  return {
    plate: plate,
    make: sanitizeString(obj.make || '', 50),
    model: sanitizeString(obj.model || '', 50),
    year: year,
    transmission: transmission,
    color: sanitizeString(obj.color || '', 30),
    testDate: fixDate(obj.testDate),
    insuranceDate: fixDate(obj.insuranceDate),
    fullInsuranceDate: fixDate(obj.fullInsuranceDate),
    serviceDate: fixDate(obj.serviceDate)
  };
}

// Validate and sanitize km history array
function validateKmHistory(arr) {
  if (!Array.isArray(arr)) return [];

  const out = [];
  for (const it of arr) {
    if (!it || typeof it !== 'object') continue;

    const km = Number(it.km);
    const date = it.date;
    const ts = Number(it.timestamp);

    if (!Number.isFinite(km) || km <= 0 || km > 99999999) continue;
    if (!isValidDateStr(date)) continue;

    out.push({
      km: Math.floor(km),
      date: date,
      timestamp: Number.isFinite(ts) ? ts : Date.now()
    });
  }

  out.sort((a,b) => (b.timestamp - a.timestamp));
  return out.slice(0, 20);
}

// Validate entire import data structure
function validateImportData(data) {
  if (!data || typeof data !== 'object') return null;
  if (!Array.isArray(data.students) || !Array.isArray(data.lessons) || !Array.isArray(data.payments)) return null;

  // Validate students first
  const validStudents = [];
  const validStudentIds = new Set();
  for (const s of data.students) {
    const validated = validateStudent(s);
    if (validated) {
      validStudents.push(validated);
      validStudentIds.add(validated.id);
    }
  }

  // Validate lessons (must reference valid students)
  const validLessons = [];
  for (const l of data.lessons) {
    const validated = validateLesson(l, validStudentIds);
    if (validated) validLessons.push(validated);
  }

  // Validate payments (must reference valid students)
  const validPayments = [];
  for (const p of data.payments) {
    const validated = validatePayment(p, validStudentIds);
    if (validated) validPayments.push(validated);
  }

  // Validate vehicle and km data if present
  const hasVehicle = Object.prototype.hasOwnProperty.call(data, 'vehicleData');
  const hasKm = Object.prototype.hasOwnProperty.call(data, 'kmHistory');

  const validVehicleData = hasVehicle ? validateVehicleData(data.vehicleData) : undefined;
  const validKmHistory = hasKm ? validateKmHistory(data.kmHistory) : undefined;

  const vehicleSkipped = (hasVehicle && data.vehicleData && !validVehicleData) ? 1 : 0;
  const kmSkipped = hasKm
    ? (Array.isArray(data.kmHistory) ? (data.kmHistory.length - (validKmHistory ? validKmHistory.length : 0)) : 1)
    : 0;

  return {
    students: validStudents,
    lessons: validLessons,
    payments: validPayments,
    vehicleData: validVehicleData,
    kmHistory: validKmHistory,
    skipped: {
      students: data.students.length - validStudents.length,
      lessons: data.lessons.length - validLessons.length,
      payments: data.payments.length - validPayments.length,
      vehicle: vehicleSkipped,
      km: kmSkipped
    }
  };
}

function populateStudentSelect(selId, preselectId) {
  const sel = document.getElementById(selId);
  sel.innerHTML = '<option value="">â€” ×‘×—×¨ ×ª×œ××™×“ â€”</option>';
  students.forEach(s=>{ sel.innerHTML += `<option value="${s.id}" ${s.id===preselectId?'selected':''}>${escHtml(s.name)}</option>`; });
}

// ============================================================
// BALANCE CACHE - Performance optimization
// ============================================================
let balanceCache = {};
let balanceCacheDate = null; // Cache invalidates when date changes

function invalidateBalanceCache() {
  balanceCache = {};
}

function getBalanceCacheKey(studentId) {
  const today = getRealTodayStr();
  // Invalidate cache if date changed
  if (balanceCacheDate !== today) {
    balanceCache = {};
    balanceCacheDate = today;
  }
  return studentId;
}

// Student balance = total paid - sum of completed lesson prices
// Only counts lessons that actually happened (status = 'completed' or legacy lessons without status that are in the past)
// Uses cache for performance with many students
function getStudentBalance(s) {
  const cacheKey = getBalanceCacheKey(s.id);
  if (balanceCache.hasOwnProperty(cacheKey)) {
    return balanceCache[cacheKey];
  }

  const totalPaid = payments.filter(p=>p.studentId===s.id).reduce((sum,p)=>sum+p.amount,0);

  // Calculate owed based on completed lessons AND legacy lessons (no status) that are in the past
  const studentLessons = lessons.filter(l => l.studentId === s.id);
  const today = getRealTodayStr();

  let totalOwed = 0;
  studentLessons.forEach(l => {
    // Charge for:
    // 1. Explicitly completed lessons
    // 2. Legacy lessons (no status) that are in the past - assume they happened
    const isCompleted = l.status === 'completed';
    const isLegacyPast = !l.status && l.date < today;

    if (isCompleted || isLegacyPast) {
      // Use stored price if available, otherwise use current student price
      totalOwed += (l.priceAtTime !== undefined && l.priceAtTime !== null) ? l.priceAtTime : (s.price || 0);
    }
  });

  const balance = totalPaid - totalOwed; // negative = owes money
  balanceCache[cacheKey] = balance;
  return balance;
}

// Get count of completed lessons for student
function getCompletedLessonsCount(s) {
  // Base count from before the app (initialCompletedLessons)
  const base = (s && typeof s.initialCompletedLessons === 'number' && s.initialCompletedLessons > 0)
    ? s.initialCompletedLessons
    : 0;

  const today = getRealTodayStr();

  // Plus lessons marked as completed OR legacy lessons (no status) that are in the past
  const doneInApp = lessons.filter(l => {
    if (l.studentId !== s.id) return false;
    if (l.status === 'completed') return true;
    if (!l.status && l.date < today) return true; // Legacy lesson in past
    return false;
  }).length;

  return base + doneInApp;
}

// ============================================================
// NAV
// ============================================================
let currentPage = 'dashboard';
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelector(`[data-page="${page}"]`).classList.add('active');
  currentPage = page;
  renderPage(page); // Only render active page for performance
  updateHeader();
}

// Render only the specified page (performance optimization)
function renderPage(page) {
  switch(page) {
    case 'dashboard': renderDashboard(); break;
    case 'calendar': renderCalendar(); break;
    case 'students': renderStudents(); break;
    case 'finance': renderFinance(); break;
    case 'vehicle': renderVehiclePage(); break;
  }
}

// ============================================================
// MODALS
// ============================================================
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// Double-click prevention with proper async support
let isSaving = false;
async function preventDoubleClick(fn) {
  if (isSaving) return;
  isSaving = true;
  try {
    await fn(); // Properly await async functions
  } finally {
    isSaving = false; // Release only when function completes
  }
}
function adjustCount(id,d) { const el=document.getElementById(id); let v=parseInt(el.textContent)+d; if(v<0)v=0; el.textContent=v; }

// Helper: transition from student detail to edit modal
function editStudentFromDetail(sid) {
  const s = students.find(x => x.id === sid);
  if (!s) {
    showToast('âš ï¸ ×©×’×™××” - ×ª×œ××™×“ ×œ× × ××¦×');
    closeModal('modalStudentDetail');
    return;
  }
  closeModal('modalStudentDetail');
  openNewStudentModal(sid);
}

// Helper: transition from student detail to payment modal
function paymentFromDetail(sid) {
  const s = students.find(x => x.id === sid);
  if (!s) {
    showToast('âš ï¸ ×©×’×™××” - ×ª×œ××™×“ ×œ× × ××¦×');
    closeModal('modalStudentDetail');
    return;
  }
  closeModal('modalStudentDetail');
  openPaymentModal(sid);
}

// ---- NEW / EDIT STUDENT ----
let editingStudentId = null;
function openNewStudentModal(editId) {
  editingStudentId = editId || null;
  if(editingStudentId) {
    const s = students.find(x=>x.id===editingStudentId);
    if(!s) { showToast('âš ï¸ ×ª×œ××™×“ ×œ× × ××¦×'); return; }
    document.getElementById('newStudentName').value = s.name;
    document.getElementById('newStudentPhone').value = s.phone;
    document.getElementById('newStudentPrice').value = s.price||170;
    document.getElementById('newStudentTotalLessons').value = s.totalLessons||28;
    document.getElementById('newStudentNotes').value = s.notes||'';
    document.getElementById('newStudentLessons').textContent = getCompletedLessonsCount(s);
    document.getElementById('newStudentWantsExtra').checked = s.wantsExtraLessons||false;
    document.querySelector('#modalNewStudent .modal-title').textContent = 'âœï¸ ×¢×¨×™×›×ª ×ª×œ××™×“';
  } else {
    ['newStudentName','newStudentPhone','newStudentNotes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('newStudentPrice').value = '170';
    document.getElementById('newStudentTotalLessons').value = '28';
    document.getElementById('newStudentLessons').textContent = '0';
    document.getElementById('newStudentWantsExtra').checked = false;
    document.querySelector('#modalNewStudent .modal-title').textContent = 'ğŸ‘¤ ×ª×œ××™×“ ×—×“×©';
  }
  openModal('modalNewStudent');
}
async function saveNewStudent() {
  const name = document.getElementById('newStudentName').value.trim();
  const phone = document.getElementById('newStudentPhone').value.trim();
  const price = parseInt(document.getElementById('newStudentPrice').value)||170;
  const totalLessons = parseInt(document.getElementById('newStudentTotalLessons').value)||28;
  const notes = document.getElementById('newStudentNotes').value.trim();
  const ld = parseInt(document.getElementById('newStudentLessons').textContent);
  const wantsExtra = document.getElementById('newStudentWantsExtra').checked;
  if(!name||!phone){ showToast('âš ï¸ × × ×œ××œ× ×©× ×•×˜×œ×¤×•×Ÿ'); return; }
  const digits = phone.replace(/[\s\-()+"]/g,'').replace(/^\+/,'');
  if(digits.length < 9 || digits.length > 13 || !/^\d+$/.test(digits)){ showToast('âš ï¸ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ'); return; }
  if(price < 0 || price > 10000){ showToast('âš ï¸ ××—×™×¨ ×œ× ×ª×§×™×Ÿ (0-10000)'); return; }
  if(totalLessons < 1 || totalLessons > 100){ showToast('âš ï¸ ×¡×”"×› ×©×™×¢×•×¨×™× ×œ× ×ª×§×™×Ÿ (1-100)'); return; }
  // Calculate desired completed count (limited to 0-1000)
  const desiredCompleted = (Number.isFinite(ld) && ld >= 0) ? Math.min(ld, 1000) : 0;
  // Check for duplicate phone (only when adding new student)
  if(!editingStudentId) {
    const existingByPhone = students.find(s => formatPhone(s.phone) === formatPhone(phone));
    if(existingByPhone) {
      const addAnyway = await customConfirm(`×›×‘×¨ ×§×™×™× ×ª×œ××™×“ ×¢× ××¡×¤×¨ ×–×”: ${existingByPhone.name}\n\n×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`, '×ª×œ××™×“ ×§×™×™×', 'âš ï¸');
      if(!addAnyway) return;
    }
  }
  if(editingStudentId) {
    const s = students.find(x=>x.id===editingStudentId);
    if(s) {
      s.name=name; s.phone=phone; s.price=price; s.notes=notes; s.wantsExtraLessons=wantsExtra; s.totalLessons=totalLessons;
      // Calculate initialCompletedLessons so total matches desired
      // Must match getCompletedLessonsCount logic: completed + legacy past lessons
      const editToday = getRealTodayStr();
      const doneInApp = lessons.filter(l => {
        if (l.studentId !== editingStudentId) return false;
        if (l.status === 'completed') return true;
        if (!l.status && l.date < editToday) return true;
        return false;
      }).length;
      s.initialCompletedLessons = Math.max(0, desiredCompleted - doneInApp);
      // Update cached name in lessons/payments
      lessons.filter(l=>l.studentId===editingStudentId).forEach(l=>l.studentName=name);
      payments.filter(p=>p.studentId===editingStudentId).forEach(p=>p.studentName=name);
    }
    if(!saveData()) return; // Stop if save failed
    closeModal('modalNewStudent');
    showToast('âœ… ×ª×œ××™×“ ×¢×•×“×›×Ÿ');
    renderAll();
    editingStudentId = null;
  } else {
    students.push({ id:genId(), name, phone, price, totalLessons, notes, initialCompletedLessons:desiredCompleted, wantsExtraLessons:wantsExtra, createdAt:new Date().toISOString() });
    if(!saveData()) return; // Stop if save failed
    closeModal('modalNewStudent');
    showToast('âœ… ×ª×œ××™×“ × ×•×¡×£');
    renderAll();
  }
}

// ---- NEW LESSON ----
let lessonModalInitialized = false;
let editingLessonId = null;

// Auto-format time input (HH:MM)
document.getElementById('lessonTime').addEventListener('input', function(e) {
  let v = this.value.replace(/[^\d]/g, '');
  if (v.length >= 3) v = v.slice(0,2) + ':' + v.slice(2,4);
  this.value = v;
});
document.getElementById('lessonTime').addEventListener('blur', function() {
  const parts = this.value.split(':');
  if (parts.length === 2) {
    let h = parseInt(parts[0]) || 0, m = parseInt(parts[1]) || 0;
    if (h > 23) h = 23; if (m > 59) m = 59;
    this.value = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
  }
});

function openNewLessonModal(prefillDate, prefillTime, editLessonId) {
  editingLessonId = editLessonId || null;
  const realToday = getRealTodayStr(); // Use real date, not working day
  const dateInput = document.getElementById('lessonDate');
  const statusGroup = document.getElementById('lessonStatusGroup');
  const statusSelect = document.getElementById('lessonStatus');

  if (editingLessonId) {
    // Edit mode
    const lesson = lessons.find(l => l.id === editingLessonId);
    if (!lesson) { showToast('âš ï¸ ×©×™×¢×•×¨ ×œ× × ××¦×'); return; }

    document.getElementById('lessonModalTitle').textContent = 'âœï¸ ×¢×¨×™×›×ª ×©×™×¢×•×¨';
    populateStudentSelect('lessonStudent', lesson.studentId);
    dateInput.min = ''; // Allow editing past lessons
    dateInput.value = lesson.date;
    document.getElementById('lessonTime').value = lesson.time;
    document.getElementById('lessonDuration').value = lesson.duration || 40;
    document.getElementById('lessonAddress').value = lesson.address || '';
    // Show and populate status selector
    statusGroup.style.display = 'block';
    statusSelect.value = lesson.status || 'scheduled';
  } else {
    // New lesson mode
    document.getElementById('lessonModalTitle').textContent = 'ğŸ“… ×§×‘×™×¢×ª ×©×™×¢×•×¨';
    populateStudentSelect('lessonStudent');
    dateInput.min = realToday; // Prevent selecting past dates (real date)
    dateInput.value = (prefillDate && prefillDate >= realToday) ? prefillDate : realToday;
    document.getElementById('lessonTime').value = prefillTime || '';
    document.getElementById('lessonDuration').value = '40';
    document.getElementById('lessonAddress').value = '';
    // Hide status selector for new lessons (always starts as scheduled)
    statusGroup.style.display = 'none';
    statusSelect.value = 'scheduled';
  }

  document.getElementById('waPreviewSection').style.display = 'none';
  openModal('modalNewLesson');

  // Only bind event handlers once
  if (!lessonModalInitialized) {
    ['lessonStudent','lessonDate','lessonTime','lessonDuration','lessonAddress'].forEach(id=>{
      document.getElementById(id).onchange = updateWaPreview;
      document.getElementById(id).oninput = updateWaPreview;
    });
    lessonModalInitialized = true;
  }
}

function openEditLessonModal(lessonId) {
  openNewLessonModal(null, null, lessonId);
}

function buildWaMsg(sName,date,time,dur,addr) {
  let m = `×©×œ×•× ${sName} ğŸ‘‹\n× ×§×‘×¢ ×œ×š ×©×™×¢×•×¨ × ×”×™×’×”:\n\nğŸ“… ${formatDateHeb(date)}\nğŸ• ${time}\nâ±ï¸ ${dur} ×“×§×•×ª\n`;
  if(addr) m += `ğŸ“ ${addr}\n`;
  m += `\n× ×ª×¨××”! ğŸš—`;
  return m;
}

// Build reminder message for tomorrow's lesson
// Uses real tomorrow date, not "working day" logic
function buildReminderMsg(sName, lessonDate, time, dur, addr) {
  const realToday = getRealTodayStr();
  const realTomorrow = getRealTomorrowStr();

  // Determine correct day reference for the message
  let dayText;
  if (lessonDate === realToday) {
    dayText = '*×”×™×•×*';
  } else if (lessonDate === realTomorrow) {
    dayText = '*××—×¨*';
  } else {
    dayText = `×‘${formatDateHeb(lessonDate)}`;
  }

  let m = `×”×™×™ ${sName} ğŸ‘‹\n\n×ª×–×›×•×¨×ª ×œ×©×™×¢×•×¨ × ×”×™×’×” ${dayText}:\nğŸ• ${time}\nâ±ï¸ ${dur} ×“×§×•×ª\n`;
  if(addr) m += `ğŸ“ ${addr}\n`;
  m += `\n×××©×¨/×ª? ğŸš—`;
  return m;
}

// Send reminder for specific lesson
function sendTomorrowReminder(lid) {
  const l = lessons.find(x=>x.id===lid); if(!l) return;
  // Only send reminders for scheduled lessons
  if (l.status !== 'scheduled') {
    showToast('âš ï¸ ×œ× ×©×•×œ×—×™× ×ª×–×›×•×¨×ª ×œ×©×™×¢×•×¨ ×©×‘×•×˜×œ/×”×¡×ª×™×™×');
    return;
  }
  const s = students.find(x=>x.id===l.studentId); if(!s) return;
  const msg = buildReminderMsg(s.name, l.date, l.time, l.duration, l.address);
  window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`,'_blank');
}

// Send reminders to all students with lessons tomorrow
async function sendAllTomorrowReminders() {
  const tmrw = getRealTomorrowStr();
  const tmrwLessons = lessons.filter(l => l.date === tmrw && l.status === 'scheduled').sort((a,b)=>a.time.localeCompare(b.time));

  if(tmrwLessons.length === 0) {
    showToast('××™×Ÿ ×©×™×¢×•×¨×™× ××ª×•×›× × ×™× ×œ××—×¨');
    return;
  }

  if(tmrwLessons.length === 1) {
    // Single student - can open directly with user gesture
    const l = tmrwLessons[0];
    const s = students.find(x=>x.id===l.studentId);
    if(!s) return;
    const msg = buildReminderMsg(s.name, l.date, l.time, l.duration, l.address);
    window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`, '_blank');
    showToast('× ×¤×ª×— ×—×œ×•×Ÿ ×•×•××˜×¡××¤');
    return;
  }

  // Multiple students - show modal with individual buttons (each click = user gesture)
  showReminderList(tmrwLessons);
}

// Show modal with individual reminder buttons - each button click is a user gesture
function showReminderList(tmrwLessons) {
  let html = `
    <div style="max-height:60vh;overflow-y:auto;">
      <p style="margin-bottom:16px;color:var(--text-dim);font-size:13px;">×œ×—×¥ ×¢×œ ×›×œ ×ª×œ××™×“ ×œ×©×œ×™×—×ª ×ª×–×›×•×¨×ª (×›×œ ×œ×—×™×¦×” ×¤×•×ª×—×ª ×—×œ×•×Ÿ ×•×•××˜×¡××¤):</p>
  `;

  tmrwLessons.forEach((l) => {
    const s = students.find(x => x.id === l.studentId);
    if (!s) return;
    html += `
      <div class="reminder-item" id="reminder-${l.id}" style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--card);border-radius:10px;margin-bottom:8px;border:1px solid var(--border);">
        <div>
          <div style="font-weight:600;">${escHtml(s.name)}</div>
          <div style="font-size:12px;color:var(--text-dim);">${l.time} | ${l.duration} ×“×§×•×ª</div>
        </div>
        <button onclick="sendSingleReminder('${l.id}')" class="btn-reminder" style="background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:500;font-size:12px;">
          ğŸ’¬ WA
        </button>
        <button onclick="sendReminderSms('${l.id}');this.textContent='âœ“';this.disabled=true;this.style.opacity='0.6';" style="background:var(--blue);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:500;font-size:12px;">
          ğŸ“± SMS
        </button>
      </div>
    `;
  });

  html += `</div>`;

  document.getElementById('reminderListContent').innerHTML = html;
  openModal('modalReminderList');
}

function sendSingleReminder(lid) {
  const l = lessons.find(x => x.id === lid);
  if (!l) return;
  const s = students.find(x => x.id === l.studentId);
  if (!s) return;

  const msg = buildReminderMsg(s.name, l.date, l.time, l.duration, l.address);
  window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`, '_blank');

  // Mark as sent visually
  const item = document.getElementById(`reminder-${lid}`);
  if (item) {
    const btn = item.querySelector('.btn-reminder');
    btn.textContent = 'âœ“ × ×©×œ×—';
    btn.style.background = 'var(--success)';
    btn.disabled = true;
    item.style.opacity = '0.6';
  }
}
function updateWaPreview() {
  const sid=document.getElementById('lessonStudent').value, d=document.getElementById('lessonDate').value, t=document.getElementById('lessonTime').value, dur=document.getElementById('lessonDuration').value, addr=document.getElementById('lessonAddress').value.trim();
  if(sid&&d&&t) {
    const s=students.find(x=>x.id===sid);
    if(s){ document.getElementById('waPreviewText').textContent=buildWaMsg(s.name,d,t,dur,addr); document.getElementById('waPreviewSection').style.display='block'; }
  }
}

async function saveLesson(withWa) {
  const sid=document.getElementById('lessonStudent').value, d=document.getElementById('lessonDate').value, t=document.getElementById('lessonTime').value;
  const dur=document.getElementById('lessonDuration').value, addr=document.getElementById('lessonAddress').value.trim();
  if(!sid||!d||!t){ showToast('âš ï¸ × × ×œ××œ× ×ª×œ××™×“, ×ª××¨×™×š ×•×©×¢×”'); return; }

  // Validate time format (HH:MM)
  if(!/^\d{2}:\d{2}$/.test(t)) { showToast('âš ï¸ ×¤×•×¨××˜ ×©×¢×” ×œ× ×ª×§×™×Ÿ (HH:MM)'); return; }
  const [thh, tmm] = t.split(':').map(Number);
  if(thh > 23 || tmm > 59) { showToast('âš ï¸ ×©×¢×” ×œ× ×ª×§×™× ×”'); return; }

  // Validate not in the past (only for new lessons) - use real date, not working day
  const now = new Date();
  const today = getRealTodayStr();
  if(!editingLessonId) {
    if(d < today) { showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×©×™×¢×•×¨ ×‘×ª××¨×™×š ×©×¢×‘×¨'); return; }
    if(d === today) {
      const [hh, mm] = t.split(':').map(Number);
      const lessonTime = hh * 60 + mm;
      const currentTime = now.getHours() * 60 + now.getMinutes();
      if(lessonTime < currentTime) { showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×©×™×¢×•×¨ ×‘×©×¢×” ×©×¢×‘×¨×”'); return; }
    }
  }

  // Holiday warning
  const holiday = getHoliday(d);
  if(holiday && !editingLessonId) {
    const isMajor = isMajorHoliday(d);
    const msg = isMajor
      ? `âš ï¸ ×©×™× ×œ×‘! ×”×ª××¨×™×š ${formatDateHeb(d)} ×—×œ ×‘${holiday}.\n\n×–×”×• ×—×’ ××¨×›×–×™ - ×”×× ×‘×˜×•×— ×©×ª×¨×¦×” ×œ×§×‘×•×¢ ×©×™×¢×•×¨?`
      : `ğŸ“… ×©×™× ×œ×‘: ×”×ª××¨×™×š ${formatDateHeb(d)} ×—×œ ×‘${holiday}.\n\n×œ×”××©×™×š?`;
    const confirmed = await customConfirm(msg, holiday, isMajor ? 'âš ï¸' : 'ğŸ“…');
    if(!confirmed) return;
  }

  // Check for conflicting lessons (same time slot)
  const [newH, newM] = t.split(':').map(Number);
  const newStart = newH * 60 + newM;
  const newEnd = newStart + parseInt(dur);
  const conflict = lessons.find(l => {
    if(l.id === editingLessonId) return false; // Skip self when editing
    if(l.status === 'cancelled') return false; // Cancelled lessons don't block slots
    if(l.status === 'no-show') return false; // No-show lessons don't block slots
    if(l.date !== d) return false;
    const [lh, lm] = l.time.split(':').map(Number);
    const lStart = lh * 60 + lm;
    const lEnd = lStart + (l.duration || 40);
    return (newStart < lEnd && newEnd > lStart); // overlapping
  });
  if(conflict) {
    showToast(`âš ï¸ ×™×© ×›×‘×¨ ×©×™×¢×•×¨ ×‘-${conflict.time} ×¢× ${conflict.studentName}`);
    return;
  }

  const s = students.find(x=>x.id===sid);
  if(!s){ showToast('âš ï¸ ×ª×œ××™×“ ×œ× × ××¦×'); return; }

  if(editingLessonId) {
    // Update existing lesson
    const lesson = lessons.find(l => l.id === editingLessonId);
    if(lesson) {
      // If student changed, update priceAtTime to new student's price
      if (lesson.studentId !== sid) {
        lesson.priceAtTime = s.price || 0;
      }
      lesson.studentId = sid;
      lesson.studentName = s.name;
      lesson.date = d;
      lesson.time = t;
      lesson.duration = parseInt(dur);
      lesson.address = addr;
      // Update status from selector - block completed/no-show for future lessons
      const newStatus = document.getElementById('lessonStatus').value;
      if (newStatus === 'completed' || newStatus === 'no-show') {
        const lessonDt = new Date(`${d}T${t}:00`);
        if (lessonDt > now) {
          const statusHeb = newStatus === 'completed' ? '×‘×•×¦×¢' : '×œ× ×”×’×™×¢';
          showToast(`âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×¡××Ÿ ×©×™×¢×•×¨ ×¢×ª×™×“×™ ×›×´${statusHeb}×´`);
          return;
        }
      }
      lesson.status = newStatus;
    }
    if(!saveData()) return; // Stop if save failed
    closeModal('modalNewLesson');
    showToast('âœ… ×©×™×¢×•×¨ ×¢×•×“×›×Ÿ');
    renderAll();
    editingLessonId = null;
  } else {
    // Create new lesson with price stored at creation time
    lessons.push({
      id: genId(),
      studentId: sid,
      studentName: s.name,
      date: d,
      time: t,
      duration: parseInt(dur),
      address: addr,
      priceAtTime: s.price || 0, // Store current price for accurate billing
      status: 'scheduled', // Will be 'completed' after lesson happens
      createdAt: new Date().toISOString()
    });
    if(!saveData()) return; // Stop if save failed
    closeModal('modalNewLesson');
    showToast('âœ… ×©×™×¢×•×¨ × ×§×‘×¢');
    renderAll();
  }

  if(withWa === true) {
    const msg = buildWaMsg(s.name,d,t,dur,addr);
    window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`,'_blank');
  } else if(withWa === 'sms') {
    const msg = buildSmsMsg(s.name,d,t,dur,addr);
    openSmsLink(s.phone, msg);
  }
}

// ---- SMS FUNCTIONS (for kosher phones) ----
function buildSmsMsg(sName,date,time,dur,addr) {
  let m = `×©×œ×•× ${sName}, × ×§×‘×¢ ×œ×š ×©×™×¢×•×¨ × ×”×™×’×”:\n${formatDateHeb(date)}\n×©×¢×”: ${time}\n${dur} ×“×§×•×ª\n`;
  if(addr) m += `×›×ª×•×‘×ª: ${addr}\n`;
  m += `× ×ª×¨××”!`;
  return m;
}

function buildReminderSms(sName, lessonDate, time, dur, addr) {
  const realToday = getRealTodayStr();
  const realTomorrow = getRealTomorrowStr();
  let dayText;
  if (lessonDate === realToday) dayText = '×”×™×•×';
  else if (lessonDate === realTomorrow) dayText = '××—×¨';
  else dayText = formatDateHeb(lessonDate);

  let m = `×©×œ×•× ${sName}, ×ª×–×›×•×¨×ª ×œ×©×™×¢×•×¨ × ×”×™×’×” ${dayText}:\n×©×¢×”: ${time}\n${dur} ×“×§×•×ª\n`;
  if(addr) m += `×›×ª×•×‘×ª: ${addr}\n`;
  m += `×××©×¨/×ª?`;
  return m;
}

function formatPhoneSms(p) {
  let c = p.replace(/[\s\-()+"]/g,'');
  if(!c.startsWith('+') && !c.startsWith('972')) {
    if(c.startsWith('0')) c = '+972' + c.slice(1);
    else c = '+972' + c;
  } else if(c.startsWith('972')) {
    c = '+' + c;
  }
  return c;
}

function openSmsLink(phone, msg) {
  const num = formatPhoneSms(phone);
  // Cross-platform sms: URI
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const sep = isIOS ? '&' : '?';
  window.open(`sms:${num}${sep}body=${encodeURIComponent(msg)}`, '_blank');
}

function sendLessonSms(lid) {
  const l=lessons.find(x=>x.id===lid); if(!l)return;
  const s=students.find(x=>x.id===l.studentId); if(!s)return;
  const msg=buildSmsMsg(s.name,l.date,l.time,l.duration,l.address);
  openSmsLink(s.phone, msg);
}

function sendReminderSms(lid) {
  const l=lessons.find(x=>x.id===lid); if(!l)return;
  if (l.status !== 'scheduled') { showToast('×œ× ×©×•×œ×—×™× ×ª×–×›×•×¨×ª ×œ×©×™×¢×•×¨ ×©×‘×•×˜×œ/×”×¡×ª×™×™×'); return; }
  const s=students.find(x=>x.id===l.studentId); if(!s)return;
  const msg=buildReminderSms(s.name,l.date,l.time,l.duration,l.address);
  openSmsLink(s.phone, msg);
}

function sendDebtSms(sid) {
  const s=students.find(x=>x.id===sid); if(!s)return;
  const bal = getStudentBalance(s);
  const debt = Math.abs(bal);
  const msg = `×©×œ×•× ${s.name}, ×¨×¦×™×ª×™ ×œ×¢×“×›×Ÿ ×©×™×© ×™×ª×¨×ª ×—×•×‘ ×¤×ª×•×—×” ×©×œ ${fmtMoney(debt)} ×©×§×œ×™×. ××©××— ×œ×¡×’×•×¨ ×›×©× ×•×— ×œ×š. ×ª×•×“×”!`;
  openSmsLink(s.phone, msg);
}

function sendLessonWa(lid) {
  const l=lessons.find(x=>x.id===lid); if(!l)return;
  const s=students.find(x=>x.id===l.studentId); if(!s)return;
  const msg=buildWaMsg(s.name,l.date,l.time,l.duration,l.address);
  window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`,'_blank');
}

// Quick mark lesson as completed
async function markLessonCompleted(lid) {
  const lesson = lessons.find(l => l.id === lid);
  if (!lesson) { showToast('âš ï¸ ×©×™×¢×•×¨ ×œ× × ××¦×'); return; }

  // Block marking future lessons as completed
  const now = new Date();
  const lessonDt = new Date(`${lesson.date}T${lesson.time}:00`);
  if (lessonDt > now) {
    showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×¡××Ÿ ×©×™×¢×•×¨ ×¢×ª×™×“×™ ×›×´×‘×•×¦×¢×´');
    return;
  }

  if (lesson.status === 'completed') {
    showToast('×”×©×™×¢×•×¨ ×›×‘×¨ ××¡×•××Ÿ ×›×‘×•×¦×¢');
    return;
  }

  lesson.status = 'completed';
  // Store price at time of completion if not already stored
  if (lesson.priceAtTime === undefined || lesson.priceAtTime === null) {
    const s = students.find(x => x.id === lesson.studentId);
    if (s) lesson.priceAtTime = s.price || 0;
  }
  if (!saveData()) {
    lesson.status = 'scheduled'; // Revert on failure
    return;
  }
  showToast('âœ… ×©×™×¢×•×¨ ×¡×•××Ÿ ×›×‘×•×¦×¢');
  renderAll();
}

// Quick mark lesson as no-show
async function markLessonNoShow(lid) {
  const lesson = lessons.find(l => l.id === lid);
  if (!lesson) { showToast('âš ï¸ ×©×™×¢×•×¨ ×œ× × ××¦×'); return; }

  const now = new Date();
  const lessonDt = new Date(`${lesson.date}T${lesson.time}:00`);
  if (lessonDt > now) {
    showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×¡××Ÿ ×©×™×¢×•×¨ ×¢×ª×™×“×™ ×›×´×œ× ×”×’×™×¢×´');
    return;
  }

  const confirmed = await customConfirm('×œ×¡××Ÿ ××ª ×”×©×™×¢×•×¨ ×›×´×œ× ×”×’×™×¢×´?', '×œ× ×”×’×™×¢', 'ğŸš«');
  if (!confirmed) return;

  lesson.status = 'no-show';
  if (!saveData()) {
    lesson.status = 'scheduled'; // Revert on failure
    return;
  }
  showToast('ğŸš« ×©×™×¢×•×¨ ×¡×•××Ÿ ×›×œ× ×”×’×™×¢');
  renderAll();
}

async function deleteLesson(lid) {
  const lesson = lessons.find(l=>l.id===lid);
  if(!lesson) return;

  // Check if there are students who want extra lessons BEFORE deletion
  const studentsWantingExtra = students.filter(st =>
    st.wantsExtraLessons &&
    st.id !== lesson.studentId &&
    !lessons.some(l => l.id !== lid && l.studentId === st.id && l.date === lesson.date)
  );

  // Build confirmation message with warning if WhatsApp will be offered
  let confirmMsg = '×œ××—×•×§ ××ª ×”×©×™×¢×•×¨?';
  if (studentsWantingExtra.length > 0) {
    confirmMsg += `\n\nğŸ“¨ ×™×•×¦×¢×• ×”×•×“×¢×•×ª ×œ-${studentsWantingExtra.length} ×ª×œ××™×“×™× ×©××—×¤×©×™× ×©×¢×•×ª.`;
    confirmMsg += '\nâš ï¸ ×œ××—×¨ ×©×œ×™×—×ª ×”×•×“×¢×•×ª ×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ.';
  }

  const confirmed = await customConfirm(confirmMsg, '××—×™×§×ª ×©×™×¢×•×¨', 'ğŸ—‘ï¸');
  if(!confirmed) return;

  // Save lesson details before deleting
  const deletedLesson = { ...lesson };

  // Delete the lesson (no need to update lessonsDone - calculated dynamically)
  lessons=lessons.filter(l=>l.id!==lid);
  if(!saveData()) return; // Stop if save failed

  // Show undo only if no WhatsApp will be sent (to avoid confusion)
  if (studentsWantingExtra.length === 0) {
    showUndoToast('×”×©×™×¢×•×¨ × ××—×§', 'lessons', deletedLesson);
  } else {
    showToast('ğŸ—‘ï¸ ×”×©×™×¢×•×¨ × ××—×§');
  }
  renderAll();

  // Offer slot notification (undo no longer available after WhatsApp is sent)
  if(studentsWantingExtra.length > 0) {
    offerSlotNotification(deletedLesson, studentsWantingExtra);
  }
}

// Offer to send notification about available slot
async function offerSlotNotification(lesson, eligibleStudents) {
  const count = eligibleStudents.length;

  if (count === 1) {
    // Single student - can send directly with user gesture
    const confirmed = await customConfirm(
      `×”×ª×¤× ×” ××§×•× ×‘×™×•××Ÿ!\n\n×œ×©×œ×•×— ×”×•×“×¢×” ×œ-${eligibleStudents[0].name}?`,
      '×”×•×“×¢×” ×¢×œ ××§×•× ×¤× ×•×™', 'ğŸ“…'
    );
    if (!confirmed) return;

    const msg = buildSlotAvailableMsg(lesson.date, lesson.time, lesson.duration, lesson.address);
    window.open(`https://wa.me/${formatPhone(eligibleStudents[0].phone)}?text=${encodeURIComponent(msg)}`, '_blank');
    showToast('× ×¤×ª×— ×—×œ×•×Ÿ ×•×•××˜×¡××¤');
    return;
  }

  // Multiple students - show modal with individual buttons
  const confirmed = await customConfirm(
    `×”×ª×¤× ×” ××§×•× ×‘×™×•××Ÿ!\n\n×™×© ${count} ×ª×œ××™×“×™× ×©××—×¤×©×™× ×©×¢×•×ª.\n\n×œ×”×¦×™×’ ××ª ×”×¨×©×™××” ×œ×©×œ×™×—×”?`,
    '×”×•×“×¢×” ×¢×œ ××§×•× ×¤× ×•×™', 'ğŸ“…'
  );
  if (!confirmed) return;

  showSlotNotificationList(lesson, eligibleStudents);
}

// Current slot lesson data (stored here to avoid XSS via onclick attributes)
let currentSlotLesson = null;

// Show modal with individual slot notification buttons - each button click is a user gesture
function showSlotNotificationList(lesson, eligibleStudents) {
  // Store lesson data securely - don't pass through onclick attribute
  currentSlotLesson = lesson;

  let html = `
    <div style="max-height:60vh;overflow-y:auto;">
      <div style="margin-bottom:16px;padding:12px;background:var(--bg);border-radius:10px;border:1px solid var(--border);">
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:4px;">××§×•× ×¤× ×•×™:</div>
        <div style="font-weight:600;">${formatDateHeb(lesson.date)} | ${lesson.time} | ${lesson.duration} ×“×§×•×ª</div>
      </div>
      <p style="margin-bottom:12px;color:var(--text-dim);font-size:13px;">×œ×—×¥ ×¢×œ ×›×œ ×ª×œ××™×“ ×œ×©×œ×™×—×ª ×”×•×“×¢×”:</p>
  `;

  eligibleStudents.forEach((s) => {
    html += `
      <div class="slot-item" id="slot-${escHtml(s.id)}" style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--card);border-radius:10px;margin-bottom:8px;border:1px solid var(--border);">
        <div style="font-weight:600;">${escHtml(s.name)}</div>
        <button onclick="sendSlotNotification('${escHtml(s.id)}')" class="btn-slot" style="background:var(--accent);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:500;">
          ğŸ“± ×©×œ×—
        </button>
      </div>
    `;
  });

  html += `</div>`;

  document.getElementById('slotListContent').innerHTML = html;
  openModal('modalSlotList');
}

function sendSlotNotification(sid) {
  const s = students.find(x => x.id === sid);
  if (!s || !currentSlotLesson) return;

  // Build message here from stored lesson data - safe from XSS
  const msg = buildSlotAvailableMsg(currentSlotLesson.date, currentSlotLesson.time, currentSlotLesson.duration, currentSlotLesson.address);
  const encodedMsg = encodeURIComponent(msg);

  window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodedMsg}`, '_blank');

  // Mark as sent visually
  const item = document.getElementById(`slot-${sid}`);
  if (item) {
    const btn = item.querySelector('.btn-slot');
    btn.textContent = 'âœ“ × ×©×œ×—';
    btn.style.background = 'var(--success)';
    btn.disabled = true;
    item.style.opacity = '0.6';
  }
}

// Build message for available slot
function buildSlotAvailableMsg(date, time, dur, addr) {
  let m = `×”×™×™! ğŸ‘‹\n\n×”×ª×¤× ×” ××§×•× ×œ×©×™×¢×•×¨ × ×”×™×’×”:\nğŸ“… ${formatDateHeb(date)}\nğŸ• ${time}\nâ±ï¸ ${dur} ×“×§×•×ª\n`;
  if(addr) m += `ğŸ“ ${addr}\n`;
  m += `\n××ª××™× ×œ×š? ğŸš—`;
  return m;
}

// ---- PAYMENT ----
function openPaymentModal(prefillStudentId) {
  populateStudentSelect('payStudent', prefillStudentId);
  document.getElementById('payAmount').value = '';
  document.getElementById('payMethod').value = '××–×•××Ÿ';
  document.getElementById('payDate').value = getRealTodayStr(); // Use real date, not working day
  document.getElementById('payNote').value = '';
  if(prefillStudentId) {
    const s=students.find(x=>x.id===prefillStudentId);
    if(s) document.getElementById('payAmount').value = s.price||'';
  }
  openModal('modalPayment');
}
function savePayment() {
  const sid=document.getElementById('payStudent').value;
  const amount=parseFloat(document.getElementById('payAmount').value);
  const method=document.getElementById('payMethod').value;
  const date=document.getElementById('payDate').value;
  const note=document.getElementById('payNote').value.trim();

  // Validation
  if(!sid){ showToast('âš ï¸ × × ×œ×‘×—×•×¨ ×ª×œ××™×“'); return; }
  if(!amount || isNaN(amount)){ showToast('âš ï¸ × × ×œ×”×–×™×Ÿ ×¡×›×•×'); return; }
  if(amount <= 0){ showToast('âš ï¸ ×¡×›×•× ×—×™×™×‘ ×œ×”×™×•×ª ×—×™×•×‘×™'); return; }
  if(amount > 50000){ showToast('âš ï¸ ×¡×›×•× ×—×¨×™×’ - ×‘×“×•×§ ×©×•×‘'); return; }
  if(!date){ showToast('âš ï¸ × × ×œ×‘×—×•×¨ ×ª××¨×™×š'); return; }

  const s=students.find(x=>x.id===sid);
  if(!s){ showToast('âš ï¸ ×ª×œ××™×“ ×œ× × ××¦×'); return; }

  payments.push({ id:genId(), studentId:sid, studentName:s.name, amount, method, date, note, createdAt:new Date().toISOString() });
  if(!saveData()) return; // Stop if save failed
  closeModal('modalPayment');
  showToast('âœ… ×ª×©×œ×•× × ×¨×©×');
  renderAll();
}

async function deletePayment(pid) {
  const confirmed = await customConfirm('×œ××—×•×§ ××ª ×”×ª×©×œ×•×?', '××—×™×§×ª ×ª×©×œ×•×', 'ğŸ—‘ï¸');
  if(!confirmed) return;

  const payment = payments.find(p => p.id === pid);
  if(!payment) return;

  payments = payments.filter(p => p.id !== pid);
  if(!saveData()) return; // Stop if save failed

  // Show undo option
  showUndoToast('×”×ª×©×œ×•× × ××—×§', 'payments', payment);
  renderAll();
}

// ---- SEND DEBT REMINDER WA ----
function sendDebtWa(sid) {
  const s=students.find(x=>x.id===sid); if(!s)return;
  const bal = getStudentBalance(s);
  const debt = Math.abs(bal);
  const msg = `×©×œ×•× ${s.name} ğŸ‘‹\n×¨×¦×™×ª×™ ×œ×¢×“×›×Ÿ ×©×™×© ×™×ª×¨×ª ×—×•×‘ ×¤×ª×•×—×” ×©×œ ${fmtMoney(debt)} â‚ª.\n××©××— ×œ×¡×’×•×¨ ×›×©× ×•×— ×œ×š ğŸ™\n×ª×•×“×”!`;
  window.open(`https://wa.me/${formatPhone(s.phone)}?text=${encodeURIComponent(msg)}`,'_blank');
}

// ---- STUDENT DETAIL ----
async function deleteStudent(sid) {
  const s=students.find(x=>x.id===sid);
  if(!s) return;

  // Check for future lessons - use real today
  const today = getRealTodayStr();
  const futureLessons = lessons.filter(l => l.studentId === sid && l.date >= today && l.status === 'scheduled');

  let confirmMsg = `×œ××—×•×§ ××ª ${s.name}? ×›×œ ×”×©×™×¢×•×¨×™× ×•×”×ª×©×œ×•××™× ×©×œ×• ×™×™××—×§×• ×’×.`;
  if(futureLessons.length > 0) {
    confirmMsg += `\n\nâš ï¸ ×œ×ª×œ××™×“ ×™×© ${futureLessons.length} ×©×™×¢×•×¨×™× ×¢×ª×™×“×™×™× ×©×™×™××—×§×•!`;
  }
  const confirmed = await customConfirm(confirmMsg, '××—×™×§×ª ×ª×œ××™×“', 'ğŸ—‘ï¸');
  if(!confirmed) return;

  // Ask about notifications BEFORE delete (so undo toast gets full 5 seconds)
  let shouldNotify = false;
  const studentsWantingExtra = students.filter(st => st.id !== sid && st.wantsExtraLessons);

  if (futureLessons.length > 0 && studentsWantingExtra.length > 0) {
    shouldNotify = await customConfirm(
      `×™×ª×¤× ×• ${futureLessons.length} ××§×•××•×ª ×‘×™×•××Ÿ.\n\n×œ×©×œ×•×— ×”×•×“×¢×” ×œ-${studentsWantingExtra.length} ×ª×œ××™×“×™× ×©××—×¤×©×™× ×©×¢×•×ª?\n\nâš ï¸ ×œ××—×¨ ×©×œ×™×—×ª ×”×•×“×¢×•×ª ×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ××ª ×”××—×™×§×”.`,
      '×”×•×“×¢×” ×¢×œ ××§×•××•×ª ×¤× ×•×™×™×',
      'ğŸ“¨'
    );
  }

  // Save all student data for undo
  const studentLessons = lessons.filter(l => l.studentId === sid);
  const studentPayments = payments.filter(p => p.studentId === sid);
  const deletedStudentData = { student: {...s}, lessons: [...studentLessons], payments: [...studentPayments] };

  // Save future lessons data before deleting
  const deletedLessons = [...futureLessons];

  students=students.filter(x=>x.id!==sid);
  lessons=lessons.filter(l=>l.studentId!==sid);
  payments=payments.filter(p=>p.studentId!==sid);
  if(!saveData()) return; // Stop if save failed
  closeModal('modalStudentDetail');

  // Show undo only if no WhatsApp will be sent (to avoid confusion - same as deleteLesson)
  if (!shouldNotify) {
    showUndoToast(`${s.name} × ××—×§`, 'students', deletedStudentData);
  } else {
    showToast('ğŸ—‘ï¸ ×”×ª×œ××™×“ × ××—×§');
  }
  renderAll();

  // Send notifications if user agreed (undo no longer available after WhatsApp is sent)
  if (shouldNotify && deletedLessons.length > 0) {
    showSlotNotificationList(deletedLessons[0], studentsWantingExtra);
  }
}
function openStudentDetail(sid) {
  const s=students.find(x=>x.id===sid); if(!s)return;
  document.getElementById('detailStudentTitle').innerHTML=`ğŸ‘¤ ${escHtml(s.name)}`;
  const sLessons=lessons.filter(l=>l.studentId===sid).sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time));
  const sPayments=payments.filter(p=>p.studentId===sid).sort((a,b)=>b.date.localeCompare(a.date));
  const bal=getStudentBalance(s);
  const totalPaid=sPayments.reduce((sum,p)=>sum+p.amount,0);
  const completedCount = getCompletedLessonsCount(s);
  const balColor = bal < 0 ? 'red' : 'accent';

  let h = `
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:14px;">
      <div class="student-avatar" style="width:50px;height:50px;font-size:20px;">${escHtml(getInitials(s.name))}</div>
      <div>
        <div style="font-size:17px;font-weight:700;">${escHtml(s.name)}</div>
        <div style="font-size:13px;color:var(--text-dim);direction:ltr;text-align:right;">${escHtml(s.phone)}</div>
      </div>
    </div>
    <div class="stats-bar four">
      <div class="stat-card"><div class="stat-number">${completedCount}</div><div class="stat-label">×‘×•×¦×¢×•</div></div>
      <div class="stat-card"><div class="stat-number">${Math.max(0,getTotalLessonsForStudent(s)-completedCount)}</div><div class="stat-label">× ×•×ª×¨×•</div></div>
      <div class="stat-card"><div class="stat-number">${fmtMoney(totalPaid)}</div><div class="stat-label">×©×•×œ× â‚ª</div></div>
      <div class="stat-card"><div class="stat-number ${balColor}">${bal<0?fmtMoney(Math.abs(bal)):bal>0?fmtMoney(bal):'0'}</div><div class="stat-label">${bal<0?'×—×•×‘ â‚ª':bal>0?'×–×›×•×ª â‚ª':'×××•×–×Ÿ'}</div></div>
    </div>`;
  if(s.notes) h += `<div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">ğŸ“ ${escHtml(s.notes)}</div>`;
  if(s.wantsExtraLessons) h += `<div style="font-size:12px;color:var(--blue);margin-bottom:12px;">ğŸ”” ××—×¤×© ×©×¢×•×ª × ×•×¡×¤×•×ª</div>`;

  h += `<div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">
    <button class="btn btn-whatsapp btn-sm" style="flex:1;min-width:30%;" onclick="window.open('https://wa.me/${formatPhone(s.phone)}','_blank')">ğŸ’¬ ×•×•××˜×¡××¤</button>
    <button class="btn btn-outline btn-sm" style="flex:1;min-width:30%;border-color:var(--blue);color:var(--blue);" onclick="openSmsLink('${escHtml(s.phone)}','')">ğŸ“± SMS</button>
    <button class="btn btn-primary btn-sm" style="flex:1;min-width:45%;" onclick="paymentFromDetail('${s.id}')">ğŸ’³ ×ª×©×œ×•×</button>
    <button class="btn btn-outline btn-sm" style="flex:1;min-width:45%;" onclick="editStudentFromDetail('${s.id}')">âœï¸ ×¢×¨×™×›×”</button>
    ${bal<0?`<button class="btn btn-outline btn-sm" style="flex:1;min-width:30%;border-color:var(--warning);color:var(--warning);" onclick="sendDebtWa('${s.id}')">âš ï¸ ×—×•×‘ WA</button><button class="btn btn-outline btn-sm" style="flex:1;min-width:30%;border-color:var(--blue);color:var(--blue);" onclick="sendDebtSms('${s.id}')">ğŸ“± ×—×•×‘ SMS</button>`:''}
  </div>`;

  if(sPayments.length>0) {
    h += `<div class="section-title">×ª×©×œ×•××™×</div>`;
    sPayments.slice(0,10).forEach(p=>{
      h += `<div class="payment-item">
        <div class="payment-amount income">+${fmtMoney(p.amount)}</div>
        <div class="payment-info">
          <div class="payment-name">${escHtml(p.method)}</div>
          <div class="payment-meta">${formatDateHeb(p.date)}${p.note?' Â· '+escHtml(p.note):''}</div>
        </div>
        <button class="icon-btn" onclick="event.stopPropagation();deletePayment('${p.id}')" title="××—×™×§×”" style="color:var(--danger);">ğŸ—‘ï¸</button>
      </div>`;
    });
  }
  if(sLessons.length>0) {
    h += `<div class="section-title" style="margin-top:14px;">×©×™×¢×•×¨×™× ××—×¨×•× ×™×</div>`;
    const detailNow = new Date();
    const detailToday = getRealTodayStr();
    const detailNowMin = detailNow.getHours() * 60 + detailNow.getMinutes();
    sLessons.slice(0,8).forEach(l=>{
      // Status badge for lesson
      const statusBadge = l.status === 'completed' ? '<span class="badge badge-green">×‘×•×¦×¢</span>'
        : l.status === 'cancelled' ? '<span class="badge badge-red">×‘×•×˜×œ</span>'
        : l.status === 'no-show' ? '<span class="badge badge-red">×œ× ×”×’×™×¢</span>'
        : '<span class="badge badge-blue">××ª×•×›× ×Ÿ</span>';
      // Show complete button for past scheduled lessons
      const [dlh, dlm] = l.time.split(':').map(Number);
      const dlEnd = dlh * 60 + dlm + (l.duration || 40);
      const dlCanComplete = l.status === 'scheduled' && ((l.date < detailToday) || (l.date === detailToday && dlEnd <= detailNowMin));
      const dlCompleteBtn = dlCanComplete ? `<button class="icon-btn" onclick="event.stopPropagation();markLessonCompleted('${l.id}');closeModal('modalStudentDetail');setTimeout(()=>openStudentDetail('${s.id}'),300);" title="×¡××Ÿ ×›×‘×•×¦×¢" style="color:var(--accent);">âœ“</button>` : '';
      h += `<div class="lesson-item" style="padding:8px 10px;">
        <div class="lesson-time" style="min-width:50px;padding:5px 7px;"><div class="lesson-hour" style="font-size:14px;">${l.time}</div></div>
        <div class="lesson-details"><div style="font-size:13px;font-weight:500;">${formatDateHeb(l.date)} ${statusBadge}</div><div style="font-size:11px;color:var(--text-dim);">${l.duration} ×“×§×³${l.address?' Â· '+escHtml(l.address):''}</div></div>
        ${dlCompleteBtn}
        <button class="icon-btn" onclick="closeModal('modalStudentDetail');openEditLessonModal('${l.id}')" title="×¢×¨×™×›×”" style="margin-right:auto;">âœï¸</button>
      </div>`;
    });
  }
  h += `<button class="btn-danger-outline" style="margin-top:14px;width:100%;" onclick="deleteStudent('${s.id}')">ğŸ—‘ï¸ ××—×™×§×ª ×ª×œ××™×“</button>`;
  document.getElementById('detailStudentContent').innerHTML=h;
  openModal('modalStudentDetail');
}

// ============================================================
// HEBREW HOLIDAYS
// ============================================================
const HEBREW_HOLIDAYS = {
  // 2025
  '2025-03-14': '×¤×•×¨×™×',
  '2025-04-13': '×¤×¡×— (×¢×¨×‘ ×—×’)',
  '2025-04-14': '×¤×¡×—',
  '2025-04-15': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2025-04-16': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2025-04-17': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2025-04-18': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2025-04-19': '×©×‘×™×¢×™ ×©×œ ×¤×¡×—',
  '2025-04-20': '××™×¡×¨×• ×—×’',
  '2025-04-30': '×™×•× ×”×–×™×›×¨×•×Ÿ',
  '2025-05-01': '×™×•× ×”×¢×¦×××•×ª',
  '2025-05-16': '×œ"×’ ×‘×¢×•××¨',
  '2025-06-02': '×©×‘×•×¢×•×ª',
  '2025-09-23': '×¨××© ×”×©× ×”',
  '2025-09-24': '×¨××© ×”×©× ×” ×‘×³',
  '2025-10-02': '×™×•× ×›×™×¤×•×¨',
  '2025-10-07': '×¡×•×›×•×ª',
  '2025-10-08': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2025-10-09': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2025-10-10': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2025-10-11': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2025-10-12': '×”×•×©×¢× × ×¨×‘×”',
  '2025-10-13': '×©××™× ×™ ×¢×¦×¨×ª',
  '2025-10-14': '×©××—×ª ×ª×•×¨×”',
  // 2026
  '2026-03-03': '×¤×•×¨×™×',
  '2026-04-02': '×¤×¡×— (×¢×¨×‘ ×—×’)',
  '2026-04-03': '×¤×¡×—',
  '2026-04-04': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2026-04-05': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2026-04-06': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2026-04-07': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2026-04-08': '×©×‘×™×¢×™ ×©×œ ×¤×¡×—',
  '2026-04-09': '××™×¡×¨×• ×—×’',
  '2026-04-22': '×™×•× ×”×–×™×›×¨×•×Ÿ',
  '2026-04-23': '×™×•× ×”×¢×¦×××•×ª',
  '2026-05-05': '×œ"×’ ×‘×¢×•××¨',
  '2026-05-22': '×©×‘×•×¢×•×ª',
  '2026-09-12': '×¨××© ×”×©× ×”',
  '2026-09-13': '×¨××© ×”×©× ×” ×‘×³',
  '2026-09-21': '×™×•× ×›×™×¤×•×¨',
  '2026-09-26': '×¡×•×›×•×ª',
  '2026-09-27': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2026-09-28': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2026-09-29': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2026-09-30': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2026-10-01': '×”×•×©×¢× × ×¨×‘×”',
  '2026-10-02': '×©××™× ×™ ×¢×¦×¨×ª',
  '2026-10-03': '×©××—×ª ×ª×•×¨×”',
  // 2027
  '2027-03-23': '×¤×•×¨×™×',
  '2027-04-22': '×¤×¡×— (×¢×¨×‘ ×—×’)',
  '2027-04-23': '×¤×¡×—',
  '2027-04-24': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2027-04-25': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2027-04-26': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2027-04-27': '×—×•×œ ×”××•×¢×“ ×¤×¡×—',
  '2027-04-28': '×©×‘×™×¢×™ ×©×œ ×¤×¡×—',
  '2027-04-29': '××™×¡×¨×• ×—×’',
  '2027-05-11': '×™×•× ×”×–×™×›×¨×•×Ÿ',
  '2027-05-12': '×™×•× ×”×¢×¦×××•×ª',
  '2027-05-25': '×œ"×’ ×‘×¢×•××¨',
  '2027-06-11': '×©×‘×•×¢×•×ª',
  '2027-10-02': '×¨××© ×”×©× ×”',
  '2027-10-03': '×¨××© ×”×©× ×” ×‘×³',
  '2027-10-11': '×™×•× ×›×™×¤×•×¨',
  '2027-10-16': '×¡×•×›×•×ª',
  '2027-10-17': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2027-10-18': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2027-10-19': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2027-10-20': '×—×•×œ ×”××•×¢×“ ×¡×•×›×•×ª',
  '2027-10-21': '×”×•×©×¢× × ×¨×‘×”',
  '2027-10-22': '×©××™× ×™ ×¢×¦×¨×ª',
  '2027-10-23': '×©××—×ª ×ª×•×¨×”',
};

// Major holidays where no lessons should be scheduled (exact match only)
const MAJOR_HOLIDAYS = ['×¤×¡×—','×¨××© ×”×©× ×”','×¨××© ×”×©× ×” ×‘×³','×™×•× ×›×™×¤×•×¨','×¡×•×›×•×ª','×©×‘×™×¢×™ ×©×œ ×¤×¡×—','×©××™× ×™ ×¢×¦×¨×ª','×©××—×ª ×ª×•×¨×”','×©×‘×•×¢×•×ª','×™×•× ×”×–×™×›×¨×•×Ÿ'];

function getHoliday(dateStr) {
  return HEBREW_HOLIDAYS[dateStr] || null;
}

function isMajorHoliday(dateStr) {
  const h = getHoliday(dateStr);
  if (!h) return false;
  // Exact match - so "×—×•×œ ×”××•×¢×“ ×¤×¡×—" won't match "×¤×¡×—"
  return MAJOR_HOLIDAYS.includes(h);
}

// ============================================================
// CALENDAR
// ============================================================
let calWeekStart = getWeekStart(new Date());

function getWeekStart(d) {
  const r = new Date(d);
  r.setDate(r.getDate() - r.getDay());
  r.setHours(0,0,0,0);
  return r;
}
function calPrev() { calWeekStart = new Date(calWeekStart); calWeekStart.setDate(calWeekStart.getDate()-7); renderCalendar(); }
function calNext() { calWeekStart = new Date(calWeekStart); calWeekStart.setDate(calWeekStart.getDate()+7); renderCalendar(); }
function calToday() { calWeekStart = getWeekStart(new Date()); renderCalendar(); }

function renderCalendar() {
  const DEFAULT_START = 7, DEFAULT_END = 24;
  const days = [];
  for(let i=0;i<7;i++) {
    const d = new Date(calWeekStart);
    d.setDate(d.getDate()+i);
    days.push(d);
  }

  // Find min/max hours from VISIBLE lessons in this week
  // Exclude cancelled and no-show lessons (same filter as rendering)
  let minHour = DEFAULT_START, maxHour = DEFAULT_END;
  const weekDates = days.map(d => dateStr(d));
  lessons.forEach(l => {
    if (!weekDates.includes(l.date)) return;
    // Skip cancelled and no-show - they don't render, shouldn't affect hour range
    if (l.status === 'cancelled' || l.status === 'no-show') return;
    const [lh] = l.time.split(':').map(Number);
    const endHour = Math.ceil((lh * 60 + (l.duration || 40)) / 60);
    if (lh < minHour) minHour = lh;
    if (endHour > maxHour) maxHour = Math.min(endHour, 24);
  });
  const START_HOUR = minHour, END_HOUR = maxHour;

  // Title
  const m1 = MONTHS_HEB[days[0].getMonth()], m2 = MONTHS_HEB[days[6].getMonth()];
  document.getElementById('calTitle').textContent = m1===m2 ? `${days[0].getDate()}â€“${days[6].getDate()} ${m1}` : `${days[0].getDate()} ${m1} â€“ ${days[6].getDate()} ${m2}`;

  // Header - use real today for consistency
  const todayD = getRealTodayStr();
  let hdr = '<div></div>';
  days.forEach(d => {
    const ds = dateStr(d);
    const isTd = ds===todayD;
    const holiday = getHoliday(ds);
    const holidayLabel = holiday ? `<span style="font-size:8px;color:var(--danger);display:block;line-height:1;">${escHtml(holiday)}</span>` : '';
    hdr += `<div class="cal-day-label ${isTd?'today':''}" ${holiday?'style="background:var(--danger-dim);border-radius:6px;"':''}><span class="cal-day-num">${d.getDate()}</span>${DAYS_SHORT[d.getDay()]}${holidayLabel}</div>`;
  });
  document.getElementById('calWeekHeader').innerHTML = hdr;

  // Body - dynamically sized based on lessons
  let body = '';
  for(let h=START_HOUR; h<END_HOUR; h++) {
    body += `<div class="cal-hour-label">${String(h).padStart(2,'0')}:00</div>`;
    days.forEach(d => {
      const ds = dateStr(d);
      const isTd = ds===todayD;
      const isHolidayCol = getHoliday(ds) ? 'background:var(--danger-dim);' : '';
      body += `<div class="cal-cell ${isTd?'today-col':''}" style="${isHolidayCol}" data-date="${ds}" data-hour="${h}" onclick="onCalCellClick('${ds}','${String(h).padStart(2,'0')}:00')"></div>`;
    });
  }
  document.getElementById('calBody').innerHTML = body;

  // Place events - group by day to handle overlaps
  // Don't show cancelled or no-show lessons
  const eventsByDay = {};
  lessons.forEach(l => {
    if (l.status === 'cancelled' || l.status === 'no-show') return;
    const [lh,lm] = l.time.split(':').map(Number);
    if(lh < START_HOUR || lh >= END_HOUR) return; // Now uses dynamic range
    const dayIdx = days.findIndex(d => dateStr(d) === l.date);
    if(dayIdx < 0) return;
    if(!eventsByDay[dayIdx]) eventsByDay[dayIdx] = [];
    eventsByDay[dayIdx].push({ lesson: l, startMin: lh*60+lm, endMin: lh*60+lm+(l.duration||40) });
  });

  Object.keys(eventsByDay).forEach(dayIdx => {
    const evts = eventsByDay[dayIdx].sort((a,b)=>a.startMin-b.startMin);
    evts.forEach((evt,i) => {
      const l = evt.lesson;
      const [lh,lm] = l.time.split(':').map(Number);
      const cellIdx = (lh - START_HOUR) * 8 + 1 + parseInt(dayIdx);
      const cells = document.getElementById('calBody').children;
      if(!cells[cellIdx]) return;
      const cell = cells[cellIdx];

      // Count overlaps before this event
      let overlapIdx = 0;
      for(let j=0;j<i;j++) {
        if(evts[j].startMin < evt.endMin && evts[j].endMin > evt.startMin) overlapIdx++;
      }

      const durSlots = (l.duration||40) / 60;
      const topPx = (lm / 60) * 48;
      const heightPx = Math.max(durSlots * 48, 22);

      const ev = document.createElement('div');
      ev.className = 'cal-event' + (l.status === 'completed' ? ' completed' : '');
      ev.style.top = topPx + 'px';
      ev.style.height = heightPx + 'px';
      if(overlapIdx > 0) {
        ev.style.right = (2 + overlapIdx * 20) + 'px';
        ev.style.opacity = '0.9';
        ev.style.borderRight = '2px solid #000';
      }
      const statusIcon = l.status === 'completed' ? 'âœ“ ' : '';
      ev.innerHTML = `<div>${statusIcon}${escHtml(l.studentName)}</div><div class="ev-time">${l.time}</div>`;
      ev.onclick = (e) => { e.stopPropagation(); openEditLessonModal(l.id); };
      ev.title = `${l.studentName} - ${l.time}${l.status === 'completed' ? ' (×‘×•×¦×¢)' : ''} (×œ×—×¥ ×œ×¢×¨×™×›×”)`;
      cell.appendChild(ev);
    });
  });
}

function onCalCellClick(date, time) {
  const today = getRealTodayStr(); // Use real date, not working day
  if(date < today) { showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×©×™×¢×•×¨ ×‘×ª××¨×™×š ×©×¢×‘×¨'); return; }
  if(date === today) {
    const now = new Date();
    const [hh, mm] = time.split(':').map(Number);
    const clickedTime = hh * 60 + mm;
    const currentTime = now.getHours() * 60 + now.getMinutes();
    if(clickedTime < currentTime) { showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×©×™×¢×•×¨ ×‘×©×¢×” ×©×¢×‘×¨×”'); return; }
  }
  openNewLessonModal(date, time);
}

// ============================================================
// FINANCE
// ============================================================
let finMonth = new Date().getMonth();
let finYear = new Date().getFullYear();
let finDateFrom = '';
let finDateTo = '';

function finPrev() {
  clearDateFilter(true); // Clear filter silently
  finMonth--;
  if(finMonth<0){finMonth=11;finYear--;}
  renderFinance();
}
function finNext() {
  clearDateFilter(true); // Clear filter silently
  finMonth++;
  if(finMonth>11){finMonth=0;finYear++;}
  renderFinance();
}

function applyDateFilter() {
  finDateFrom = document.getElementById('finDateFrom').value;
  finDateTo = document.getElementById('finDateTo').value;
  renderFinance();
}

function clearDateFilter(silent) {
  finDateFrom = '';
  finDateTo = '';
  const fromEl = document.getElementById('finDateFrom');
  const toEl = document.getElementById('finDateTo');
  if(fromEl) fromEl.value = '';
  if(toEl) toEl.value = '';
  if(!silent) renderFinance();
}

function renderFinance() {
  let mPayments, mLessons;
  const labelEl = document.getElementById('finMonthLabel');

  // Check if date range filter is active
  if(finDateFrom || finDateTo) {
    const from = finDateFrom || '1900-01-01';
    const to = finDateTo || '2999-12-31';
    mPayments = payments.filter(p => p.date >= from && p.date <= to);
    mLessons = lessons.filter(l => l.date >= from && l.date <= to);

    // Show date range in label
    const fromDisplay = finDateFrom ? new Date(finDateFrom+'T00:00:00').toLocaleDateString('he-IL') : '×”×ª×—×œ×”';
    const toDisplay = finDateTo ? new Date(finDateTo+'T00:00:00').toLocaleDateString('he-IL') : '×¡×•×£';
    labelEl.innerHTML = `<span style="font-size:12px;">ğŸ“… ${fromDisplay} â€” ${toDisplay}</span>`;
  } else {
    // Default: filter by month
    const mStr = `${finYear}-${String(finMonth+1).padStart(2,'0')}`;
    mPayments = payments.filter(p => p.date.startsWith(mStr));
    mLessons = lessons.filter(l => l.date.startsWith(mStr));
    labelEl.textContent = `${MONTHS_HEB[finMonth]} ${finYear}`;
  }
  const totalIncome = mPayments.reduce((s,p)=>s+p.amount,0);
  // Only count scheduled/completed lessons (not cancelled/no-show)
  const relevantLessons = mLessons.filter(l => l.status === 'scheduled' || l.status === 'completed' || !l.status);
  const totalLessons = relevantLessons.length;
  // Use priceAtTime if available, fallback to student price
  const expectedIncome = relevantLessons.reduce((s,l)=>{
    if (l.priceAtTime !== undefined && l.priceAtTime !== null) {
      return s + l.priceAtTime;
    }
    const st = students.find(x=>x.id===l.studentId);
    return s + (st?.price||0);
  },0);

  // Debts
  const studentsWithDebt = students.filter(s=>getStudentBalance(s)<0).sort((a,b)=>getStudentBalance(a)-getStudentBalance(b));
  const totalDebt = studentsWithDebt.reduce((s,st)=>s+Math.abs(getStudentBalance(st)),0);

  document.getElementById('finStats').innerHTML = `
    <div class="stat-card"><div class="stat-number">${fmtMoney(totalIncome)}</div><div class="stat-label">×”×›× ×¡×•×ª â‚ª</div></div>
    <div class="stat-card"><div class="stat-number blue">${totalLessons}</div><div class="stat-label">×©×™×¢×•×¨×™×</div></div>
    <div class="stat-card"><div class="stat-number yellow">${fmtMoney(expectedIncome)}</div><div class="stat-label">×¦×¤×•×™ â‚ª</div></div>
    <div class="stat-card"><div class="stat-number red">${fmtMoney(totalDebt)}</div><div class="stat-label">×—×•×‘×•×ª â‚ª</div></div>
  `;

  // Debt list
  const debtC = document.getElementById('debtList');
  if(studentsWithDebt.length===0) {
    debtC.innerHTML = '<div style="text-align:center;padding:16px;font-size:13px;color:var(--text-muted);">ğŸ‰ ××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™×!</div>';
  } else {
    let dh = '';
    studentsWithDebt.forEach(s => {
      const debt = Math.abs(getStudentBalance(s));
      const completedCount = getCompletedLessonsCount(s);
      dh += `<div class="debt-student" onclick="openStudentDetail('${s.id}')">
        <div class="student-avatar" style="width:36px;height:36px;font-size:13px;">${escHtml(getInitials(s.name))}</div>
        <div class="debt-info"><div class="debt-name">${escHtml(s.name)}</div><div class="debt-detail">${completedCount} ×©×™×¢×•×¨×™×</div></div>
        <div class="debt-amount">${fmtMoney(debt)} â‚ª</div>
        <button class="icon-btn wa" onclick="event.stopPropagation();sendDebtWa('${s.id}')" title="×ª×–×›×•×¨×ª ×—×•×‘ WA">ğŸ’¬</button>
        <button class="icon-btn" onclick="event.stopPropagation();sendDebtSms('${s.id}')" title="×ª×–×›×•×¨×ª ×—×•×‘ SMS" style="color:var(--blue);">ğŸ“±</button>
      </div>`;
    });
    debtC.innerHTML = dh;
  }

  // Recent payments
  const payC = document.getElementById('paymentsList');
  const recent = mPayments.sort((a,b)=>b.date.localeCompare(a.date));
  if(recent.length===0) {
    payC.innerHTML = `<div style="text-align:center;padding:16px;font-size:13px;color:var(--text-muted);">××™×Ÿ ×ª×©×œ×•××™× ×”×—×•×“×©</div>
      <button class="btn btn-primary" style="margin-top:8px;" onclick="openPaymentModal()">ğŸ’³ ×¨×™×©×•× ×ª×©×œ×•×</button>`;
  } else {
    let ph = '';
    recent.forEach(p => {
      ph += `<div class="payment-item">
        <div class="payment-amount income">+${fmtMoney(p.amount)}</div>
        <div class="payment-info">
          <div class="payment-name">${escHtml(p.studentName)}</div>
          <div class="payment-meta">${formatDateHeb(p.date)} Â· ${escHtml(p.method)}${p.note?' Â· '+escHtml(p.note):''}</div>
        </div>
        <button class="icon-btn" onclick="deletePayment('${p.id}')" title="××—×™×§×”" style="color:var(--danger);">ğŸ—‘ï¸</button>
      </div>`;
    });
    ph += `<button class="btn btn-primary" style="margin-top:10px;" onclick="openPaymentModal()">ğŸ’³ ×¨×™×©×•× ×ª×©×œ×•×</button>`;
    payC.innerHTML = ph;
  }
}

// ============================================================
// RENDER
// ============================================================
function renderAll() {
  renderDashboard();
  renderCalendar();
  renderStudents();
  renderFinance();
  renderVehiclePage();
  updateHeader();
}

function updateHeader() {
  // Always show real date, not working day - to avoid confusion
  const n = new Date();
  document.getElementById('headerDate').textContent = `×™×•× ${DAYS_HEB[n.getDay()]}, ${n.getDate()} ${MONTHS_HEB[n.getMonth()]} ${n.getFullYear()}`;
}

function renderDashboard() {
  // Use real today, not working day - for consistency with header
  const td = getRealTodayStr();
  document.getElementById('statStudents').textContent = students.length;
  document.getElementById('statLessonsToday').textContent = lessons.filter(l=>l.date===td && l.status !== 'cancelled' && l.status !== 'no-show').length;

  const totalDebt = students.filter(s=>getStudentBalance(s)<0).reduce((sum,s)=>sum+Math.abs(getStudentBalance(s)),0);
  const debtEl = document.getElementById('statDebtTotal');
  debtEl.textContent = fmtMoney(totalDebt);
  debtEl.className = totalDebt > 0 ? 'stat-number red' : 'stat-number';

  // Upcoming - only scheduled lessons, and for today only future times
  const realToday = getRealTodayStr();
  const now2 = new Date();
  const nowMin = now2.getHours() * 60 + now2.getMinutes();

  const upcoming = lessons
    .filter(l => l.status === 'scheduled')
    .filter(l => {
      if (l.date > realToday) return true;
      if (l.date < realToday) return false;
      // Today - only future times
      const [hh, mm] = l.time.split(':').map(Number);
      return (hh * 60 + mm) >= nowMin;
    })
    .sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time))
    .slice(0,5);
  const uc = document.getElementById('upcomingLessons');
  if(upcoming.length===0) {
    uc.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-text">××™×Ÿ ×©×™×¢×•×¨×™× ×§×¨×•×‘×™×</div><div class="empty-sub">×œ×—×¥ ×œ××˜×” ×›×“×™ ×œ×§×‘×•×¢ ×©×™×¢×•×¨</div></div>';
  } else {
    let h='';
    upcoming.forEach(l => {
      const tBadge = isToday(l.date)?'<span class="badge badge-green">×”×™×•×</span>':'';
      // Show "mark completed" button for lessons that can be completed (today's past lessons)
      const [lhh, lmm] = l.time.split(':').map(Number);
      const lessonEndMin = lhh * 60 + lmm + (l.duration || 40);
      const canComplete = (l.date < realToday) || (l.date === realToday && lessonEndMin <= nowMin);
      const completeBtn = canComplete ? `<button class="icon-btn" onclick="event.stopPropagation();markLessonCompleted('${l.id}')" title="×¡××Ÿ ×›×‘×•×¦×¢" style="color:var(--accent);">âœ“</button>` : '';
      h += `<div class="lesson-item"><div class="lesson-time"><div class="lesson-hour">${l.time}</div><div class="lesson-date-small">${l.date.slice(5).replace('-','/')}</div></div><div class="lesson-details"><div class="lesson-student-name">${escHtml(l.studentName)} ${tBadge}</div><div class="lesson-info">${l.duration} ×“×§×³${l.address?' Â· ğŸ“ '+escHtml(l.address):''}</div></div><div class="lesson-actions">${completeBtn}<button class="icon-btn" onclick="openEditLessonModal('${l.id}')" title="×¢×¨×™×›×”">âœï¸</button><button class="icon-btn wa" onclick="sendLessonWa('${l.id}')" title="×•×•××˜×¡××¤">ğŸ’¬</button><button class="icon-btn" onclick="sendLessonSms('${l.id}')" title="SMS" style="color:var(--blue);">ğŸ“±</button><button class="icon-btn" onclick="deleteLesson('${l.id}')" title="××—×™×§×”" style="color:var(--danger);">âœ•</button></div></div>`;
    });
    uc.innerHTML = h;
  }

  // Tomorrow's lessons section (use real tomorrow, only scheduled lessons)
  const tmrw = getRealTomorrowStr();
  const tmrwLessons = lessons.filter(l => l.date === tmrw && l.status === 'scheduled').sort((a,b)=>a.time.localeCompare(b.time));
  const tlc = document.getElementById('tomorrowLessons');
  if(tmrwLessons.length > 0) {
    let tlh = `<div class="section-title">ğŸ“… ×©×™×¢×•×¨×™× ××—×¨ (${tmrwLessons.length})</div>`;
    tmrwLessons.forEach(l => {
      tlh += `<div class="lesson-item">
        <div class="lesson-time"><div class="lesson-hour">${l.time}</div><div class="lesson-date-small">${l.duration} ×“×§×³</div></div>
        <div class="lesson-details">
          <div class="lesson-student-name">${escHtml(l.studentName)}</div>
          <div class="lesson-info">${l.address ? 'ğŸ“ '+escHtml(l.address) : ''}</div>
        </div>
        <div class="lesson-actions">
          <button class="icon-btn" onclick="openEditLessonModal('${l.id}')" title="×¢×¨×™×›×”">âœï¸</button>
          <button class="icon-btn wa" onclick="sendTomorrowReminder('${l.id}')" title="×ª×–×›×•×¨×ª ×•×•××˜×¡××¤">ğŸ’¬</button>
          <button class="icon-btn" onclick="sendReminderSms('${l.id}')" title="×ª×–×›×•×¨×ª SMS" style="color:var(--blue);">ğŸ“±</button>
        </div>
      </div>`;
    });
    tlh += `<button class="btn btn-whatsapp" style="margin-top:10px;" onclick="sendAllTomorrowReminders()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      ğŸ“¨ ×©×œ×— ×ª×–×›×•×¨×ª ×œ×›×•×œ×
    </button>`;
    tlc.innerHTML = tlh;
  } else {
    tlc.innerHTML = '';
  }

  // Weekly profit forecast
  const wfEl = document.getElementById('weeklyForecast');
  const weekStart = getWeekStart(new Date());
  const weekDates = [];
  for(let i=0;i<7;i++) {
    const wd = new Date(weekStart);
    wd.setDate(wd.getDate()+i);
    weekDates.push(dateStr(wd));
  }
  const weekLessons = lessons.filter(l =>
    weekDates.includes(l.date) && l.status !== 'cancelled' && l.status !== 'no-show'
  );
  const weekLessonCount = weekLessons.length;
  const weekExpected = weekLessons.reduce((sum, l) => {
    if (l.priceAtTime !== undefined && l.priceAtTime !== null) return sum + l.priceAtTime;
    const st = students.find(x => x.id === l.studentId);
    return sum + (st?.price || 0);
  }, 0);
  const weekCompleted = weekLessons.filter(l => l.status === 'completed').length;

  if(weekLessonCount > 0) {
    wfEl.innerHTML = `
      <div class="section-title">ğŸ“ˆ ×¦×¤×™ ×©×‘×•×¢×™</div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <span style="font-size:13px;color:var(--text-dim);">×©×™×¢×•×¨×™× ×”×©×‘×•×¢</span>
          <span style="font-family:'Rubik',sans-serif;font-size:20px;font-weight:700;color:var(--blue);">${weekLessonCount}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <span style="font-size:13px;color:var(--text-dim);">×‘×•×¦×¢×•</span>
          <span style="font-family:'Rubik',sans-serif;font-size:16px;font-weight:600;color:var(--accent);">${weekCompleted}/${weekLessonCount}</span>
        </div>
        <div style="background:var(--surface);border-radius:8px;height:6px;overflow:hidden;margin-bottom:12px;">
          <div style="background:var(--accent);height:100%;width:${weekLessonCount>0?Math.round(weekCompleted/weekLessonCount*100):0}%;border-radius:8px;transition:width 0.3s;"></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:14px;font-weight:600;">×¦×¤×™ ×¨×•×•×— ×©×‘×•×¢×™</span>
          <span style="font-family:'Rubik',sans-serif;font-size:24px;font-weight:700;color:var(--accent);">${fmtMoney(weekExpected)} â‚ª</span>
        </div>
      </div>
    `;
  } else {
    wfEl.innerHTML = '';
  }

  // Debt alerts on dashboard
  const debtStudents = students.filter(s=>getStudentBalance(s)<-300).sort((a,b)=>getStudentBalance(a)-getStudentBalance(b)).slice(0,3);
  const da = document.getElementById('debtAlerts');
  if(debtStudents.length>0) {
    let dh = '<div class="section-title" style="margin-top:0;">âš ï¸ ×—×•×‘×•×ª ×©×“×•×¨×©×™× ×˜×™×¤×•×œ</div>';
    debtStudents.forEach(s => {
      const debt=Math.abs(getStudentBalance(s));
      const completedCount = getCompletedLessonsCount(s);
      dh += `<div class="debt-student" onclick="openStudentDetail('${s.id}')"><div class="student-avatar" style="width:34px;height:34px;font-size:12px;background:linear-gradient(135deg,var(--warning),#d97706);">${escHtml(getInitials(s.name))}</div><div class="debt-info"><div class="debt-name">${escHtml(s.name)}</div><div class="debt-detail">${completedCount} ×©×™×¢×•×¨×™× ×œ×œ× ×ª×©×œ×•× ××œ×</div></div><div class="debt-amount" style="font-size:16px;">${fmtMoney(debt)} â‚ª</div></div>`;
    });
    da.innerHTML = dh;
  } else {
    da.innerHTML = '';
  }
}

function renderStudents() {
  const search = (document.getElementById('studentSearch')?.value||'').trim().toLowerCase();
  const filtered = students.filter(s=>!search||s.name.toLowerCase().includes(search)||s.phone.includes(search));
  const c = document.getElementById('studentsList');
  if(students.length===0){ c.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ‘¤</div><div class="empty-text">×¢×“×™×™×Ÿ ××™×Ÿ ×ª×œ××™×“×™×</div></div>'; return; }
  if(filtered.length===0){ c.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ”</div><div class="empty-text">×œ× × ××¦××• ×ª×•×¦××•×ª</div></div>'; return; }
  let h='';
  filtered.forEach(s => {
    const completedCount = getCompletedLessonsCount(s);
    const totalLessons = getTotalLessonsForStudent(s);
    const rem=Math.max(0,totalLessons-completedCount);
    const bal=getStudentBalance(s);
    const lessonBadge = rem<=5?'badge-green':'badge-yellow';
    const debtBadge = bal<0?`<span class="badge badge-red">×—×•×‘ ${fmtMoney(Math.abs(bal))} â‚ª</span>`:'';
    const extraBadge = s.wantsExtraLessons?`<span class="badge badge-blue">ğŸ”” ××—×¤×© ×©×¢×•×ª</span>`:'';
    h += `<div class="student-item" onclick="openStudentDetail('${s.id}')"><div class="student-avatar">${escHtml(getInitials(s.name))}</div><div class="student-info"><div class="student-name">${escHtml(s.name)}</div><div class="student-meta"><span>${completedCount}/${totalLessons}</span><span class="badge ${lessonBadge}">${rem===0?'××•×›×Ÿ!':'× ×•×ª×¨×• '+rem}</span>${debtBadge}${extraBadge}</div></div><div class="student-actions"><button class="icon-btn wa" onclick="event.stopPropagation();window.open('https://wa.me/${formatPhone(s.phone)}','_blank')" title="×•×•××˜×¡××¤">ğŸ’¬</button></div></div>`;
  });
  c.innerHTML=h;
}

// ---- EXPORT / IMPORT ----
function exportData() {
  const data = { students, lessons, payments, vehicleData, kmHistory, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `nahag-baseder-backup-${getRealTodayStr()}.json`;
  a.click();

  setTimeout(() => URL.revokeObjectURL(url), 1000);

  localStorage.setItem('drv_last_backup_attempt', new Date().toISOString());

  setTimeout(async () => {
    const ok = await customConfirm(
      '×”×× ×”×§×•×‘×¥ ×™×¨×“ ×•× ×©××¨ ×‘××›×©×™×¨?\n\n×˜×™×¤: ×‘××™×™×¤×•×Ÿ ×—×¤×© ×‘××¤×œ×™×§×¦×™×™×ª ×´×§×‘×¦×™××´ > ×´×”×•×¨×“×•×ª×´.',
      '××™×©×•×¨ ×’×™×‘×•×™',
      'ğŸ“¥'
    );
    if (ok) {
      localStorage.setItem('drv_last_backup', getRealTodayStr());
      showToast('âœ… ×’×™×‘×•×™ ××•×©×¨ ×•× ×©××¨');
    } else {
      showToast('âš ï¸ ×’×™×‘×•×™ ×œ× ××•×©×¨ - ××•××œ×¥ ×œ×•×•×“× ×©×”×§×•×‘×¥ × ×©××¨ ×•×œ× ×¡×•×ª ×©×•×‘');
    }
  }, 400);
}

async function checkBackupReminder() {
  const lastBackup = localStorage.getItem('drv_last_backup');
  const reminderShown = localStorage.getItem('drv_backup_reminder_shown');

  if (!lastBackup) {
    // First time user - only remind once, then mark as shown
    if (students.length > 0 && !reminderShown) {
      localStorage.setItem('drv_backup_reminder_shown', 'true');
      setTimeout(async () => {
        const backup = await customConfirm('×˜×¨× ×‘×™×¦×¢×ª ×’×™×‘×•×™ ×œ× ×ª×•× ×™× ×©×œ×š.\n\n××•××œ×¥ ×œ×’×‘×•×ª ××ª ×”× ×ª×•× ×™× ×‘××•×¤×Ÿ ×§×‘×•×¢.\n\n×œ×’×‘×•×ª ×¢×›×©×™×•?', '×ª×–×›×•×¨×ª ×’×™×‘×•×™', 'ğŸ’¾');
        if (backup) exportData();
      }, 2000);
    }
    return;
  }

  const lastDate = new Date(lastBackup);
  const now = new Date();
  const daysSinceBackup = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));

  if (daysSinceBackup >= 7) {
    setTimeout(async () => {
      const backup = await customConfirm(`×¢×‘×¨×• ${daysSinceBackup} ×™××™× ×××– ×”×’×™×‘×•×™ ×”××—×¨×•×Ÿ.\n\n××•××œ×¥ ×œ×’×‘×•×ª ××ª ×”× ×ª×•× ×™× ×‘××•×¤×Ÿ ×©×‘×•×¢×™.\n\n×œ×’×‘×•×ª ×¢×›×©×™×•?`, '×ª×–×›×•×¨×ª ×’×™×‘×•×™', 'ğŸ’¾');
      if (backup) exportData();
    }, 2000);
  }
}
function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async (ev) => {
      try {
        const rawData = JSON.parse(ev.target.result);
        if(!rawData.students || !rawData.lessons || !rawData.payments) {
          showToast('âš ï¸ ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ - ×—×¡×¨×™× ×©×“×•×ª × ×“×¨×©×™×');
          return;
        }

        // Validate and sanitize all imported data
        const validated = validateImportData(rawData);
        if (!validated) {
          showToast('âš ï¸ ×”× ×ª×•× ×™× ×‘×§×•×‘×¥ ×œ× ×ª×§×™× ×™×');
          return;
        }

        // Build confirmation message with skip info
        let confirmMsg = `×œ×™×™×‘× ${validated.students.length} ×ª×œ××™×“×™×, ${validated.lessons.length} ×©×™×¢×•×¨×™× ×•-${validated.payments.length} ×ª×©×œ×•××™×?`;
        const totalSkipped = validated.skipped.students + validated.skipped.lessons + validated.skipped.payments;
        if (totalSkipped > 0) {
          confirmMsg += `\n\nâš ï¸ ${totalSkipped} ×¨×©×•××•×ª ×œ× ×ª×§×™× ×•×ª ×™×“×•×œ×’×•:`;
          if (validated.skipped.students > 0) confirmMsg += `\n- ${validated.skipped.students} ×ª×œ××™×“×™×`;
          if (validated.skipped.lessons > 0) confirmMsg += `\n- ${validated.skipped.lessons} ×©×™×¢×•×¨×™×`;
          if (validated.skipped.payments > 0) confirmMsg += `\n- ${validated.skipped.payments} ×ª×©×œ×•××™×`;
        }
        confirmMsg += '\n\n×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ×™×•×—×œ×¤×•.';

        const importConfirmed = await customConfirm(confirmMsg, '×™×™×‘×•× ×’×™×‘×•×™', 'ğŸ“¥');
        if(!importConfirmed) return;

        students = validated.students;
        lessons = validated.lessons;
        payments = validated.payments;

        // IMPORTANT: Update vehicle data BEFORE saveData() so cloud sync includes them
        if (validated.vehicleData !== undefined) {
          vehicleData = validated.vehicleData; // can be null
        }
        if (validated.kmHistory !== undefined) {
          kmHistory = validated.kmHistory; // always an array
        }

        // Clear corrupted flag before save (import is the recovery path)
        const wasCorrupted = dataCorrupted;
        dataCorrupted = false;

        if(!saveData()) {
          dataCorrupted = wasCorrupted; // Restore flag if save failed
          showToast('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×');
          return;
        }

        // Remove corrupted banner if it exists
        const banner = document.getElementById('corruptedBanner');
        if (banner) {
          banner.remove();
          document.body.style.paddingTop = '';
        }

        // Also save vehicle data to localStorage (saveData doesn't do this)
        localStorage.setItem('drv_vehicle', JSON.stringify(vehicleData));
        localStorage.setItem('drv_km_history', JSON.stringify(kmHistory));

        showToast('âœ… × ×ª×•× ×™× ×™×•×‘××• ×‘×”×¦×œ×—×”');
        renderAll();
      } catch(err) {
        console.error('Import error:', err);
        showToast('âš ï¸ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// Close modals on Escape key or overlay click
document.addEventListener('keydown',e=>{
  if(e.key==='Escape') document.querySelectorAll('.modal-overlay.show').forEach(o=>o.classList.remove('show'));
});

// Close modal when clicking on overlay (outside the modal content)
document.addEventListener('click', e => {
  if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('show')) {
    e.target.classList.remove('show');
  }
});

// ============================================================
// VEHICLE MANAGEMENT
// ============================================================
let vehicleData;
try {
  vehicleData = JSON.parse(localStorage.getItem('drv_vehicle') || 'null');
} catch(e) {
  vehicleData = null;
}

let kmHistory;
try {
  kmHistory = JSON.parse(localStorage.getItem('drv_km_history') || '[]');
} catch(e) {
  kmHistory = [];
}

function saveVehicleData() {
  // Block saves when data is corrupted
  if (dataCorrupted) {
    showToast('âŒ ××¦×‘ ×§×¨×™××” ×‘×œ×‘×“ - ×œ× × ×™×ª×Ÿ ×œ×©××•×¨');
    return false;
  }
  try {
    // Save to localStorage as cache
    localStorage.setItem('drv_vehicle', JSON.stringify(vehicleData));
    localStorage.setItem('drv_km_history', JSON.stringify(kmHistory));
    localStorage.setItem('drv_last_save', new Date().toISOString());

    // Backup to IndexedDB (async, non-blocking)
    saveToIndexedDB();

    // Sync to Firestore (source of truth) - async, non-blocking
    if (isOnline && firebaseUserId) {
      syncToCloud();
    } else {
      hasPendingLocalChanges = true;
    }

    return true;
  } catch(e) {
    showToast('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”');
    return false;
  }
}

function openVehicleEditModal() {
  if (vehicleData) {
    document.getElementById('vehiclePlate').value = vehicleData.plate || '';
    document.getElementById('vehicleMake').value = vehicleData.make || '';
    document.getElementById('vehicleModel').value = vehicleData.model || '';
    document.getElementById('vehicleYear').value = vehicleData.year || '';
    document.getElementById('vehicleTransmission').value = vehicleData.transmission || '××•×˜×•××˜';
    document.getElementById('vehicleColor').value = vehicleData.color || '';
    document.getElementById('vehicleTestDate').value = vehicleData.testDate || '';
    document.getElementById('vehicleInsuranceDate').value = vehicleData.insuranceDate || '';
    document.getElementById('vehicleFullInsuranceDate').value = vehicleData.fullInsuranceDate || '';
    document.getElementById('vehicleServiceDate').value = vehicleData.serviceDate || '';
  } else {
    document.getElementById('vehiclePlate').value = '';
    document.getElementById('vehicleMake').value = '';
    document.getElementById('vehicleModel').value = '';
    document.getElementById('vehicleYear').value = '';
    document.getElementById('vehicleTransmission').value = '××•×˜×•××˜';
    document.getElementById('vehicleColor').value = '';
    document.getElementById('vehicleTestDate').value = '';
    document.getElementById('vehicleInsuranceDate').value = '';
    document.getElementById('vehicleFullInsuranceDate').value = '';
    document.getElementById('vehicleServiceDate').value = '';
  }
  document.getElementById('modalVehicleEdit').classList.add('show');
}

function saveVehicle() {
  const plateRaw = document.getElementById('vehiclePlate').value.trim();
  if (!plateRaw) {
    showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¨×›×‘');
    return;
  }

  const transmissionRaw = document.getElementById('vehicleTransmission').value;
  const transmission = (transmissionRaw === '×™×“× ×™') ? '×™×“× ×™' : '××•×˜×•××˜';

  const fixDate = (d) => (isValidDateStr(d) ? d : '');

  vehicleData = {
    plate: sanitizeString(plateRaw, 20),
    make: sanitizeString(document.getElementById('vehicleMake').value.trim(), 50),
    model: sanitizeString(document.getElementById('vehicleModel').value.trim(), 50),
    year: sanitizeString(document.getElementById('vehicleYear').value.trim(), 10),
    transmission: transmission,
    color: sanitizeString(document.getElementById('vehicleColor').value.trim(), 30),
    testDate: fixDate(document.getElementById('vehicleTestDate').value),
    insuranceDate: fixDate(document.getElementById('vehicleInsuranceDate').value),
    fullInsuranceDate: fixDate(document.getElementById('vehicleFullInsuranceDate').value),
    serviceDate: fixDate(document.getElementById('vehicleServiceDate').value)
  };

  if (!saveVehicleData()) return;
  closeModal('modalVehicleEdit');
  renderVehiclePage();
  showToast('âœ… ×¤×¨×˜×™ ×”×¨×›×‘ × ×©××¨×•');
}

function openKmUpdateModal() {
  document.getElementById('newKmValue').value = '';
  document.getElementById('kmUpdateDate').value = getRealTodayStr();
  document.getElementById('modalKmUpdate').classList.add('show');
}

function saveKmUpdate() {
  const km = parseInt(document.getElementById('newKmValue').value);
  const date = document.getElementById('kmUpdateDate').value;

  if (!km || km <= 0) {
    showToast('âŒ ×™×© ×œ×”×–×™×Ÿ ×§×™×œ×•××˜×¨××–\' ×ª×§×™×Ÿ');
    return;
  }

  if (!date) {
    showToast('âŒ ×™×© ×œ×‘×—×•×¨ ×ª××¨×™×š');
    return;
  }

  // Validate KM is not lower than previous
  if (kmHistory.length > 0 && km < kmHistory[0].km) {
    showToast('âŒ ×§×™×œ×•××˜×¨××–\' ×œ× ×™×›×•×œ ×œ×”×™×•×ª × ××•×š ××”×¢×¨×š ×”×§×•×“× (' + kmHistory[0].km.toLocaleString() + ')');
    return;
  }

  // Add to history
  kmHistory.unshift({
    km: km,
    date: date,
    timestamp: Date.now()
  });

  // Keep only last 20 entries
  if (kmHistory.length > 20) {
    kmHistory = kmHistory.slice(0, 20);
  }

  if (!saveVehicleData()) return;
  closeModal('modalKmUpdate');
  renderVehiclePage();
  showToast('âœ… ×”×§×™×œ×•××˜×¨××–\' ×¢×•×“×›×Ÿ');
}

function renderVehiclePage() {
  const infoEl = document.getElementById('vehicleInfo');
  const remindersEl = document.getElementById('vehicleReminders');
  const currentKmEl = document.getElementById('currentKm');
  const kmHistoryEl = document.getElementById('kmHistory');

  // Vehicle Info
  if (!vehicleData) {
    infoEl.innerHTML = `
      <div class="empty-state" style="padding:30px;">
        <div style="font-size:40px;margin-bottom:10px;">ğŸš—</div>
        <div style="color:var(--text-dim);">×œ× ×”×•×’×“×¨ ×¨×›×‘ ×¢×“×™×™×Ÿ</div>
        <button class="btn btn-primary btn-sm" style="margin-top:14px;" onclick="openVehicleEditModal()">â• ×”×•×¡×£ ×¨×›×‘</button>
      </div>`;
    remindersEl.innerHTML = '<div style="color:var(--text-dim);font-size:13px;text-align:center;padding:20px;">×”×’×“×¨ ×¨×›×‘ ×›×“×™ ×œ×¨××•×ª ×ª×–×›×•×¨×•×ª</div>';
    currentKmEl.textContent = 'â€”';
    kmHistoryEl.innerHTML = '';
    return;
  }

  // Has vehicle data
  const vehicleName = [vehicleData.make, vehicleData.model].filter(Boolean).join(' ') || '×”×¨×›×‘ ×©×œ×™';
  infoEl.innerHTML = `
    <div class="vehicle-header">
      <div class="vehicle-title-row">
        <div class="vehicle-icon">ğŸš—</div>
        <div class="vehicle-main-info">
          <h3>${escHtml(vehicleName)}</h3>
          <div class="vehicle-plate">${escHtml(vehicleData.plate)}</div>
        </div>
      </div>
      <button class="icon-btn" onclick="openVehicleEditModal()" title="×¢×¨×™×›×”">âœï¸</button>
    </div>
    <div class="vehicle-details-grid">
      ${vehicleData.year ? `<div class="vehicle-detail-item"><span class="vehicle-detail-label">×©× ×ª ×™×™×¦×•×¨</span><span class="vehicle-detail-value">${escHtml(String(vehicleData.year))}</span></div>` : ''}
      ${vehicleData.transmission ? `<div class="vehicle-detail-item"><span class="vehicle-detail-label">×¡×•×’ ×ª×™×‘×”</span><span class="vehicle-detail-value">${escHtml(String(vehicleData.transmission))}</span></div>` : ''}
      ${vehicleData.color ? `<div class="vehicle-detail-item"><span class="vehicle-detail-label">×¦×‘×¢</span><span class="vehicle-detail-value">${escHtml(String(vehicleData.color))}</span></div>` : ''}
    </div>`;

  // Reminders
  const reminders = [];
  const today = new Date();
  today.setHours(0,0,0,0);

  const reminderTypes = [
    { key: 'testDate', label: '×˜×¡×˜ ×©× ×ª×™', icon: 'ğŸ”§' },
    { key: 'insuranceDate', label: '×‘×™×˜×•×— ×—×•×‘×”', icon: 'ğŸ“‹' },
    { key: 'fullInsuranceDate', label: '×‘×™×˜×•×— ××§×™×£', icon: 'ğŸ›¡ï¸' },
    { key: 'serviceDate', label: '×˜×™×¤×•×œ ×”×‘×', icon: 'âš™ï¸' }
  ];

  reminderTypes.forEach(type => {
    if (vehicleData[type.key]) {
      const dueDate = new Date(vehicleData[type.key] + 'T00:00:00');
      const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
      reminders.push({
        ...type,
        date: vehicleData[type.key],
        daysUntil: daysUntil
      });
    }
  });

  if (reminders.length === 0) {
    remindersEl.innerHTML = '<div style="color:var(--text-dim);font-size:13px;text-align:center;padding:20px;">×œ× ×”×•×’×“×¨×• ×ª×–×›×•×¨×•×ª</div>';
  } else {
    remindersEl.innerHTML = reminders.map(r => {
      let statusClass = 'ok';
      let daysText = '';

      if (r.daysUntil < 0) {
        statusClass = 'danger';
        daysText = `×¢×‘×¨ ×œ×¤× ×™ ${Math.abs(r.daysUntil)} ×™××™×`;
      } else if (r.daysUntil === 0) {
        statusClass = 'danger';
        daysText = '×”×™×•×!';
      } else if (r.daysUntil <= 14) {
        statusClass = 'warning';
        daysText = `×‘×¢×•×“ ${r.daysUntil} ×™××™×`;
      } else {
        daysText = `×‘×¢×•×“ ${r.daysUntil} ×™××™×`;
      }

      const dateFormatted = new Date(r.date + 'T00:00:00').toLocaleDateString('he-IL');

      return `
        <div class="reminder-item ${statusClass}">
          <div class="reminder-icon">${r.icon}</div>
          <div class="reminder-content">
            <div class="reminder-title">${r.label}</div>
            <div class="reminder-date">${dateFormatted}</div>
          </div>
          <div class="reminder-days">${daysText}</div>
        </div>`;
    }).join('');
  }

  // KM Display
  if (kmHistory.length > 0) {
    const latestKm = kmHistory[0].km;
    currentKmEl.textContent = latestKm.toLocaleString() + ' ×§"×';

    // KM History
    kmHistoryEl.innerHTML = `
      <div class="section-title" style="margin-top:8px;font-size:12px;">×”×™×¡×˜×•×¨×™×”</div>
      <div class="km-history-list">
        ${kmHistory.slice(0, 5).map((entry, i) => {
          const dateFormatted = new Date(entry.date + 'T00:00:00').toLocaleDateString('he-IL');
          let diffText = '';
          if (i < kmHistory.length - 1) {
            const diff = entry.km - kmHistory[i + 1].km;
            if (diff > 0) diffText = `+${diff.toLocaleString()}`;
          }
          return `
            <div class="km-history-item">
              <span class="km-history-date">${dateFormatted}</span>
              <span class="km-history-value">${entry.km.toLocaleString()} ×§"× ${diffText ? `<span class="km-history-diff">(${diffText})</span>` : ''}</span>
            </div>`;
        }).join('')}
      </div>`;
  } else {
    currentKmEl.textContent = 'â€”';
    kmHistoryEl.innerHTML = '';
  }
}

function checkVehicleReminders() {
  if (!vehicleData) return;

  const today = new Date();
  today.setHours(0,0,0,0);

  const reminderTypes = [
    { key: 'testDate', label: '×˜×¡×˜ ×©× ×ª×™' },
    { key: 'insuranceDate', label: '×‘×™×˜×•×— ×—×•×‘×”' },
    { key: 'fullInsuranceDate', label: '×‘×™×˜×•×— ××§×™×£' },
    { key: 'serviceDate', label: '×˜×™×¤×•×œ ×”×‘×' }
  ];

  const warnings = [];

  reminderTypes.forEach(type => {
    if (vehicleData[type.key]) {
      const dueDate = new Date(vehicleData[type.key] + 'T00:00:00');
      const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

      if (daysUntil <= 14 && daysUntil >= 0) {
        warnings.push(`${type.label} ×‘×¢×•×“ ${daysUntil} ×™××™×`);
      } else if (daysUntil < 0) {
        warnings.push(`${type.label} ×¢×‘×¨!`);
      }
    }
  });

  if (warnings.length > 0) {
    setTimeout(() => {
      showToast('ğŸš— ×ª×–×›×•×¨×•×ª ×¨×›×‘: ' + warnings[0]);
    }, 2000);
  }
}

// INIT
if (checkLicense()) {
  renderAll();
  checkBackupReminder();
  checkVehicleReminders();
}

// ============================================================
// SERVICE WORKER REGISTRATION (PWA)
// ============================================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => {
        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', async () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New version available
              const shouldUpdate = await customConfirm('×’×¨×¡×” ×—×“×©×” ×–××™× ×”!\n\n×œ×¨×¢× ×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”?', '×¢×“×›×•×Ÿ ×–××™×Ÿ', 'ğŸ”„');
              if (shouldUpdate) {
                newWorker.postMessage('skipWaiting');
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(() => {
        // Service worker registration failed silently
      });
  });
}

// Handle app install prompt (Android)
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // Show install button in header if not already installed
  const installBtn = document.createElement('button');
  installBtn.id = 'pwaInstallBtn';
  installBtn.className = 'btn btn-sm btn-outline';
  installBtn.style.cssText = 'position:fixed;bottom:70px;left:10px;z-index:999;font-size:11px;padding:6px 10px;';
  installBtn.innerHTML = 'ğŸ“² ×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×”';
  installBtn.onclick = async () => {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      installBtn.remove();
    }
    deferredPrompt = null;
  };
  document.body.appendChild(installBtn);
});

// Hide install button if already installed
window.addEventListener('appinstalled', () => {
  const installBtn = document.getElementById('pwaInstallBtn');
  if (installBtn) installBtn.remove();
});
</script>
</body>
</html>
